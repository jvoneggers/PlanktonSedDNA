



V9
```{r}
nmds <- ps_V9_norm %>% subset_taxa(.,Family %in% c("Branchiopoda", "Maxillopoda")) %>% tax_glom(., taxrank = "Genus") %>% ordinate(., method = "NMDS", distance="bray")
#nmds <- ps_V9_norm %>% subset_taxa(.,Family %in% c("Branchiopoda", "Maxillopoda")) %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)


lake_colors <- c("Canyon" = "#b9ceac", "Eyrie" = "darkolivegreen3", "Lightning" = "darkolivegreen", 
                 "Black Rock" = "#FFBBFF", "Footprint" = "#CD96CD", "Lost" = "#9696CD", 
                 "Scott" = "#5D478B", "Bullfrog" = "#1E90FF", "Middle Gaylor" = "#8EE5EE", 
                 "Soldier" = "#4682B4", "Skelton" = "#5F9EA0", "Crescent" = "#EE6363", 
                 "Louise" = "#FFA07A", "Monogram" = "#EE30A7")
                 

nmds_meta<-nmds_meta %>%
        arrange(state,mountain_range, fish, lake_name,bottom_cm) %>%
        group_by(lake_name)%>%
        mutate(fish_present_sample = ifelse(first_stocked_yr>=date_mid_AD_combo | is.na(first_stocked_yr) ==T, "fishless","fish"))  %>%  
        mutate(fish_present_sample = if_else(!is.na(fish_disappear_or_eradicated) & fish_disappear_or_eradicated <= date_mid_AD_combo, "fishless", fish_present_sample)) %>% ungroup()


nmds_meta <- nmds_meta %>%
  mutate(lake_color = lake_colors[lake_name], 
        fish_col = if_else(fish_present_sample == "fish", "black", lake_color))

legend_cols<-unique(nmds_meta[,names(nmds_meta)%in%c("lake_name","lake_color")])


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

# plot
#png("3_Figures/FigX_NMDS_zooplankton_V9_ESV.png", height= 7, width=13, units = "in", res = 400)
png("3_Figures/FigX_NMDS_zooplankton_V9_genus.png", height= 7, width=13, units = "in", res = 400)
par(mar=c(4,4,1,10),xpd=TRUE)
plot(nmds_meta$MDS1, nmds_meta$MDS2,pch =21, bg=nmds_meta$lake_color,col=nmds_meta$fish_col,ylab="",xlab="", cex=nmds_meta$scaled_depth)

legend("topright", legend = legend_cols$lake_name, col = legend_cols$lake_color, pch = 21, pt.bg = legend_cols$lake_color, title = "Lake", bty = "n", pt.cex=2,cex = 1.1, inset = c(-0.18, 0))
# 
legend("topright", legend = c("Fish present","Fishless"), col = c("black","white"), pch = 21, pt.bg =   "#FDBF6F", title = "", bty = "n", pt.cex=2,cex = 1.1, inset = c(-.19, 0.6))
 title(xlab="NMDS1", line = 2.5, cex.lab=1.2)
 title(ylab="NMDS2", line = 2.5, cex.lab=1.2)
dev.off()

```

V7
```{r}
nmds <- ps_V7_norm %>% subset_taxa(.,Family %in% c("Branchiopoda", "Maxillopoda")) %>% tax_glom(., taxrank = "Genus") %>% ordinate(., method = "NMDS", distance="bray")
#nmds <- ps_V9_norm %>% subset_taxa(.,Family %in% c("Branchiopoda", "Maxillopoda")) %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)


lake_colors <- c("Canyon" = "#b9ceac", "Eyrie" = "darkolivegreen3", "Lightning" = "darkolivegreen", 
                 "Black Rock" = "#FFBBFF", "Footprint" = "#CD96CD", "Lost" = "#9696CD", 
                 "Scott" = "#5D478B", "Bullfrog" = "#1E90FF", "Middle Gaylor" = "#8EE5EE", 
                 "Soldier" = "#4682B4", "Skelton" = "#5F9EA0", "Crescent" = "#EE6363", 
                 "Louise" = "#FFA07A", "Monogram" = "#EE30A7")
                 

nmds_meta<-nmds_meta %>%
        arrange(state,mountain_range, fish, lake_name,bottom_cm) %>%
        group_by(lake_name)%>%
        mutate(fish_present_sample = ifelse(first_stocked_yr>=date_mid_AD_combo | is.na(first_stocked_yr) ==T, "fishless","fish"))  %>%  
        mutate(fish_present_sample = if_else(!is.na(fish_disappear_or_eradicated) & fish_disappear_or_eradicated <= date_mid_AD_combo, "fishless", fish_present_sample)) %>% ungroup()


nmds_meta <- nmds_meta %>%
  mutate(lake_color = lake_colors[lake_name], 
        fish_col = if_else(fish_present_sample == "fish", "black", lake_color))

legend_cols<-unique(nmds_meta[,names(nmds_meta)%in%c("lake_name","lake_color")])


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

# plot
#png("3_Figures/FigX_NMDS_zooplankton_V7_ESV.png", height= 7, width=13, units = "in", res = 400)
png("3_Figures/FigX_NMDS_zooplankton_V7_genus.png", height= 7, width=13, units = "in", res = 400)
par(mar=c(4,4,1,10),xpd=TRUE)
plot(nmds_meta$MDS1, nmds_meta$MDS2,pch =21, bg=nmds_meta$lake_color,col=nmds_meta$fish_col,ylab="",xlab="", cex=nmds_meta$scaled_depth)

legend("topright", legend = legend_cols$lake_name, col = legend_cols$lake_color, pch = 21, pt.bg = legend_cols$lake_color, title = "Lake", bty = "n", pt.cex=2,cex = 1.1, inset = c(-0.18, 0))
# 
legend("topright", legend = c("Fish present","Fishless"), col = c("black","white"), pch = 21, pt.bg =   "#FDBF6F", title = "", bty = "n", pt.cex=2,cex = 1.1, inset = c(-.19, 0.6))
 title(xlab="NMDS1", line = 2.5, cex.lab=1.2)
 title(ylab="NMDS2", line = 2.5, cex.lab=1.2)
dev.off()

```

V7
```{r}
#nmds <- ps_V7_norm %>% subset_taxa(.,Family %in% c("Branchiopoda", "Maxillopoda")) %>% ordinate(., method = "NMDS", distance="bray")
nmds <- ps_V7_norm %>% subset_taxa(.,Family %in% c("Branchiopoda", "Maxillopoda")) %>% tax_glom(., taxrank = "Genus") %>% ordinate(., method = "NMDS", distance="bray")


nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)


# lake_colors <- c(
#   "Canyon" = "gray88", 
#   "Eyrie" = "gray88", 
#   "Lightning" = "gray88", 
#   "Black Rock" = "#FFBBFF", 
#   "Footprint" = "#CD96CD", 
#   "Lost" = "#9696CD", 
#   "Scott" = "#5D478B", 
#   "Bullfrog" = "#1E90FF", 
#   "Middle Gaylor" = "#8EE5EE", 
#   "Soldier" = "gray88", 
#   "Skelton" = "gray88", 
#   "Crescent" = "gray88", 
#   "Louise" = "#FFA07A", 
#   "Monogram" = "#EE30A7"
# )



lake_colors <- c("Canyon" = "#b9ceac", "Eyrie" = "darkolivegreen3", "Lightning" = "darkolivegreen",
                 "Black Rock" = "gray88", "Footprint" = "gray88", "Lost" = "gray88",
                 "Scott" = "gray88", "Bullfrog" = "gray88", "Middle Gaylor" = "gray88",
                 "Soldier" = "#4682B4", "Skelton" = "#5F9EA0", "Crescent" = "#EE6363",
                 "Louise" = "gray88", "Monogram" = "gray88")


nmds_meta<-nmds_meta %>%
        arrange(state,mountain_range, fish, lake_name,bottom_cm) %>%
        group_by(lake_name)%>%
        mutate(fish_present_sample = ifelse(first_stocked_yr>=date_mid_AD_combo | is.na(first_stocked_yr) ==T, "fishless","fish"))  %>%  
        mutate(fish_present_sample = if_else(!is.na(fish_disappear_or_eradicated) & fish_disappear_or_eradicated <= date_mid_AD_combo, "fishless", fish_present_sample)) %>% ungroup()

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)



ggplot() +
  geom_point(data = nmds_meta %>% filter(fish == 1), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color=lake_name), 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish == 0), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  


# Save the plot to a file
ggsave("3_Figures/FigX_NMDS_zooplankton_V7_genus_fishless.png", width = 7, height = 5, dpi = 400)
```

```{r}
nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)


lake_colors <- c(
  "Canyon" = "gray88",
  "Eyrie" = "gray88",
  "Lightning" = "gray88",
  "Black Rock" = "#FFBBFF",
  "Footprint" = "#CD96CD",
  "Lost" = "#9696CD",
  "Scott" = "#5D478B",
  "Bullfrog" = "#1E90FF",
  "Middle Gaylor" = "#8EE5EE",
  "Soldier" = "gray88",
  "Skelton" = "gray88",
  "Crescent" = "gray88",
  "Louise" = "#FFA07A",
  "Monogram" = "#EE30A7"
)

nmds_meta<-nmds_meta %>%
        arrange(state,mountain_range, fish, lake_name,bottom_cm) %>%
        group_by(lake_name)%>%
        mutate(fish_present_sample = ifelse(first_stocked_yr>=date_mid_AD_combo | is.na(first_stocked_yr) ==T, "fishless","fish"))  %>%  
        mutate(fish_present_sample = if_else(!is.na(fish_disappear_or_eradicated) & fish_disappear_or_eradicated <= date_mid_AD_combo, "fishless", fish_present_sample)) %>% ungroup()

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)



ggplot() +
  geom_point(data = nmds_meta %>% filter(fish == 0), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color=lake_name), 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish == 1), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_zooplankton_V7_genus_fish.png", width = 7, height = 5, dpi = 400)

```





V7
```{r}
#nmds <- ps_V7_norm %>% subset_taxa(.,!Family %in% c("Branchiopoda", "Maxillopoda")) %>% tax_glom(., taxrank = "Genus") %>% ordinate(., method = "NMDS", distance="bray")
nmds <- ps_V9_norm %>% subset_taxa(.,!Family %in% c("Branchiopoda", "Maxillopoda")) %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)


lake_colors <- c("Canyon" = "#b9ceac", "Eyrie" = "darkolivegreen3", "Lightning" = "darkolivegreen", 
                 "Black Rock" = "#FFBBFF", "Footprint" = "#CD96CD", "Lost" = "#9696CD", 
                 "Scott" = "#5D478B", "Bullfrog" = "#1E90FF", "Middle Gaylor" = "#8EE5EE", 
                 "Soldier" = "#4682B4", "Skelton" = "#5F9EA0", "Crescent" = "#EE6363", 
                 "Louise" = "#FFA07A", "Monogram" = "#EE30A7")
                 

nmds_meta<-nmds_meta %>%
        arrange(state,mountain_range, fish, lake_name,bottom_cm) %>%
        group_by(lake_name)%>%
        mutate(fish_present_sample = ifelse(first_stocked_yr>=date_mid_AD_combo | is.na(first_stocked_yr) ==T, "fishless","fish"))  %>%  
        mutate(fish_present_sample = if_else(!is.na(fish_disappear_or_eradicated) & fish_disappear_or_eradicated <= date_mid_AD_combo, "fishless", fish_present_sample)) %>% ungroup()


nmds_meta <- nmds_meta %>%
  mutate(lake_color = lake_colors[lake_name], 
        fish_col = if_else(fish_present_sample == "fish", "black", lake_color))

legend_cols<-unique(nmds_meta[,names(nmds_meta)%in%c("lake_name","lake_color")])


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

# plot
png("3_Figures/FigX_NMDS_phytoplankton_V7_ESV.png", height= 7, width=13, units = "in", res = 400)
#png("3_Figures/FigX_NMDS_phytoplankton_V7_genus.png", height= 7, width=13, units = "in", res = 400)
par(mar=c(4,4,1,10),xpd=TRUE)
plot(nmds_meta$MDS1, nmds_meta$MDS2,pch =21, bg=nmds_meta$lake_color,col=nmds_meta$fish_col,ylab="",xlab="", cex=nmds_meta$scaled_depth)

legend("topright", legend = legend_cols$lake_name, col = legend_cols$lake_color, pch = 21, pt.bg = legend_cols$lake_color, title = "Lake", bty = "n", pt.cex=2,cex = 1.1, inset = c(-0.18, 0))
# 
legend("topright", legend = c("Fish present","Fishless"), col = c("black","white"), pch = 21, pt.bg =   "#FDBF6F", title = "", bty = "n", pt.cex=2,cex = 1.1, inset = c(-.19, 0.6))
 title(xlab="NMDS1", line = 2.5, cex.lab=1.2)
 title(ylab="NMDS2", line = 2.5, cex.lab=1.2)
dev.off()
```

V9
```{r}
#nmds <- ps_V9_norm %>% subset_taxa(.,!Family %in% c("Branchiopoda", "Maxillopoda")) %>% tax_glom(., taxrank = "Genus") %>% ordinate(., method = "NMDS", distance="bray")
nmds <- ps_V9_norm %>% subset_taxa(.,!Family %in% c("Branchiopoda", "Maxillopoda")) %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)


lake_colors <- c("Canyon" = "#b9ceac", "Eyrie" = "darkolivegreen3", "Lightning" = "darkolivegreen", 
                 "Black Rock" = "#FFBBFF", "Footprint" = "#CD96CD", "Lost" = "#9696CD", 
                 "Scott" = "#5D478B", "Bullfrog" = "#1E90FF", "Middle Gaylor" = "#8EE5EE", 
                 "Soldier" = "#4682B4", "Skelton" = "#5F9EA0", "Crescent" = "#EE6363", 
                 "Louise" = "#FFA07A", "Monogram" = "#EE30A7")
                 

nmds_meta<-nmds_meta %>%
        arrange(state,mountain_range, fish, lake_name,bottom_cm) %>%
        group_by(lake_name)%>%
        mutate(fish_present_sample = ifelse(first_stocked_yr>=date_mid_AD_combo | is.na(first_stocked_yr) ==T, "fishless","fish"))  %>%  
        mutate(fish_present_sample = if_else(!is.na(fish_disappear_or_eradicated) & fish_disappear_or_eradicated <= date_mid_AD_combo, "fishless", fish_present_sample)) %>% ungroup()


nmds_meta <- nmds_meta %>%
  mutate(lake_color = lake_colors[lake_name], 
        fish_col = if_else(fish_present_sample == "fish", "black", lake_color))

legend_cols<-unique(nmds_meta[,names(nmds_meta)%in%c("lake_name","lake_color")])


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

# plot
png("3_Figures/FigX_NMDS_phytoplankton_V9_ESV.png", height= 7, width=13, units = "in", res = 400)
#png("3_Figures/FigX_NMDS_phytoplankton_V9_genus.png", height= 7, width=13, units = "in", res = 400)
par(mar=c(4,4,1,10),xpd=TRUE)
plot(nmds_meta$MDS1, nmds_meta$MDS2,pch =21, bg=nmds_meta$lake_color,col=nmds_meta$fish_col,ylab="",xlab="", cex=nmds_meta$scaled_depth)

legend("topright", legend = legend_cols$lake_name, col = legend_cols$lake_color, pch = 21, pt.bg = legend_cols$lake_color, title = "Lake", bty = "n", pt.cex=2,cex = 1.1, inset = c(-0.18, 0))
# 
legend("topright", legend = c("Fish present","Fishless"), col = c("black","white"), pch = 21, pt.bg =   "#FDBF6F", title = "", bty = "n", pt.cex=2,cex = 1.1, inset = c(-.19, 0.6))
 title(xlab="NMDS1", line = 2.5, cex.lab=1.2)
 title(ylab="NMDS2", line = 2.5, cex.lab=1.2)
dev.off()
```






paste0("2_DataAnalysis/BLAST_zooplankton/",Sys.Date(),"_V7_ZOTU_Maxillopoda_Branchiopoda_all_lakes.fasta"),
```{r}
seqs<-Biostrings::readDNAStringSet(paste0("2_DataAnalysis/BLAST_zooplankton/",Sys.Date(),"_V7_ZOTU_Maxillopoda_Branchiopoda_all_lakes.fasta"))
```


```{bash}
salloc --mem=100GB --nodes=1 --cpus-per-task=32 --account=sedDNA --time=2:00:00
module load  arcc/1.0  gcc/14.2.0
module load blast/2.16.0

blastn -query 2024-11-06_V7_ZOTU_Maxillopoda_Branchiopoda_all_lakes.fasta -db nt -out V7_not_remote_results.csv -qcov_hsp_perc 90 -perc_identity 94 -evalue 1e-50 -num_threads 32 -outfmt '10 qseqid qlen sseqid pident evalue bitscore qcovs length ssciname'



```

```{bash}
#!/bin/bash
#SBATCH --job-name blast_zoop
#SBATCH --mem=100GB
#SBATCH --time=2:00:00
#SBATCH --cpus-per-task=32
#SBATCH --account=sedDNA
#SBATCH --output=BLAST_zooplankton_not_remote_ZOTU_%A.out


module load miniconda3/23.11.0
conda activate vsearch

module load arcc/1.0 gcc/12.2.0
module load blast-plus/2.13.0

cd /gscratch/jvonegge/18S_Seq_Reanalysis_2024/blast/Max_Bra_all_lakes

echo "Date BLASTed NOT using the -remote option:"
date

# BLAST search 
blastn -query 2024-11-06_V7_ZOTU_Maxillopoda_Branchiopoda_all_lakes.fasta -db nt -out V7_not_remote_results.csv -qcov_hsp_perc 90 -perc_identity 94 -evalue 1e-50 -num_threads 32 -outfmt '10 qseqid qlen sseqid pident evalue bitscore qcovs length ssciname'

# add headers to the output file
echo "qseqid,qlen,sseqid,pident,evalue,bitscore,qcovs,length,ssciname" > headers.csv
cat headers.csv V7_not_remote_results.csv > 0_V7_ZOTU_blast_not_remote_results_all_lakes.csv
rm V7_not_remote_results.csv

# BLAST search 
blastn -query 2024-11-06_V9_ZOTU_Maxillopoda_Branchiopoda_all_lakes.fasta -db nt -out V9_not_remote_results.csv -qcov_hsp_perc 90 -perc_identity 94 -evalue 1e-50 -num_threads 32 -outfmt '10 qseqid qlen sseqid pident evalue bitscore qcovs length ssciname'

# add headers to the output file
cat headers.csv V9_not_remote_results.csv > 0_V9_ZOTU_blast_not_remote_results_all_lakes.csv

rm headers.csv; rm V9_not_remote_results.csv

```


### V7 BLAST
```{r}
zoop <- subset_taxa(ps_V7_norm, Family %in% c("Branchiopoda", "Maxillopoda"))
tax<-as.data.frame(tax_table(zoop))

blast_results<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/BLAST_zooplankton/0_V7_ZOTU_blast_not_remote_results_all_lakes.csv")

# remove the (Kuroda, 1948) becasue this is a CSV file and it looks for commas
blast_results <- blast_results %>% filter(qseqid!=" 1948)")

# remove the digits at the end of a scientific name (to help remove duplicates)
blast_results$ssciname <- gsub("\\s\\d+$", "",blast_results$ssciname)
# unique the data frame to remove duplicates
blast_uniq <- blast_results %>% select(!c(sseqid,qlen,pident,evalue,bitscore,qcovs,length)) %>% unique(.)

# dataframe of taxa that only have one blast assignment that matches the thresholds given.
qseqid_counts <- table(blast_uniq$qseqid)

# subset dataframe to get ESVs that have one blast 
blast_singles <- blast_uniq[blast_uniq$qseqid %in% names(qseqid_counts[qseqid_counts == 1]), ]
tax$qseqid<-rownames(tax)

tax_blast<-left_join(tax, blast_singles, by="qseqid")

# look at the ESVs with multiple blast results and decide:
blast_mult <- blast_results[blast_results$qseqid %in% names(qseqid_counts[qseqid_counts > 1]), ]
blast_mult <- blast_mult %>% select(!sseqid) %>% arrange(qseqid, desc(bitscore), desc(pident),desc(qcovs)) %>% unique(.)

# filter out taxa that I have already assigned in ch. 2
wy_zoop<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/ZooplanktonSedDNA/5_DataAnalysis/BLAST_zooplankton/Max_Bra/5_BLAST_V7_original_single_multiple.csv",row.names=1)

table(wy_zoop$qseqid %in% blast_mult$qseqid)
table(blast_mult$qseqid %in% wy_zoop$qseqid)
table(tax_blast$qseqid %in% wy_zoop$qseqid)
write.csv(blast_mult,"2_DataAnalysis/BLAST_zooplankton/1_BLAST_V7_multiple_hits.csv")

# read back in the file after selection
blast_selected<-read.csv("5_DataAnalysis/BLAST_zooplankton/Max_Bra/3_BLAST_V7_multiple_hits_selected.csv", header=T) %>% select(!c(qlen,pident,evalue,bitscore,qcovs,length))

# make sure that I made selections for each of the ESVs
table(blast_selected$qseqid %in%blast_mult$qseqid) # all should be TRUE

tax_blast<-left_join(tax_blast, blast_selected, by="qseqid")

for(i in 1:nrow(tax_blast)){
if(is.na(tax_blast$ssciname.x[i])==T){tax_blast$ssciname.x[i]<-tax_blast$ssciname.y[i]}}

tax_blast$ssciname.y<-NULL
names(tax_blast)[10]<-"scciname"
#write.csv(tax_blast, "5_DataAnalysis/BLAST_zooplankton/Max_Bra/4_BLAST_V7_original_single_multiple.csv")
```






OLD
```{r}
# select variables for modeling, add time sequence for each sediment core, switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(d15N_diff_from_start)==F) %>%
        select(Abundance,
               mean_air_temp_degC_anomaly_combined,
               d15N_diff_from_start,
               fish_present_binary,
               lake_name,
               subdivision, 
               mid_cm) %>%   
        arrange(lake_name,subdivision,desc(mid_cm)) %>% 
        group_by(lake_name) %>% mutate(time_seq=row_number()) %>% 
        ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

# no interactions
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_anomaly_combined"~"Mean annual air temperature\nanomaly (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"))%>% 
        filter(!term=="Intercept")

model_output$term <- factor(model_output$term, levels = c("Fish presence","d15N","Mean annual air temperature\nanomaly (deg C)")) 


LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression("-" * Delta*delta^15 * "N (nitrogen deposition)"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_phytoplankton_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)

```

OLD - With interactions
```{r}
# interaction fish and nitrogen
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary + d15N_diff_from_start*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# no interactions fish and nitrogen



# interaction fish and climate
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary +mean_air_temp_degC_anomaly_combined*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# yes interactions fish and climate


# interaction nitrogen and climate
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary +mean_air_temp_degC_anomaly_combined*d15N_diff_from_start,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# yes interactions nitrogen and climate


#interaction of nitrogen*climate and fish*nitrogen
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary +mean_air_temp_degC_anomaly_combined*d15N_diff_from_start + fish_present_binary*d15N_diff_from_start,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# When I do this only fish and nitrogen are significant




#  
# model_output<-model_output %>%
#         mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
#                                  p.value > 0.05 ~ "No")) %>% 
#         mutate(term = case_when(term=="(Intercept)"~"Intercept",
#                                 term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
#                                 term=="d15N_diff_from_start"~"d15N",
#                                 term=="fish_present_binary"~"Fish presence",
#                                 term=="d15N_diff_from_start:fish_present_binary"~"d15N x fish presence")) %>% filter(!term=="Intercept")
# 
# LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
#   geom_point(size = 4, shape = 21, stroke = 1.5) + 
#   custom_theme()+         
#   scale_fill_manual(values = taxa_colors) + 
#   scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
#   labs(x = "Estimate", 
#        y = "",
#        fill = "Taxonomic group",
#        color = expression(italic("P") <= 0.05)) +
#         theme(strip.background = element_blank())+
#         guides(fill = guide_legend(override.aes = list(color = NA)))+ 
#   scale_y_discrete(labels = function(term) {
#     ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
#         geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)
# 
# 
# write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_phytoplankton_model_output.csv")
# 
# sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```




PREVIOUS
```{r}
# select variables for modeling, add time sequence for each sediment core, switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(d15N_diff_from_start)==F) %>%
        select(Abundance,
               mean_air_temp_degC_anomaly_combined,
               d15N_diff_from_start,
               fish_present_binary,
               lake_name,
               subdivision, 
               mid_cm) %>%   
        arrange(lake_name,subdivision,desc(mid_cm)) %>% 
        group_by(lake_name) %>% mutate(time_seq=row_number()) %>% 
        ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

# no interactions
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_anomaly_combined"~"Mean annual air temperature\nanomaly (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"))%>% 
        filter(!term=="Intercept")

model_output$term <- factor(model_output$term, levels = c("Fish presence","d15N","Mean annual air temperature\nanomaly (deg C)")) 


LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression("-" * Delta*delta^15 * "N (nitrogen deposition)"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_heterotrophic_protists_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```



No interactions
```{r}
# interaction fish and nitrogen
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary + d15N_diff_from_start*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# no interactions fish and nitrogen



# interaction fish and climate
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary +mean_air_temp_degC_anomaly_combined*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# no interactions fish and climate


# interaction nitrogen and climate
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary +mean_air_temp_degC_anomaly_combined*d15N_diff_from_start,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# no interactions nitrogen and climate

#  
# model_output<-model_output %>%
#         mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
#                                  p.value > 0.05 ~ "No")) %>% 
#         mutate(term = case_when(term=="(Intercept)"~"Intercept",
#                                 term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
#                                 term=="d15N_diff_from_start"~"d15N",
#                                 term=="fish_present_binary"~"Fish presence",
#                                 term=="d15N_diff_from_start:fish_present_binary"~"d15N x fish presence")) %>% filter(!term=="Intercept")
# 
# LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
#   geom_point(size = 4, shape = 21, stroke = 1.5) + 
#   custom_theme()+         
#   scale_fill_manual(values = taxa_colors) + 
#   scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
#   labs(x = "Estimate", 
#        y = "",
#        fill = "Taxonomic group",
#        color = expression(italic("P") <= 0.05)) +
#         theme(strip.background = element_blank())+
#         guides(fill = guide_legend(override.aes = list(color = NA)))+ 
#   scale_y_discrete(labels = function(term) {
#     ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
#         geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)
# 
# 
# write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_heterotrophic_protists_model_output.csv")
# 
# sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```



PREVIOUS

```{r}
# select variables for modeling, add time sequence for each sediment core, switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(d15N_diff_from_start)==F) %>%
        select(Abundance,
               mean_air_temp_degC_anomaly_combined,
               d15N_diff_from_start,
               fish_present_binary,
               lake_name,
               taxonomic_group, 
               mid_cm) %>%   
        arrange(lake_name,taxonomic_group,desc(mid_cm)) %>% 
        group_by(lake_name) %>% mutate(time_seq=row_number()) %>% 
        ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

# no interactions
model_output<-as_tibble(NULL)
for(i in unique(lme_data$taxonomic_group)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(taxonomic_group == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_anomaly_combined"~"Mean annual air temperature\nanomaly (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"))%>% 
        filter(!term=="Intercept")

model_output$term <- factor(model_output$term, levels = c("Fish presence","d15N","Mean annual air temperature\nanomaly (deg C)")) 


LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression("-" * Delta*delta^15 * "N (nitrogen deposition)"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_zooplankton_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```

Interactions
```{r}
# interaction fish and nitrogen
model_output<-as_tibble(NULL)
for(i in unique(lme_data$taxonomic_group)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary + d15N_diff_from_start*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(taxonomic_group == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# yes interactions fish and nitrogen



# interaction fish and climate
model_output<-as_tibble(NULL)
for(i in unique(lme_data$taxonomic_group)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary +mean_air_temp_degC_anomaly_combined*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(taxonomic_group == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# no interactions fish and climate


# interaction nitrogen and climate
model_output<-as_tibble(NULL)
for(i in unique(lme_data$taxonomic_group)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary +mean_air_temp_degC_anomaly_combined*d15N_diff_from_start,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(taxonomic_group == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# yes interactions nitrogen and climate

#  
# model_output<-model_output %>%
#         mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
#                                  p.value > 0.05 ~ "No")) %>% 
#         mutate(term = case_when(term=="(Intercept)"~"Intercept",
#                                 term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
#                                 term=="d15N_diff_from_start"~"d15N",
#                                 term=="fish_present_binary"~"Fish presence",
#                                 term=="d15N_diff_from_start:fish_present_binary"~"d15N x fish presence")) %>% filter(!term=="Intercept")
# 
# LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
#   geom_point(size = 4, shape = 21, stroke = 1.5) + 
#   custom_theme()+         
#   scale_fill_manual(values = taxa_colors) + 
#   scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
#   labs(x = "Estimate", 
#        y = "",
#        fill = "Taxonomic group",
#        color = expression(italic("P") <= 0.05)) +
#         theme(strip.background = element_blank())+
#         guides(fill = guide_legend(override.aes = list(color = NA)))+ 
#   scale_y_discrete(labels = function(term) {
#     ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
#         geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)
# 
# 
# write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_zooplankton_model_output.csv")
# 
# sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```


PREVIOUS

```{r}
# select variables for modeling, add time sequence for each sediment core, switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(d15N_diff_from_start)==F) %>%
        select(Abundance,
               mean_air_temp_degC_anomaly_combined,
               d15N_diff_from_start,
               fish_present_binary,
               lake_name,
               taxonomic_group, 
               mid_cm) %>%   
        arrange(lake_name,taxonomic_group,desc(mid_cm)) %>% 
        group_by(lake_name) %>% mutate(time_seq=row_number()) %>% 
        ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

# no interactions
model_output<-as_tibble(NULL)
for(i in unique(lme_data$taxonomic_group)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(taxonomic_group == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_anomaly_combined"~"Mean annual air temperature\nanomaly (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"))%>% 
        filter(!term=="Intercept")

model_output$term <- factor(model_output$term, levels = c("Fish presence","d15N","Mean annual air temperature\nanomaly (deg C)")) 


LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression("-" * Delta*delta^15 * "N (nitrogen deposition)"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_zooplankton_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```

Interactions
```{r}
# interaction fish and nitrogen
model_output<-as_tibble(NULL)
for(i in unique(lme_data$taxonomic_group)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary + d15N_diff_from_start*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(taxonomic_group == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# yes interactions fish and nitrogen



# interaction fish and climate
model_output<-as_tibble(NULL)
for(i in unique(lme_data$taxonomic_group)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary +mean_air_temp_degC_anomaly_combined*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(taxonomic_group == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# no interactions fish and climate


# interaction nitrogen and climate
model_output<-as_tibble(NULL)
for(i in unique(lme_data$taxonomic_group)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary +mean_air_temp_degC_anomaly_combined*d15N_diff_from_start,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(taxonomic_group == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        filter(pval0.5 =="Yes" &!term=="(Intercept)") %>% pull(term) %>% unique(.)
# yes interactions nitrogen and climate

#  
# model_output<-model_output %>%
#         mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
#                                  p.value > 0.05 ~ "No")) %>% 
#         mutate(term = case_when(term=="(Intercept)"~"Intercept",
#                                 term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
#                                 term=="d15N_diff_from_start"~"d15N",
#                                 term=="fish_present_binary"~"Fish presence",
#                                 term=="d15N_diff_from_start:fish_present_binary"~"d15N x fish presence")) %>% filter(!term=="Intercept")
# 
# LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
#   geom_point(size = 4, shape = 21, stroke = 1.5) + 
#   custom_theme()+         
#   scale_fill_manual(values = taxa_colors) + 
#   scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
#   labs(x = "Estimate", 
#        y = "",
#        fill = "Taxonomic group",
#        color = expression(italic("P") <= 0.05)) +
#         theme(strip.background = element_blank())+
#         guides(fill = guide_legend(override.aes = list(color = NA)))+ 
#   scale_y_discrete(labels = function(term) {
#     ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
#         geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)
# 
# 
# write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_zooplankton_model_output.csv")
# 
# sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```


# 7. GLS

```{r}
## PHYTOPLANKTON AND HETEROTROPHIC PROTISTS
# read in the functional assignment file remove ~4k taxa that assign to fungi
tax_fun<-read.csv("2_DataAnalysis/V9_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object
rm(tax_fun)


ps_V9_norm_phyto<-subset_taxa(ps_V9_norm_sub, trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs"))
# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_phyto %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.35) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Chlorophyta_X" ~ "Chlorophyta",
                                             subdivision=="Streptophyta_X" ~ "Streptophyta",
                                             TRUE~subdivision
                                             ))


all_trophic<-sub %>% mutate(taxonomic_group=subdivision, trophic_level="phytoplankton") %>% select(-subdivision)

ps_V9_norm_hetero<-subset_taxa(ps_V9_norm_sub, !trophic_mode %in% c("phototrophs","phototrophs/mixotrophs","mixotrophs" )& !class %in% c("Arthropoda","Unassigned","Nematoda","Craniata","Tardigrada","Annelida","Gastrotricha","Platyhelminthes","Porifera","Mollusca","Metazoa_X","Cnidaria","Bryozoa")) 

# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_hetero %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.6) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$subdivision)

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Evosea_X" ~ "Evosea",
                                             subdivision=="Metazoa" ~ "Rotifera",
                                             TRUE~subdivision
                                             ))

all_trophic<-sub %>% mutate(taxonomic_group=subdivision, trophic_level="heterotrophic protists")%>% select(-subdivision) %>% rbind(all_trophic,.)

# remove other taxonomic levels aside from taxonomic_group
all_trophic <- all_trophic %>% select(-c(domain,supergroup,division))

# ZOOPLANKTON
# read in taxonomy assigned in Ch. 2
tax_blast<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/ZooplanktonSedDNA/5_DataAnalysis/BLAST_zooplankton/Max_Bra/5_BLAST_V9_original_single_multiple_updated.csv", row.names=1,na.strings="") %>% column_to_rownames(., var="qseqid") %>% 
   mutate(taxonomic_group = replace_na(taxonomic_group, "Unassigned")) %>% select(Kingdom,taxonomic_group)
tax_blast <- as.matrix(tax_blast) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_blast) # replace taxonomy table in the phyloseq object
rm(tax_blast)

# congomerate right away to taxonomic_group
ps_V9_norm_zoop <- ps_V9_norm_sub %>% tax_glom(., taxrank = "taxonomic_group")


# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_zoop %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(taxonomic_group%in%c(
        sub %>% filter(Abundance > 0.4) %>% select(taxonomic_group) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$taxonomic_group)

sub <- sub %>% select(-Kingdom)

all_trophic<-sub  %>% mutate(trophic_level="zooplankton") %>% rbind(all_trophic,.)


# switch the sign for nitrogen deposition
gls_data <-all_trophic %>% filter(is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_anomaly_combined,d15N_diff_from_start,fish_present_binary,lake_name,taxonomic_group, mid_cm, fish, trophic_level) %>% arrange(trophic_level, taxonomic_group,lake_name,desc(mid_cm)) %>% group_by(lake_name, taxonomic_group) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start) %>% mutate(abundance=Abundance) %>% select(-Abundance)


model_output <- as_tibble(NULL)

for (l in unique(gls_data$lake_name)) {
  for (i in unique(gls_data$taxonomic_group)) {
    subset <- gls_data %>% filter(taxonomic_group == i & lake_name == l)
    if (subset$fish[1] == 0) {
      model <- try(gls(abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start,
                       data = subset, correlation = corAR1(form = ~ time_seq)), silent = TRUE)
    } else {
      model <- try(gls(abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary,
                       data = subset, correlation = corAR1(form = ~ time_seq)), silent = TRUE)
    }

    # if the model throws a singularity error (for series where the abundance is 0 the whole time), then put NAs
    if (inherits(model, "try-error")) {
      model_table <- tibble(
        term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary"),
        Value = NA_real_,
        Std.Error = NA_real_,
        t.value = NA_real_,
        taxonomic_group = i,
        lake_name = l,
        trophic_level = subset$trophic_level[1]
      )
    } else {
      model_summary <- summary(model)
      model_table <- as_tibble(coef(model_summary), rownames = "term")
      model_table <- model_table %>%
        mutate(taxonomic_group = i, lake_name = l, trophic_level = subset$trophic_level[1]) %>%
        setNames(make.names(names(.))) %>%
        filter(term != "(Intercept)")
    }
    model_output <- bind_rows(model_output, model_table)
  }}; rm(model, i, l, model_table, model_summary)
# relabel some names to lower case
model_output<-model_output %>% mutate(estimate=Value, std.error=Std.Error) %>% select(-c(Value,Std.Error))

# remove extra dataframes
rm(subset,sub,ps_V9_norm_hetero,ps_V9_norm_phyto,ps_V9_norm_zoop,ps_V9_norm_sub,all_trophic)

```

#### by lake
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_lake <- model_output %>% filter(p.value<0.06) %>%
  group_by(trophic_level, lake_name, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop') %>% 
  arrange(trophic_level, lake_name, term) 
        
# make complete set of all combinations
complete_rows <- expand.grid(
  lake_name = names(lake_colors), # fishless lakes
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_anomaly_combined", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_lake<-left_join(complete_rows, effect_summary_lake, join_by(lake_name,trophic_level,term)) %>% 
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect))


effect_summary_lake$trophic_level<-factor(effect_summary_lake$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))
effect_summary_lake$lake_name<-factor(effect_summary_lake$lake_name, levels=names(lake_colors))

p1<-ggplot(effect_summary_lake, aes(x = lake_name, y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_anomaly_combined" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "Lake",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p2<-ggplot(effect_summary_lake, aes(x = lake_name, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_anomaly_combined" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "Lake",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

#### by state
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_state <- model_output %>% filter(p.value<0.06) %>%
        mutate(state=case_when(lake_name %in% names(lake_colors)[1:7]~"Wyoming",
                                          lake_name %in% names(lake_colors)[8:11]~"California",
                                          lake_name %in% names(lake_colors)[12:14]~"Washington")) %>%
  group_by(trophic_level, state, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop') %>% 
  arrange(trophic_level, state, term) 


# make complete set of all combinations
complete_rows <- expand.grid(
  state=c("California","Washington","Wyoming"), 
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_anomaly_combined", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_state<-left_join(complete_rows, effect_summary_state, join_by(state,trophic_level,term)) %>% 
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect))

        


effect_summary_state$trophic_level<-factor(effect_summary_state$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))
effect_summary_state$state<-factor(effect_summary_state$state, levels=c("California","Washington","Wyoming"))


p3<-ggplot(effect_summary_state, aes(x = state, y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_anomaly_combined" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "State",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p4<-ggplot(effect_summary_state, aes(x = state, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_anomaly_combined" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "State",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  
```


#### total
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_total<- model_output %>% filter(p.value<0.05) %>%
  group_by(trophic_level, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop'
  ) %>% 
  arrange(trophic_level, term) 
  
# make complete set of all combinations
complete_rows <- expand.grid(
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_anomaly_combined", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_total<-left_join(complete_rows, effect_summary_total, join_by(trophic_level,term)) %>%
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect)) %>% mutate(total="Total")

        
      

effect_summary_total$trophic_level<-factor(effect_summary_total$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))


p5<-ggplot(effect_summary_total, aes(x=total,y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_anomaly_combined" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x="Total",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p6<-ggplot(effect_summary_total, aes(x=total, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_anomaly_combined" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x="Total",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  


t1<-ggplot(effect_summary_total, aes(x = term, y = mean_abs_effect)) +
  geom_col(position = "dodge") +
        facet_wrap2(~trophic_level, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(trophic_level = c(
      "phytoplankton" = "Phytoplankton",
      "heterotrophic protists" = "Heterotrophic protists",
      "zooplankton" = "Zooplankton")))+
  labs(
    x = "",
    y = "Mean absolute effect")+
        scale_x_discrete(labels = c(
    "mean_air_temp_degC_anomaly_combined" = "Temperature",
    "d15N_diff_from_start" = "Nitrogen deposition",
    "fish_present_binary" = "Fish presence"))+
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) 

t2<-ggplot(effect_summary_total, aes(x = term, y = max_abs_effect)) +
  geom_col(position = "dodge") +
        facet_wrap2(~trophic_level, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(trophic_level = c(
      "phytoplankton" = "Phytoplankton",
      "heterotrophic protists" = "Heterotrophic protists",
      "zooplankton" = "Zooplankton")))+
  labs(
    x = "",
    y = "Max absolute effect")+
        scale_x_discrete(labels = c(
    "mean_air_temp_degC_anomaly_combined" = "Temperature",
    "d15N_diff_from_start" = "Nitrogen deposition",
    "fish_present_binary" = "Fish presence"))+
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) 


```

combined figure
```{r}
# (p1 | p3 | p5) + 
#   plot_layout(guides = "collect", widths = c(3, 2, 1.75)) + 
#   plot_annotation(tag_levels = 'A')
# 
# 
# ggsave("3_Figures/FigX_gls_V9_max_lake_state_total.png", width =15, height = 5, dpi = 400)
# 
# (p2 | p4 | p6) + 
#   plot_layout(guides = "collect", widths = c(3, 2, 1.75)) + 
#   plot_annotation(tag_levels = 'A')
# 
# 
# ggsave("3_Figures/FigX_gls_V9_mean_lake_state_total.png", width =15, height = 5, dpi = 400)



t1

ggsave("3_Figures/FigX_gls_V9_mean_trophic_level_total.png", width =4, height =7, dpi = 400)

t2

ggsave("3_Figures/FigX_gls_V9_max_trophic_level_total.png", width =4, height = 7, dpi = 400)
```





```{r}
# subset just Chlorophytes in one lake
test<-gls_data %>% filter(lake_name=="Footprint" & taxonomic_group=="Chlorophyta") 

# plot all the variables together
par(mfrow=c(4,1))
plot(test$abundance, type="l",main="Chlorophyta - phytoplankton", ylab="Relative abundance")
plot(test$mean_air_temp_degC_anomaly_combined, type="l", ylab="Air temperature anomaly\nfrom mid century mean (1951-1980)")
plot(test$d15N_diff_from_start, type="l", ylab="-Dd15N")
plot(test$fish_present_binary, pch=16, ylab="Fish presence")



# run GLS

model_output <- as_tibble(NULL)

for (l in unique(test$lake_name)) {
  for (i in unique(test$taxonomic_group)) {
    subset <- test %>% filter(taxonomic_group == i & lake_name == l)
    if (subset$fish[1] == 0) {
      model <- try(gls(abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start,
                       data = subset, correlation = corAR1(form = ~ time_seq)), silent = TRUE)
    } else {
      model <- try(gls(abundance ~ mean_air_temp_degC_anomaly_combined + d15N_diff_from_start + fish_present_binary,
                       data = subset, correlation = corAR1(form = ~ time_seq)), silent = TRUE)
    }

    # if the model throws a singularity error (for series where the abundance is 0 the whole time), then put NAs
    if (inherits(model, "try-error")) {
      model_table <- tibble(
        term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary"),
        Value = NA_real_,
        Std.Error = NA_real_,
        t.value = NA_real_,
        taxonomic_group = i,
        lake_name = l,
        trophic_level = subset$trophic_level[1]
      )
    } else {
      model_summary <- summary(model)
      model_table <- as_tibble(coef(model_summary), rownames = "term")
      model_table <- model_table %>%
        mutate(taxonomic_group = i, lake_name = l, trophic_level = subset$trophic_level[1]) %>%
        setNames(make.names(names(.))) %>%
        filter(term != "(Intercept)")
    }
    model_output <- bind_rows(model_output, model_table)
  }}; rm(model, i, l, model_table, model_summary)
# relabel some names to lower case
single_model_output<-model_output %>% mutate(estimate=Value, std.error=Std.Error) %>% select(-c(Value,Std.Error))


# double checked this matched the output from the full GLS run 
subset<-model_output %>%  filter(lake_name=="Footprint" & taxonomic_group=="Chlorophyta", trophic_level=="phytoplankton") 


# look at simple linear regression
summary(lm(sqrt(test$abundance)~test$d15N_diff_from_start)) 
par(mfrow=c(1,1))
plot(sqrt(test$abundance)~test$d15N_diff_from_start, pch=16)
abline(lm(test$abundance~test$d15N_diff_from_start))



# look at a multiple linear regression of the abundances and the three predictors
summary(lm(test$abundance~test$d15N_diff_from_start+test$mean_air_temp_degC_anomaly_combined+test$fish_present_binary))

# look at their correlations
cor(test$abundance,test$d15N_diff_from_start)
cor(test$abundance,test$mean_air_temp_degC_anomaly_combined)
cor(test$abundance,test$fish_present_binary)

# try time series analysis
require(TSA)
require(lmtest)
attach(test)
y<-ts(abundance, start = 1, end=length(abundance), frequency=1)
x_climate<-ts(mean_air_temp_degC_anomaly_combined, start=1, end=length(mean_air_temp_degC_anomaly_combined),frequency=1)
x_nitro<-ts(d15N_diff_from_start, start=1, end=length(d15N_diff_from_start),frequency=1)
x_fish<-ts(fish_present_binary, start=1, end=length(fish_present_binary),frequency=1)

grangertest(y~x_climate, order=5) # granger test of y on x
grangertest(y~x_nitro, order=5) # granger test of x on y 
grangertest(y~x_fish, order=5) # granger test of x on y 

prewhiten(x_climate,y, main="prewhitened") # prewhitened series - doesn't work because single points
prewhiten(x_nitro,y, main="prewhitened") # prewhitened series
detach()

```




For manuscript: 
- need to mention could be feedbacks between community and d15N values, check granger causality?



### NMDS with diff
```{r}
# combine all three of the NMDS data frames
nmds_comb <-rbind(read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_phyto.csv", header=T, row.names = 1) %>% 
                   select(sample_id, MDS2,d15N_anomaly_mean_1800_1850, mean_air_temp_degC_anomaly_combined, fish_present_binary_YN) %>% 
                   rename(NMDS=MDS2) %>% 
                   mutate(trophic_level="Phytoplankton"),

 
           read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_hetero_prot.csv", header=T, row.names = 1) %>% 
                   select(sample_id, MDS2,d15N_anomaly_mean_1800_1850, mean_air_temp_degC_anomaly_combined, fish_present_binary_YN) %>%
                   rename(NMDS=MDS2) %>% 
                   mutate(trophic_level="Heterotrophic\nprotists"),

 
           read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_zoop.csv", header=T, row.names = 1) %>% 
                   select(sample_id, MDS1, d15N_anomaly_mean_1800_1850, mean_air_temp_degC_anomaly_combined, fish_present_binary_YN) %>%
                   rename(NMDS=MDS1) %>% 
                   mutate(trophic_level="Zooplankton")
           )

# add in lake name and state
nmds_comb <- left_join(nmds_comb, metadata %>% select(sample_id, lake_name, state, mid_cm), join_by(sample_id)) 

nmds_comb$lake_name <- factor(nmds_comb$lake_name, levels = names(lake_colors))
nmds_comb$state <- factor(nmds_comb$state, levels = c("Washington", "Wyoming","California"))
nmds_comb$trophic_level <- factor(nmds_comb$trophic_level, levels = c("Phytoplankton", "Heterotrophic\nprotists", "Zooplankton"))

nmds_comb <- nmds_comb %>% arrange(trophic_level, lake_name, desc(mid_cm))

# make the difference columns for NMDS, nitrogen, and temperature
nmds_comb <- nmds_comb %>% 
        group_by(trophic_level, lake_name) %>%
        mutate(NMDS_diff = c(NA, diff(NMDS)),
               temp_diff = c(NA, diff(mean_air_temp_degC_anomaly_combined)),
               nit_diff = c(NA, diff(d15N_anomaly_mean_1800_1850))) %>% 
        slice(-1) %>% # Remove the first row per group since it has NA after diff()
        ungroup()


## NMDS diff and X diff (nitrogen and temperature) 


temp<-ggplot(nmds_comb, aes(x=temp_diff,y=NMDS_diff, color=lake_name))+
        facet_grid(trophic_level~state)+
        geom_point()+ 
        scale_color_manual(values=lake_colors) +
        custom_theme() + scale_y_reverse() +
        labs(x="Average annual air temperature anomaly
from 1951-1980 mean (deg C) (difference)",
        y="NMDS (difference)",
             color="Lake")+ 
        theme(strip.background = element_rect(fill = "white"),
               strip.text.y = element_blank())+
        geom_smooth(method = "lm", se = F)



nit<-ggplot(nmds_comb, aes(x=nit_diff,y=NMDS_diff, color=lake_name))+
        facet_grid(trophic_level~state)+
        geom_point()+ 
        scale_color_manual(values=lake_colors) +
        custom_theme() + scale_y_reverse() + scale_x_reverse() +
        labs(x=expression(delta^15 * "N anomaly from 1800-1850 mean (difference)"),
        y="NMDS (difference)",
             color="Lake") +
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank(),
               strip.text.y = element_blank())+
        geom_smooth(method = "lm", se = F)




fish <- ggplot(nmds_comb, aes(x = factor(fish_present_binary_YN), y = NMDS_diff, color = lake_name)) +
  facet_grid(trophic_level ~ state) +
  geom_point() + 
  scale_color_manual(values = lake_colors) +
  custom_theme() + 
  scale_y_reverse() +
  labs(x = "Fish present",
        y="NMDS (difference)",
    color = "Lake") +
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank()) +
        geom_smooth(method = "lm", se = F)

(temp + nit + fish) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "right") &
  guides(color = guide_legend(override.aes = list(size = 5)))  


ggsave("3_Figures/FigX_NMDS_state_stressor_trophiclevel_diff_X_Y.png", height=6, width=16, units="in")



## only using NMDS difference

temp<-ggplot(nmds_comb, aes(x=mean_air_temp_degC_anomaly_combined,y=NMDS_diff, color=lake_name))+
        facet_grid(trophic_level~state)+
        geom_point()+ 
        scale_color_manual(values=lake_colors) +
        custom_theme() + scale_y_reverse() +
        labs(x="Average annual air temperature
        anomaly from 1951-1980 mean (deg C)",
        y="NMDS (difference)",
             color="Lake")+ 
        theme(strip.background = element_rect(fill = "white"),
               strip.text.y = element_blank())+
        geom_smooth(method = "lm", se = F)


nit<-ggplot(nmds_comb, aes(x=d15N_anomaly_mean_1800_1850,y=NMDS_diff, color=lake_name))+
        facet_grid(trophic_level~state)+
        geom_point()+ 
        scale_color_manual(values=lake_colors) +
        custom_theme() + scale_y_reverse() + scale_x_reverse() +
        labs(x=expression(delta^15 * "N anomaly from 1800-1850 mean"),
        y="NMDS (difference)",
             color="Lake") +
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank(),
               strip.text.y = element_blank())+
        geom_smooth(method = "lm", se = F)



fish <- ggplot(nmds_comb, aes(x = factor(fish_present_binary_YN), y = NMDS_diff, color = lake_name)) +
  facet_grid(trophic_level ~ state) +
  geom_point() + 
  scale_color_manual(values = lake_colors) +
  custom_theme() + 
  scale_y_reverse() +
  labs(x = "Fish present",
        y="NMDS (difference)",
    color = "Lake") +
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank())+
        geom_smooth(method = "lm", se = F)

(temp + nit + fish) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "right") &
  guides(color = guide_legend(override.aes = list(size = 5)))  


ggsave("3_Figures/FigX_NMDS_state_stressor_trophiclevel_diff_Y.png", height=6, width=16, units="in")
```


### written by chatGPT, just to have a look at quick summaries of NMDS relationships
```{r}
library(broom)

# Perform regression for each combination of trophic_level and state
lm_results <- nmds_comb %>%
  group_by(trophic_level, state, lake_name) %>%  # Group by facets and lakes
  do(tidy(lm(NMDS ~ mean_air_temp_degC_anomaly_combined, data = .))) %>% 
  filter(term == "mean_air_temp_degC_anomaly_combined") %>%  # Keep only slope term
  left_join(
    nmds_comb %>%
      group_by(trophic_level, state, lake_name) %>%
      do(glance(lm(NMDS ~ mean_air_temp_degC_anomaly_combined, data = .))) %>%
      select(trophic_level, state, lake_name, r.squared, p.value), 
    by = c("trophic_level", "state", "lake_name")
  )

ggplot(lm_results %>% filter(p.value.x<0.05), aes(x = estimate, y = lake_name, color = trophic_level)) +
  geom_point(aes(size=r.squared)) +  # Plot slopes as points
  geom_errorbarh(aes(xmin = estimate - std.error, xmax = estimate + std.error), height = 0.2) +  # Confidence intervals
  facet_wrap(~ state, scales = "free_y") +  # Separate by state
  labs(x = "Slope of NMDS vs. Temperature Anomaly", y = "Lake", color = "Trophic Level",
       title = "Summary of Linear Regression Results") +
  theme_minimal() +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"))



# Perform regression for each combination of trophic_level and state
lm_results <- nmds_comb %>%
  group_by(trophic_level, state, lake_name) %>%  # Group by facets and lakes
  do(tidy(lm(NMDS ~ d15N_anomaly_mean_1800_1850, data = .))) %>% 
  filter(term == "d15N_anomaly_mean_1800_1850") %>%  # Keep only slope term
  left_join(
    nmds_comb %>%
      group_by(trophic_level, state, lake_name) %>%
      do(glance(lm(NMDS ~ d15N_anomaly_mean_1800_1850, data = .))) %>%
      select(trophic_level, state, lake_name, r.squared, p.value), 
    by = c("trophic_level", "state", "lake_name")
  )

ggplot(lm_results %>% filter(p.value.x<0.05), aes(x = estimate, y = lake_name, color = trophic_level)) +
  geom_point(aes(size=r.squared)) +  # Plot slopes as points
  geom_errorbarh(aes(xmin = estimate - std.error, xmax = estimate + std.error), height = 0.2) +  # Confidence intervals
  facet_wrap(~ state, scales = "free_y") +  # Separate by state
  labs(x = "Slope of NMDS vs. Nitrogen Deposition", y = "Lake", color = "Trophic Level",
       title = "Summary of Linear Regression Results") +
  theme_minimal() +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"))
```




by state but with lakes 
```{r}
# combine all three of the NMDS data frames
nmds_comb <-rbind(read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_phyto.csv", header=T, row.names = 1) %>% 
                   select(sample_id, MDS2,d15N_anomaly_mean_1800_1850, mean_air_temp_degC_anomaly_combined, fish_present_binary_YN) %>% 
                   rename(NMDS=MDS2) %>% 
                   mutate(trophic_level="Phytoplankton"),

 
           read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_hetero_prot.csv", header=T, row.names = 1) %>% 
                   select(sample_id, MDS2,d15N_anomaly_mean_1800_1850, mean_air_temp_degC_anomaly_combined, fish_present_binary_YN) %>%
                   rename(NMDS=MDS2) %>% 
                   mutate(trophic_level="Heterotrophic\nprotists"),

 
           read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_zoop.csv", header=T, row.names = 1) %>% 
                   select(sample_id, MDS1, d15N_anomaly_mean_1800_1850, mean_air_temp_degC_anomaly_combined, fish_present_binary_YN) %>%
                   rename(NMDS=MDS1) %>% 
                   mutate(trophic_level="Zooplankton")
           )

# add in lake name and state
nmds_comb <- left_join(nmds_comb, metadata %>% select(sample_id, lake_name, state, mid_cm), join_by(sample_id)) 

nmds_comb$lake_name <- factor(nmds_comb$lake_name, levels = names(lake_colors))
nmds_comb$state <- factor(nmds_comb$state, levels = c("Washington", "Wyoming","California"))
nmds_comb$trophic_level <- factor(nmds_comb$trophic_level, levels = c("Phytoplankton", "Heterotrophic\nprotists", "Zooplankton"))

nmds_comb <- nmds_comb %>% arrange(trophic_level, lake_name, desc(mid_cm))

nmds_comb <- nmds_comb %>% group_by(lake_name, trophic_level) %>% 
        summarize(nmds_max = max(NMDS)-min(NMDS),
                  nit_max = max(d15N_anomaly_mean_1800_1850, na.rm=T) - min(d15N_anomaly_mean_1800_1850, na.rm=T),
                  temp_max = max(mean_air_temp_degC_anomaly_combined) - min(mean_air_temp_degC_anomaly_combined)) %>% 
        left_join(.,metadata %>% select(lake_name, state, fish) %>% distinct(.), join_by(lake_name))

state_colors <- c("Washington" = "orange",
                  "Wyoming" = "#008080",
                  "California" = "#5D478B")

nmds_comb$state<-factor(nmds_comb$state, levels=names(state_colors))

temp<-ggplot(nmds_comb, aes(x=temp_max,y=nmds_max, color=state))+
        facet_grid(~trophic_level)+
        geom_point(size=4)+ 
        scale_color_manual(values=state_colors) +
        custom_theme() +
        labs(x="Maximum change in average annual air temperature
anomaly from 1951-1980 mean (deg C)",
        y="Maximum change in NMDS",
             color="State")+ 
        theme(strip.background = element_rect(fill = "white"),
               strip.text.y = element_blank())

nit<-ggplot(nmds_comb, aes(x=nit_max,y=nmds_max, color=state))+
        facet_grid(~trophic_level)+
        geom_point(size=4)+ 
        scale_color_manual(values=state_colors) +
        custom_theme()+
        labs(x=expression("Maximum difference " * delta^15 * "N anomaly from 1800-1850 mean"),
        y="Maximum change in NMDS",
             color="State") +
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank(),
               strip.text.y = element_blank())

fish <- ggplot(nmds_comb, aes(x = factor(fish), y = nmds_max, color = state)) +
        facet_grid(~trophic_level)+
        geom_point(size=4)+ 
         scale_color_manual(values = state_colors) +
        custom_theme() + 
        labs(x = "Fish present",
        y="NMDS (difference)",
        color = "State") +
        scale_x_discrete(labels = c("0" = "No", "1" = "Yes")) + 
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank())

(temp + nit + fish) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "right") &
  guides(color = guide_legend(override.aes = list(size = 5)))  


ggsave("3_Figures/FigX_max_NMDS_max_stressor_state.png", height=3, width=17, units="in")
```


by lake
```{r}
# combine all three of the NMDS data frames
nmds_comb <-rbind(read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_phyto.csv", header=T, row.names = 1) %>% 
                   select(sample_id, MDS2,d15N_anomaly_mean_1800_1850, mean_air_temp_degC_anomaly_combined, fish_present_binary_YN) %>% 
                   rename(NMDS=MDS2) %>% 
                   mutate(trophic_level="Phytoplankton"),

 
           read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_hetero_prot.csv", header=T, row.names = 1) %>% 
                   select(sample_id, MDS2,d15N_anomaly_mean_1800_1850, mean_air_temp_degC_anomaly_combined, fish_present_binary_YN) %>%
                   rename(NMDS=MDS2) %>% 
                   mutate(trophic_level="Heterotrophic\nprotists"),

 
           read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_zoop.csv", header=T, row.names = 1) %>% 
                   select(sample_id, MDS1, d15N_anomaly_mean_1800_1850, mean_air_temp_degC_anomaly_combined, fish_present_binary_YN) %>%
                   rename(NMDS=MDS1) %>% 
                   mutate(trophic_level="Zooplankton")
           )

# add in lake name and state
nmds_comb <- left_join(nmds_comb, metadata %>% select(sample_id, lake_name, state, mid_cm), join_by(sample_id)) 

nmds_comb$lake_name <- factor(nmds_comb$lake_name, levels = names(lake_colors))
nmds_comb$state <- factor(nmds_comb$state, levels = c("Washington", "Wyoming","California"))
nmds_comb$trophic_level <- factor(nmds_comb$trophic_level, levels = c("Phytoplankton", "Heterotrophic\nprotists", "Zooplankton"))

nmds_comb <- nmds_comb %>% arrange(trophic_level, lake_name, desc(mid_cm))

nmds_comb <- nmds_comb %>% group_by(lake_name, trophic_level) %>% 
        summarize(nmds_max = max(NMDS)-min(NMDS),
                  nit_max = max(d15N_anomaly_mean_1800_1850, na.rm=T) - min(d15N_anomaly_mean_1800_1850, na.rm=T),
                  temp_max = max(mean_air_temp_degC_anomaly_combined) - min(mean_air_temp_degC_anomaly_combined)) %>% 
        left_join(.,metadata %>% select(lake_name, state, fish) %>% distinct(.), join_by(lake_name))

nmds_comb$lake_name<-factor(nmds_comb$lake_name, levels=names(lake_colors))


temp<-ggplot(nmds_comb, aes(x=temp_max,y=nmds_max, color=lake_name))+
        facet_grid(~trophic_level)+
        geom_point(size=4)+ 
        scale_color_manual(values=lake_colors) +
        custom_theme() +
        labs(x="Maximum change in average annual air temperature
anomaly from 1951-1980 mean (deg C)",
        y="Maximum change in NMDS",
             color="Lake")+ 
        theme(strip.background = element_rect(fill = "white"),
               strip.text.y = element_blank())

nit<-ggplot(nmds_comb, aes(x=nit_max,y=nmds_max, color=lake_name))+
        facet_grid(~trophic_level)+
        geom_point(size=4)+ 
        scale_color_manual(values=lake_colors) +
        custom_theme()+
        labs(x=expression("Maximum difference " * delta^15 * "N anomaly from 1800-1850 mean"),
        y="Maximum change in NMDS",
             color="Lake") +
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank(),
               strip.text.y = element_blank())

fish <- ggplot(nmds_comb, aes(x = factor(fish), y = nmds_max, color = lake_name)) +
        facet_grid(~trophic_level)+
        geom_point(size=4)+ 
         scale_color_manual(values = lake_colors) +
        custom_theme() + 
        labs(x = "Fish present",
        y="NMDS (difference)",
        color = "Lake") +
        scale_x_discrete(labels = c("0" = "No", "1" = "Yes")) + 
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank())

(temp + nit + fish) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "right") &
  guides(color = guide_legend(override.aes = list(size = 5)))  


ggsave("3_Figures/FigX_max_NMDS_max_stressor_lake.png", height=4, width=17, units="in")
```



test fish t-test - all good
```{r}
sub<-nmds_comb %>% filter(state=="WA" & trophic_level=="Phytoplankton")
t.test()

t_test <- t.test(NMDS ~ fish_present_binary_YN, data = nmds_comb %>% filter(state=="Washington" & trophic_level=="Phytoplankton")) 
t_test$statistic



t_test_results <- nmds_comb %>%
  group_by(trophic_level, state) %>%
  summarise(
    t_test = list(t.test(NMDS ~ fish_present_binary_YN, data = cur_data())),
    .groups = "drop"
  ) %>%
  mutate(
    p_value = sapply(t_test, function(x) x$p.value),  # Extract p-value
    t_value = sapply(t_test, function(x) x$statistic),  # Extract t-value
    sig_label = ifelse(p_value < 0.05, "*", ""),  # Use '*' if significant
    y_sig = min(nmds_comb$NMDS, na.rm = TRUE) + 0.5,  # Position * above boxplot
    y_tval = 1.2,  # Position t-value at bottom
    t_label = paste0("t = ", round(t_value, 2))  # Format t-value label
  )




## nitrogen 
lm_res<-lm(NMDS~d15N_anomaly_mean_1800_1850, data=nmds_comb %>% filter(is.na(d15N_anomaly_mean_1800_1850)==F & trophic_level=="Zooplankton" & state=="Washington"))

summary(lm_res)$coefficients[2, 4]
summary(lm_res)$r.squared


ggplot(data=nmds_comb %>% filter(is.na(d15N_anomaly_mean_1800_1850)==F & trophic_level=="Phytoplankton" & state=="Washington"), aes(x = d15N_anomaly_mean_1800_1850, y = NMDS, color = lake_name)) +
        geom_point()+ 
        geom_smooth(method = "lm", color = "black", se = FALSE) + 
          scale_color_manual(values = lake_colors) +
  custom_theme() + 
  scale_y_reverse() +
  scale_x_reverse() + 
  labs(x=expression(delta^15 * "N anomaly from 1800-1850 mean"),
       color = "Lake") + 
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank(),
               strip.text.y = element_blank())



## temperature 
lm_res<-lm(NMDS~mean_air_temp_degC_anomaly_combined, data=nmds_comb %>% filter(trophic_level=="Zooplankton" & state=="Washington"))

summary(lm_res)$coefficients[2, 4]
summary(lm_res)$r.squared



# plot
ggplot(nmds_comb %>% filter(trophic_level=="Zooplankton" & state=="Washington"), aes(x = mean_air_temp_degC_anomaly_combined, 
                              y = NMDS, color = lake_name)) +
  geom_point() +
  scale_color_manual(values = lake_colors) +
  custom_theme() + 
  scale_y_reverse() +
  labs(x = "Average annual air temperature anomaly\nfrom 1951-1980 mean (deg C)",
       color = "Lake") + 
  theme(strip.background = element_rect(fill = "white"),
        strip.text.y = element_blank())+ 
                geom_smooth(method = "lm", color = "black", se = FALSE) 


ggplot(data=nmds_comb %>% filter(trophic_level=="Zoooplankton" & state=="Washington"), aes(x = mean_air_temp_degC_anomaly_combined, y = NMDS, color = lake_name)) +
        geom_point()+ 
        geom_smooth(method = "lm", color = "black", se = FALSE) + 
          scale_color_manual(values = lake_colors) +
  custom_theme() + 
  scale_y_reverse() +
  labs(x=expression(delta^15 * "N anomaly from 1800-1850 mean"),
       color = "Lake") + 
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank(),
               strip.text.y = element_blank())






model_stats <- nmds_comb %>% filter(is.na(d15N_anomaly_mean_1800_1850)==F) %>% 
  group_by(trophic_level, state) %>%
  summarise(
    lm_fit = list(lm(NMDS ~ d15N_anomaly_mean_1800_1850, data = cur_data())),
    .groups = "drop"
  ) %>%
  mutate(
    p_value = sapply(lm_fit, function(m) summary(m)$coefficients[2, 4]), # grab p-val
    r_squared = sapply(lm_fit, function(m) summary(m)$r.squared) # grab r-sq
  ) %>%
  filter(p_value < 0.05) %>% # plot significant models only 
  mutate(
    label = paste0("R = ", signif(r_squared, 3)),
    x_pos = min(nmds_comb$d15N_anomaly_mean_1800_1850, na.rm = TRUE)*0.6,  
    y_pos = 1.2 
  )

# make separate dataframe of only signficant models to plot the lines
significant_models <- nmds_comb %>% filter(is.na(d15N_anomaly_mean_1800_1850)==F) %>%
  inner_join(model_stats, by = c("trophic_level", "state"))

nit <- ggplot(nmds_comb %>% filter(is.na(d15N_anomaly_mean_1800_1850)==F), 
              aes(x = d15N_anomaly_mean_1800_1850, y = NMDS, color = lake_name)) +
  facet_grid(trophic_level ~ state) +
  geom_point() +
  scale_color_manual(values = lake_colors) +
  custom_theme() + 
  scale_y_reverse() +
  scale_x_reverse() + 
  labs(x=expression(delta^15 * "N anomaly from 1800-1850 mean"),
       color = "Lake") + 
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank(),
               strip.text.y = element_blank())


# Add regression lines only for significant models
if (nrow(significant_models) > 0) {
  nit <- nit + geom_smooth(data = significant_models, 
                             method = "lm", color = "black", se = FALSE)
}

# Add p-values and R to the plot at correct positions
nit <- nit + geom_text(data = model_stats, aes(x = x_pos, y = y_pos, label = label),
                         color = "black", size = 4, inherit.aes = FALSE)


```




```{r}
temp<-ggplot(nmds_comb, aes(x=mean_air_temp_degC_anomaly_combined,y=NMDS, color=lake_name))+
        facet_grid(trophic_level~state)+
        geom_point()+ 
        scale_color_manual(values=lake_colors) +
        custom_theme() + scale_y_reverse() +
        labs(x="Average annual air temperature
        anomaly from 1951-1980 mean (deg C)",
             color="Lake")+ 
        theme(strip.background = element_rect(fill = "white"),
               strip.text.y = element_blank())


nit<-ggplot(nmds_comb %>% filter(is.na(d15N_anomaly_mean_1800_1850)==F), aes(x=d15N_anomaly_mean_1800_1850,y=NMDS, color=lake_name))+
        facet_grid(trophic_level~state)+
        geom_point()+ 
        scale_color_manual(values=lake_colors) +
        custom_theme() + scale_y_reverse() + scale_x_reverse() +
        labs(x=expression(delta^15 * "N anomaly from 1800-1850 mean"),
             color="Lake") +
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank(),
               strip.text.y = element_blank())



fish <- ggplot(nmds_comb, aes(x = factor(fish_present_binary_YN), y = NMDS, color = lake_name)) +
  facet_grid(trophic_level ~ state) +
  geom_point() + 
  scale_color_manual(values = lake_colors) +
  custom_theme() + 
  scale_y_reverse() +
  labs(x = "Fish present",
    color = "Lake") +
        theme(strip.background = element_rect(fill = "white"),
               axis.title.y = element_blank(),
              axis.text.y = element_blank())

(temp + nit + fish) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "right") &
  guides(color = guide_legend(override.aes = list(size = 5)))  


ggsave("3_Figures/FigX_NMDS_state_stressor_trophiclevel.png", height=6, width=16, units="in")
```


## b. LME model summaries

All effects plotted together (fish and fishless)
```{r}
sig_lme<-rbind(
        read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_phytoplankton_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.5=="Yes") %>% mutate(trophic_level="Phytoplankton"),
        
        read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_heterotrophic_protists_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.5=="Yes") %>% mutate(trophic_level="Heterotrophic protists"),
        
        read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_zooplankton_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.5=="Yes") %>% mutate(trophic_level="Zooplankton")
) %>% 
        
mutate(Value=abs(Value)) %>% # make absolute value
group_by(trophic_level, term) %>% # group by trophic level and term (regardless of fish or fishless LMEs)
summarize(mean_effect=mean(Value)) %>% ungroup() # calculate the mean effect for each trophic level and stressor (term)


# order trophic level and term
sig_lme$trophic_level<-factor(sig_lme$trophic_level, levels=c("Phytoplankton", "Heterotrophic protists", "Zooplankton"))

sig_lme$term<-factor(sig_lme$term, levels=c("Air temperature", "Nitrogen deposition","Fish"))

ggplot(sig_lme, aes(x = factor(term), y = mean_effect)) +
  geom_bar(stat = "identity") +
  facet_wrap2(~trophic_level,  strip = strip_themed(
      background_x = elem_list_rect(fill = c("#33B58C","#85CFFF","#E07B33")))) +
  theme_minimal() +
  labs(
    x = "Anthropogenic stressor",
    y = "Mean absolute effect of significant taxa") + custom_theme() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))

#ggsave("3_Figures/FigX_LME_summary.png", height=5, width=8, units="in")
```


only significant taxa
```{r}
sig_lme<-rbind(
        read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_phytoplankton_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.5=="Yes") %>% mutate(trophic_level="Phytoplankton"),
        
        read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_heterotrophic_protists_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.5=="Yes") %>% mutate(trophic_level="Heterotrophic protists"),
        
        read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_zooplankton_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.5=="Yes") %>% mutate(trophic_level="Zooplankton")
) %>% 
        
mutate(Value=abs(Value)) %>% # make absolute value
group_by(trophic_level, term, fish) %>% # group by trophic level and term (regardless of fish or fishless LMEs)
summarize(mean_effect=mean(Value)) %>% ungroup() # calculate the mean effect for each trophic level and stressor (term)


# order trophic level, term, and fish
sig_lme$trophic_level<-factor(sig_lme$trophic_level, levels=c("Phytoplankton", "Heterotrophic protists", "Zooplankton"))

sig_lme$term<-factor(sig_lme$term, levels=c("Air temperature", "Nitrogen deposition","Fish"))

sig_lme$fish<-factor(sig_lme$fish, levels=c("Fishless", "Fish"))

ggplot(sig_lme, aes(x = factor(term), y = mean_effect)) +
  geom_bar(stat = "identity") +
  facet_grid2(fish~trophic_level,  strip = strip_themed(
      background_x = elem_list_rect(fill = c("#33B58C","#85CFFF","#E07B33")),
      background_y = elem_list_rect(fill = "white"))) +
  theme_minimal() +
  labs(
    x = "Anthropogenic stressor",
    y = "Mean absolute effect of significant taxa") + custom_theme() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("3_Figures/FigX_LME_summary_fish_significant.png", height=5, width=8, units="in")
```




## d. clustered relative abundances - updated with median or removing lakes and splitting the means (but haven't upated values themselves for MS)
```{r}
## PHYTOPLANKTON AND HETEROTROPHIC PROTISTS
# read in the functional assignment file remove ~4k taxa that assign to fungi
tax_fun<-read.csv("2_DataAnalysis/V9_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object
rm(tax_fun)


ps_V9_norm_phyto<-subset_taxa(ps_V9_norm_sub, trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs") | trophic_mode =="unknown" & subdivision%in%c("Cryptophyta_X", "Dinoflagellata", "Gyrista", "Haptophyta_X"))
# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_phyto %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.35) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Chlorophyta_X" ~ "Chlorophyta",
                                             subdivision=="Streptophyta_X" ~ "Streptophyta",
                                             TRUE~subdivision
                                             ))


all_trophic<-sub %>% mutate(taxonomic_group=subdivision, trophic_level="Phytoplankton") %>% select(-subdivision)

ps_V9_norm_hetero<- subset_taxa(ps_V9_norm_sub, 
  (!trophic_mode %in% c("phototrophs", "phototrophs/mixotrophs", "mixotrophs") & 
   !(subdivision == "Metazoa" & class != "Rotifera")) & 
  !(trophic_mode == "unknown" & !subdivision %in% c("Alveolata_X", "Cercozoa", "Chrompodellids", "Discoba_X", "Euglenozoa", "Stramenopiles_X", "Colponemidia", "Foraminifera", "Hemimastigophora_X", "Nibbleridia_X")))

# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_hetero %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.55) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$subdivision)

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Evosea_X" ~ "Evosea",
                                             subdivision=="Metazoa" ~ "Rotifera",
                                             TRUE~subdivision
                                             ))

all_trophic<-sub %>% mutate(taxonomic_group=subdivision, trophic_level="Heterotrophic protists")%>% select(-subdivision) %>% rbind(all_trophic,.)

# remove other taxonomic levels aside from taxonomic_group
all_trophic <- all_trophic %>% select(-c(domain,supergroup,division))

# ZOOPLANKTON
# read in taxonomy assigned in Ch. 2
tax_blast<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/ZooplanktonSedDNA/5_DataAnalysis/BLAST_zooplankton/Max_Bra/5_BLAST_V9_original_single_multiple_updated.csv", row.names=1,na.strings="") %>% column_to_rownames(., var="qseqid") %>% 
   mutate(taxonomic_group = replace_na(taxonomic_group, "Unassigned")) %>% select(Kingdom,taxonomic_group)
tax_blast <- as.matrix(tax_blast) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_blast) # replace taxonomy table in the phyloseq object
rm(tax_blast)

# congomerate right away to taxonomic_group
ps_V9_norm_zoop <- ps_V9_norm_sub %>% tax_glom(., taxrank = "taxonomic_group")


# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_zoop %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(taxonomic_group%in%c(
        sub %>% filter(Abundance > 0.4) %>% select(taxonomic_group) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$taxonomic_group)

sub <- sub %>% select(-Kingdom)

all_trophic <- sub  %>% mutate(trophic_level="Zooplankton") %>% rbind(all_trophic,.)


all_trophic <-all_trophic %>% select(Abundance,mean_air_temp_degC_anomaly_combined,d15N_anomaly_mean_1800_1850,fish_present_binary,lake_name,taxonomic_group, mid_cm, fish, trophic_level, date_mid_AD_combo, state) %>% arrange(trophic_level, taxonomic_group,lake_name,desc(mid_cm)) %>% group_by(lake_name, taxonomic_group) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(abundance=Abundance) %>% select(-Abundance) %>% 
        mutate(trophic_level_tax_group=paste(trophic_level,taxonomic_group, sep=" - "))

# change skelton to be in the fishless lake category for the "fish" column
all_trophic <- all_trophic %>% mutate(fish=case_when(lake_name=="Skelton"~0,
                                                     !lake_name=="Skelton"~fish))

# factor lake name to match the lake colors
all_trophic$lake_name<-factor(all_trophic$lake_name, levels=names(lake_colors))

all_trophic$state<-factor(all_trophic$state, levels=c("Washington","Wyoming","California"))


# subset by taxa with significant LME results and effects greater than abs(0.04)
clust_tax<-rbind(
        read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_phytoplankton_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.05=="Yes") %>% mutate(trophic_level="Phytoplankton"),
        
        read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_heterotrophic_protists_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.05=="Yes") %>% mutate(trophic_level="Heterotrophic protists"),
        
        read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_zooplankton_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.05=="Yes") %>% mutate(trophic_level="Zooplankton")) %>% 
        # select taxa that have an effect greater than 0.4
        filter(Value > 0.04 | Value < (-0.04)) %>%
        select(taxa) %>% distinct(.) %>% pull()
        
all_trophic_top <- all_trophic %>% filter(taxonomic_group %in% clust_tax)

# remove extra objects
rm(sub);rm(ps_V9_norm_hetero);rm(ps_V9_norm_phyto);rm(ps_V9_norm_sub); rm(ps_V9_norm_zoop); rm(clust_tax)
```

### 1. Averages overall
for top taxa
```{r}
all_trophic_top$trophic_level_tax_group <- factor(
        all_trophic_top$trophic_level_tax_group,
        levels = c(
                "Phytoplankton - Chlorophyta",
                "Phytoplankton - Streptophyta",
                "Phytoplankton - Gyrista",
                "Phytoplankton - Dinoflagellata",
                "Heterotrophic protists - Ciliophora",
                "Zooplankton - Leptodiaptomus",
                "Zooplankton - Hesperodiaptomus",
                "Zooplankton - Daphnia spp."))

avg_lake_50yrs<-all_trophic_top %>% 
        mutate(date_window_50yrs=cut(date_mid_AD_combo,
                        breaks = seq(1400, 2050, by = 50),
                        right=F, # intervals are left closed [1400,1450)
                        labels = paste(seq(1400, 2000, by = 50), 
                                       seq(1449, 2049, by = 50), sep = "-")))%>%
       group_by(trophic_level_tax_group, date_window_50yrs) %>% 
        summarize(avg_abund=mean(abundance),
                  median_year = median(as.numeric(unlist(strsplit(unique(as.character(date_window_50yrs)), "-"))))) %>%
        ungroup() %>%
        # the relative abundance for prior to 1400 is listed as NA - so remove it here
        filter(complete.cases(.))




ggplot(data=all_trophic_top, aes(x=date_mid_AD_combo, y=abundance, color=lake_name))+
        facet_wrap(~trophic_level_tax_group)+
        geom_line() + 
        geom_line(data=avg_lake_50yrs, aes(x=median_year, y=avg_abund, color=NULL), linewidth=2, color="black")+
        custom_theme()+
        labs(color="Lake",
             y="Relative abundance (proportion)",
             x="Date (Common Era)")+
        scale_color_manual(values=lake_colors)

ggsave("3_Figures/FigX_clustered_rel_abund_lake_top.png", height=10, width=20, units="in")
```

for all taxa 
```{r}
all_trophic$trophic_level_tax_group <- factor(
        all_trophic$trophic_level_tax_group,
        levels = c(
                "Phytoplankton - Chlorophyta"         ,
                "Phytoplankton - Dinoflagellata"      ,
                "Phytoplankton - Gyrista"             ,
                "Phytoplankton - Streptophyta"        ,
                "Heterotrophic protists - Cercozoa"   ,
                "Heterotrophic protists - Ciliophora" ,
                "Heterotrophic protists - Eumycetozoa",
                "Heterotrophic protists - Evosea"     ,
                "Heterotrophic protists - Perkinsea"  ,
                "Heterotrophic protists - Rotifera"   ,
                "Zooplankton - Bosmina"               ,
                "Zooplankton - Chydoridae"            ,
                "Zooplankton - Cyclopidae"            ,
                "Zooplankton - Daphnia pulex"         ,
                "Zooplankton - Daphnia spp."          ,
                "Zooplankton - Hesperodiaptomus"      ,
                "Zooplankton - Holopedium"            ,
                "Zooplankton - Leptodiaptomus"
        )
)

avg_lake_50yrs<-all_trophic %>% 
        mutate(date_window_50yrs=cut(date_mid_AD_combo,
                        breaks = seq(1400, 2050, by = 50),
                        right=F, # intervals are left closed [1400,1450)
                        labels = paste(seq(1400, 2000, by = 50), 
                                       seq(1449, 2049, by = 50), sep = "-")))%>%
       group_by(trophic_level_tax_group, date_window_50yrs) %>% 
        summarize(avg_abund=mean(abundance),
                  median_year = median(as.numeric(unlist(strsplit(unique(as.character(date_window_50yrs)), "-"))))) %>%
        ungroup() %>%
        # the relative abundance for prior to 1400 is listed as NA - so remove it here
        filter(complete.cases(.))


ggplot(data=all_trophic, aes(x=date_mid_AD_combo, y=abundance, color=lake_name))+
  facet_wrap2(~ trophic_level_tax_group, nrow = 5, ncol = 4,
              strip = strip_themed(
                background_x = elem_list_rect(fill = c(rep("#33B58C", 4), rep("#85CFFF", 6), rep("#E07B33", 8))))) +
        geom_line() + 
        geom_line(data=avg_lake_50yrs, aes(x=median_year, y=avg_abund, color=NULL), linewidth=2, color="black")+
        custom_theme()+
        labs(color="Lake",
             y="Relative abundance (proportion)",
             x="Date (Common Era)")+
        scale_color_manual(values=lake_colors)+
        guides(color = guide_legend(override.aes = list(linewidth = 2))) 


ggsave("3_Figures/FigX_clustered_rel_abund_lake_all.png", height=10, width=20, units="in")
```

#### i. Stats for ms - avgs overall
##### L1 - phytoplankton
```{r}
phyto_LME<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_phytoplankton_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.05=="Yes") %>%  mutate(across(where(is.numeric), ~ round(.x, 3)))

# who is significant and strongly affected by anthropogenic stressors? 
phyto_LME %>% filter(pval0.05=="Yes" & Value > 0.04 | Value < (-0.04)) %>% pull(taxa) %>% unique(.)
# [1] "Chlorophyta"    "Dinoflagellata" "Gyrista"        "Streptophyta"  

## Chlorophyta ##

# Look at overall abundance over time
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Chlorophyta")

# average high prior to 1850
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Chlorophyta" & median_year < 1850) %>% pull(avg_abund) %>% mean(.) %>% round(.,digits=3) %>%   `*`(100) 
#[1] 46.8

# to low around 2000
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Chlorophyta" & median_year > 1850) %>% pull(avg_abund) %>% min(.) %>% round(.,digits=3) %>%   `*`(100) 
#[1] 46.8

phyto_LME %>% filter(taxa=="Chlorophyta") %>% select(term, Value, fish)
#                  term  Value     fish
# 1     Air temperature -0.085 Fishless
# 2 Nitrogen deposition -0.061 Fishless
# 3 Nitrogen deposition -0.029     Fish
# 4                Fish -0.104     Fish



## Dinoflagellata ##

# Look at overall abundance over time
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Dinoflagellata")

# average low prior to 18 decline around 1900
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Dinoflagellata" & median_year < 1900) %>% pull(avg_abund) %>% mean(.) %>% round(.,digits=3) %>%   `*`(100) 
#[1] 12.7

avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Dinoflagellata" & median_year > 1900) %>% pull(avg_abund) %>% max(.) %>% round(.,digits=3) %>%   `*`(100) 
#[1] 31.8

phyto_LME %>% filter(taxa=="Dinoflagellata") %>% select(term, Value, fish)
#                  term Value     fish
# 1 Nitrogen deposition 0.046 Fishless
# 2 Nitrogen deposition 0.063     Fish


## Gyrista ##

# Look at overall abundance over time
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Gyrista")

# average low prior to 18 decline around 1900
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Gyrista" & median_year < 1900) %>% pull(avg_abund) %>% mean(.) %>% round(.,digits=3) %>%   `*`(100) 
#[1]  23.5

avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Gyrista" & median_year > 1900) %>% pull(avg_abund) %>% max(.) %>% round(.,digits=3) %>%   `*`(100) 
#[1] 49.4

phyto_LME %>% filter(taxa=="Gyrista") %>% select(term, Value, fish)
#              term Value     fish
# 1 Air temperature 0.078 Fishless
# 2            Fish 0.085     Fish


## Streptophyta ##

# Look at overall abundance over time
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Streptophyta")

# average low prior to 18 decline around 1900
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Streptophyta" & median_year < 1900) %>% pull(avg_abund) %>% mean(.) %>% round(.,digits=3) %>%   `*`(100) 
#[1]  17.0

avg_lake_50yrs %>% filter(trophic_level_tax_group=="Phytoplankton - Streptophyta" & median_year > 1900) %>% pull(avg_abund) %>% min(.) %>% round(.,digits=3) %>%   `*`(100) 
#[1]  0.8

phyto_LME %>% filter(taxa=="Streptophyta") %>% select(term, Value, fish)
#                  term  Value     fish
# 1 Nitrogen deposition -0.042 Fishless
# 2 Nitrogen deposition -0.032     Fish

```

```{r}
nmds_values <-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_phyto.csv", header=T, row.names = 1) %>% 
        select(sample_id,
                MDS2,
                MDS1,
                d15N_anomaly_mean_1800_1850,
                mean_air_temp_degC_anomaly_combined,
                fish_present_binary_YN) %>% 
        left_join(., metadata %>% select(sample_id, state), join_by(sample_id))

# range of phytoplankton NMDS axis 1 (georaphic)
nmds_values %>% filter(state=="Washington") %>% pull(MDS1) %>% range(.) %>% round(digits=2)
# 0.36 1.32
nmds_values %>% filter(state=="California") %>% pull(MDS1) %>% range(.) %>% round(digits=2)
#[1] -1.43  0.46
nmds_values %>% filter(state=="Wyoming") %>% pull(MDS1) %>% range(.) %>% round(digits=2)
#[1] -1.43 -0.02

# homogenization
nmds_values %>% filter(MDS2>0) %>% pull(MDS1) %>% range(.) %>% round(digits=2) # historic communities
#-1.43  1.32
nmds_values %>% filter(MDS2<(-0.5)) %>% pull(MDS1) %>% range(.) %>% round(digits=2) # modern communities
# [1]  -0.91  0.78

# max diff lowest for WA

nmds_values %>% group_by(state) %>% 
        summarize(nmds_max = max(MDS2)-min(MDS2),
                  nit_max = max(d15N_anomaly_mean_1800_1850, na.rm=T) - min(d15N_anomaly_mean_1800_1850, na.rm=T),
                  temp_max = max(mean_air_temp_degC_anomaly_combined) - min(mean_air_temp_degC_anomaly_combined)) 

#   state      nmds_max nit_max temp_max
# 1 California     2.89    6.90     3.08
# 2 Washington     1.84    3.10     2.03
# 3 Wyoming        3.14    4.31     2.9 
```


##### L2 - heterotrophic protists and rotifers
```{r}
hetero_LME<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_heterotrophic_protists_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.05=="Yes") %>%  mutate(across(where(is.numeric), ~ round(.x, 3)))

# who is significant and strongly affected by anthropogenic stressors? 
hetero_LME %>% filter(pval0.05=="Yes" & Value > 0.04 | Value < (-0.04)) %>% pull(taxa) %>% unique(.)
# "Ciliophora"

## Ciliophora ##

# Look at overall abundance over time
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Heterotrophic protists - Ciliophora")
#    trophic_level_tax_group             date_window_50yrs avg_abund median_year
#  1 Heterotrophic protists - Ciliophora 1400-1449             0.165       1424.
#  2 Heterotrophic protists - Ciliophora 1450-1499             0.158       1474.
#  3 Heterotrophic protists - Ciliophora 1500-1549             0.116       1524.
#  4 Heterotrophic protists - Ciliophora 1550-1599             0.181       1574.
#  5 Heterotrophic protists - Ciliophora 1600-1649             0.220       1624.
#  6 Heterotrophic protists - Ciliophora 1650-1699             0.221       1674.
#  7 Heterotrophic protists - Ciliophora 1700-1749             0.241       1724.
#  8 Heterotrophic protists - Ciliophora 1750-1799             0.277       1774.
#  9 Heterotrophic protists - Ciliophora 1800-1849             0.311       1824.
# 10 Heterotrophic protists - Ciliophora 1850-1899             0.316       1874.
# 11 Heterotrophic protists - Ciliophora 1900-1949             0.390       1924.
# 12 Heterotrophic protists - Ciliophora 1950-1999             0.446       1974.
# 13 Heterotrophic protists - Ciliophora 2000-2049             0.505       2024.


hetero_LME %>% filter(taxa=="Ciliophora") %>% select(term, Value, fish)

#                  term Value fish
# 1 Nitrogen deposition 0.039 Fish
# 2                Fish 0.097 Fish


```


```{r}
nmds_values <-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_hetero_prot.csv", header=T, row.names = 1) %>% 
        select(sample_id,
                MDS2,
                MDS1,
                d15N_anomaly_mean_1800_1850,
                mean_air_temp_degC_anomaly_combined,
                fish_present_binary_YN) %>% 
        left_join(., metadata %>% select(sample_id, state), join_by(sample_id))

# range of heterotrophic protists and rotifers NMDS axis 1 (geographic)
nmds_values %>% filter(state=="Washington") %>% pull(MDS1) %>% range(.) %>% round(digits=2)
# [1] -1.08  0.41
nmds_values %>% filter(state%in% c("California","Wyoming")) %>% pull(MDS1) %>% range(.) %>% round(digits=2)
#[1] -1.43  0.46


# homogenization
nmds_values %>% filter(MDS2>0) %>% pull(MDS1) %>% range(.) %>% round(digits=2) # historic communities
# -1.08  1.25
nmds_values %>% filter(MDS2<(-0.5)) %>% pull(MDS1) %>% range(.) %>% round(digits=2) # modern communities
# [1]  -0.80  0.39

# max diff lowest for WA

nmds_values %>% group_by(state) %>% 
        summarize(nmds_max = max(MDS2)-min(MDS2),
                  nit_max = max(d15N_anomaly_mean_1800_1850, na.rm=T) - min(d15N_anomaly_mean_1800_1850, na.rm=T),
                  temp_max = max(mean_air_temp_degC_anomaly_combined) - min(mean_air_temp_degC_anomaly_combined)) 

#   state      nmds_max nit_max temp_max
#   <chr>         <dbl>   <dbl>    <dbl>
# 1 California     1.73    6.90     3.08
# 2 Washington     1.71    3.10     2.03
# 3 Wyoming        1.69    4.31     2.9
```



##### L3 - zooplankton
```{r}
zoop_LME<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/V9_LME_zooplankton_model_output_no_interactions.csv", header=T, row.names=1) %>% filter(pval0.05=="Yes") %>%  mutate(across(where(is.numeric), ~ round(.x, 3)))

# who is significant and strongly affected by anthropogenic stressors? 
zoop_LME %>% filter(pval0.05=="Yes" & Value > 0.04 | Value < (-0.04)) %>% pull(taxa) %>% unique(.)
#[1] "Hesperodiaptomus" "Daphnia spp."     "Leptodiaptomus" 

## Hesperodiaptomus ##

# Look at overall abundance over time
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Hesperodiaptomus")
#    trophic_level_tax_group        date_window_50yrs avg_abund median_year
#  1 Zooplankton - Hesperodiaptomus 1400-1449             0.891       1424.
#  2 Zooplankton - Hesperodiaptomus 1450-1499             0.920       1474.
#  3 Zooplankton - Hesperodiaptomus 1500-1549             0.972       1524.
#  4 Zooplankton - Hesperodiaptomus 1550-1599             0.979       1574.
#  5 Zooplankton - Hesperodiaptomus 1600-1649             0.726       1624.
#  6 Zooplankton - Hesperodiaptomus 1650-1699             0.747       1674.
#  7 Zooplankton - Hesperodiaptomus 1700-1749             0.875       1724.
#  8 Zooplankton - Hesperodiaptomus 1750-1799             0.809       1774.
#  9 Zooplankton - Hesperodiaptomus 1800-1849             0.894       1824.
# 10 Zooplankton - Hesperodiaptomus 1850-1899             0.752       1874.
# 11 Zooplankton - Hesperodiaptomus 1900-1949             0.623       1924.
# 12 Zooplankton - Hesperodiaptomus 1950-1999             0.451       1974.
# 13 Zooplankton - Hesperodiaptomus 2000-2049             0.342       2024.


avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Hesperodiaptomus") %>% filter(median_year<1900) %>% pull(avg_abund) %>% mean(.) %>% round(digits=3) %>%  `*`(100) 
# [1] 85.6

zoop_LME %>% filter(taxa=="Hesperodiaptomus") %>% select(term, Value, fish)
#              term  Value     fish
# 1 Air temperature -0.111 Fishless
# 2            Fish -0.329     Fish



## Daphnia spp. ##

# Look at overall abundance over time
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Daphnia spp.")
#    trophic_level_tax_group    date_window_50yrs avg_abund median_year
#  1 Zooplankton - Daphnia spp. 1400-1449         0.0000716       1424.
#  2 Zooplankton - Daphnia spp. 1450-1499         0.000409        1474.
#  3 Zooplankton - Daphnia spp. 1500-1549         0.000339        1524.
#  4 Zooplankton - Daphnia spp. 1550-1599         0.00105         1574.
#  5 Zooplankton - Daphnia spp. 1600-1649         0.0204          1624.
#  6 Zooplankton - Daphnia spp. 1650-1699         0.0153          1674.
#  7 Zooplankton - Daphnia spp. 1700-1749         0.0106          1724.
#  8 Zooplankton - Daphnia spp. 1750-1799         0.00826         1774.
#  9 Zooplankton - Daphnia spp. 1800-1849         0.00741         1824.
# 10 Zooplankton - Daphnia spp. 1850-1899         0.00826         1874.
# 11 Zooplankton - Daphnia spp. 1900-1949         0.0471          1924.
# 12 Zooplankton - Daphnia spp. 1950-1999         0.171           1974.
# 13 Zooplankton - Daphnia spp. 2000-2049         0.185           2024.

avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Daphnia spp.") %>% filter(median_year<1900) %>% pull(avg_abund) %>% mean(.) %>% round(digits=3) %>%  `*`(100) 
#[1] 0.7

avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Daphnia spp.") %>% filter(median_year>2000) %>% pull(avg_abund) %>% mean(.) %>% round(digits=3) %>%  `*`(100) 
#[1] 18.5

zoop_LME %>% filter(taxa=="Daphnia spp.") %>% select(term, Value, fish)
#                  term Value fish
# 1 Nitrogen deposition 0.071 Fish
# 2                Fish 0.119 Fish



## Leptodiaptomus ##

# Look at overall abundance over time
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Leptodiaptomus")
#    trophic_level_tax_group      date_window_50yrs avg_abund median_year
#  1 Zooplankton - Leptodiaptomus 1400-1449           0.00416       1424.
#  2 Zooplankton - Leptodiaptomus 1450-1499           0.0296        1474.
#  3 Zooplankton - Leptodiaptomus 1500-1549           0.0105        1524.
#  4 Zooplankton - Leptodiaptomus 1550-1599           0.00498       1574.
#  5 Zooplankton - Leptodiaptomus 1600-1649           0.212         1624.
#  6 Zooplankton - Leptodiaptomus 1650-1699           0.163         1674.
#  7 Zooplankton - Leptodiaptomus 1700-1749           0.0735        1724.
#  8 Zooplankton - Leptodiaptomus 1750-1799           0.0860        1774.
#  9 Zooplankton - Leptodiaptomus 1800-1849           0.0308        1824.
# 10 Zooplankton - Leptodiaptomus 1850-1899           0.117         1874.
# 11 Zooplankton - Leptodiaptomus 1900-1949           0.181         1924.
# 12 Zooplankton - Leptodiaptomus 1950-1999           0.177         1974.
# 13 Zooplankton - Leptodiaptomus 2000-2049           0.152         2024.

avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Leptodiaptomus") %>% pull(avg_abund) %>% mean(.) %>% round(digits=3) %>%  `*`(100) 
#[1] 9.6

avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Leptodiaptomus") %>% pull(avg_abund) %>% range(.) %>% round(digits=3) %>%  `*`(100) 
#[1]  0.4 21.2


zoop_LME %>% filter(taxa=="Leptodiaptomus") %>% select(term, Value, fish)
#                  term  Value fish
# 1 Nitrogen deposition -0.063 Fish



```


```{r}
nmds_values <-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/PhytoZoopSedDNA/2_DataAnalysis/NMDS_zoop.csv", header=T, row.names = 1) %>% 
        select(sample_id,
                MDS2,
                MDS1,
                d15N_anomaly_mean_1800_1850,
                mean_air_temp_degC_anomaly_combined,
                fish_present_binary_YN) %>% 
        left_join(., metadata %>% select(sample_id, state, date_mid_AD_combo), join_by(sample_id))


# Hard to isolate these different clusters, made generalizations about large clusters of fish and fishless samples for results and used ranges below:
nmds_values %>% pull(MDS2) %>% range(.) %>% round(digits=2)


nmds_values %>% group_by(state) %>%
        summarize(nmds_max = max(MDS1)-min(MDS1),
                  nit_max = max(d15N_anomaly_mean_1800_1850, na.rm=T) - min(d15N_anomaly_mean_1800_1850, na.rm=T),
                  temp_max = max(mean_air_temp_degC_anomaly_combined) - min(mean_air_temp_degC_anomaly_combined))

#   state      nmds_max nit_max temp_max
#   <chr>         <dbl>   <dbl>    <dbl>
# 1 California     3.42    6.90     3.08
# 2 Washington     1.43    3.10     2.03
# 3 Wyoming        3.04    4.31     2.9 
```



### 2. Averages by fish status
for top taxa
```{r}
all_trophic_top$trophic_level_tax_group <- factor(
        all_trophic_top$trophic_level_tax_group,
        levels = c(
                "Phytoplankton - Chlorophyta",
                "Phytoplankton - Streptophyta",
                "Phytoplankton - Gyrista",
                "Phytoplankton - Dinoflagellata",
                "Heterotrophic protists - Ciliophora",
                "Zooplankton - Leptodiaptomus",
                "Zooplankton - Hesperodiaptomus",
                "Zooplankton - Daphnia spp."))


lake_colors_fish <- c("Crescent" = "gold3", 
                 "Canyon" = "gold3", 
                 "Eyrie" = "gold3",
                 "Lightning" = "gold3",
                 "Soldier" = "gold3", 
                 "Skelton" = "gold3", 
                  "Louise" = "palevioletred3",
                 "Monogram" = "palevioletred3",
                 "Scott" = "palevioletred3",
                 "Black Rock" = "palevioletred3",
                 "Footprint" = "palevioletred3",
                 "Lost" = "palevioletred3",
                 "Bullfrog" = "palevioletred3",
                 "Middle Gaylor"= "palevioletred3")

all_trophic_top$lake_name_fish<-factor(all_trophic_top$lake_name, levels=names(lake_colors_fish))


# Below I changed the summarize to be the median OR I removed lightning and eyrie and did the mean

# remove lightning and eyrie
all_trophic_top <- all_trophic_top %>% filter(!lake_name%in%c("Eyrie", "Lightning"))

avg_lake_50yrs<-all_trophic_top %>% 
        mutate(date_window_50yrs=cut(date_mid_AD_combo,
                        breaks = seq(1400, 2050, by = 50),
                        right=F, # intervals are left closed [1400,1450)
                        labels = paste(seq(1400, 2000, by = 50), 
                                       seq(1449, 2049, by = 50), sep = "-")))%>%
       group_by(trophic_level_tax_group, date_window_50yrs, fish) %>% 
        summarize(avg_abund=mean(abundance),
                  median_year = median(as.numeric(unlist(strsplit(unique(as.character(date_window_50yrs)), "-"))))) %>%
        ungroup() %>% 
        # the relative abundance for prior to 1400 is listed as NA - so remove it here
        filter(complete.cases(.))


ggplot(data=all_trophic_top, aes(x=date_mid_AD_combo, y=abundance, color=lake_name_fish))+
        facet_wrap2(~ trophic_level_tax_group, nrow = 4, ncol = 2,
                    strip = strip_themed(
    background_x = elem_list_rect(fill = c(rep("#33B58C",4), rep("#85CFFF",1), rep("#E07B33",3)))))+
        geom_line(alpha = 0.6) + 
        geom_line(data=avg_lake_50yrs %>% filter(fish==1), aes(x=median_year, y=avg_abund, color=NULL), linewidth=2, color="palevioletred3")+
        geom_line(data=avg_lake_50yrs %>% filter(fish==0), aes(x=median_year, y=avg_abund, color=NULL), linewidth=2, color="gold3")+
        custom_theme()+
        labs(color="Lake",
             y="Relative abundance (proportion)",
             x="Date (Common Era)")+
        scale_color_manual(values=lake_colors_fish)+
        theme(legend.position = "none")


ggsave("3_Figures/FigX_clustered_rel_abund_lake_fish_top_median.png", height=6.5, width=7, units="in")




# # just make the legend for cropping
# legend_data <- data.frame(
#   fish_status = c("Fish", "Fishless"),
#   x = c(min(all_trophic$date_mid_AD_combo) - 100, min(all_trophic$date_mid_AD_combo) - 100),
#   y = c(min(all_trophic$abundance) - 10, min(all_trophic$abundance) - 10)
# )
# 
# ggplot(data = all_trophic, aes(x = date_mid_AD_combo, y = abundance, color = lake_name_fish)) +
#   facet_wrap2(~ trophic_level_tax_group, nrow = 10, ncol = 2,
#               strip = strip_themed(
#                 background_x = elem_list_rect(fill = c(rep("#33B58C",4), rep("#85CFFF",1), rep("#E07B33",3)))
#               )) +
#   geom_line(alpha = 0.6) +
#   # Add Fish & Fishless lines (without affecting color legend)
#   geom_line(data = avg_lake_50yrs %>% filter(fish == 1), aes(x = median_year, y = avg_abund),
#             linewidth = 2, color = "palevioletred3") +
#   geom_line(data = avg_lake_50yrs %>% filter(fish == 0), aes(x = median_year, y = avg_abund),
#             linewidth = 2, color = "gold3") +
#   # Add dummy lines for the legend
#   geom_line(data = legend_data, aes(x = x, y = y, color = fish_status), linewidth = 2) +
#   custom_theme() +
#   labs(color = "", y = "Relative abundance (proportion)", x = "Date (Common Era)") +
#   scale_color_manual(
#     values = c(lake_colors_fish, "Fishless" = "gold3","Fish" = "palevioletred3"),
#     breaks = c( "Fishless","Fish")
#   ) +
#   guides(color = guide_legend(override.aes = list(linetype = 1, size = 2)))
# ggsave("3_Figures/FigX_clustered_rel_abund_lake_fish_avg_50yrs_legend.png", height=5, width=6, units="in")
```

#### i. Stats for ms - fish vs fishless
##### L3 Zooplankton
```{r}
### Hesperodiaptomus ### 
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Hesperodiaptomus" & fish ==0)
#    trophic_level_tax_group        date_window_50yrs  fish avg_abund median_year
#    <fct>                          <fct>             <dbl>     <dbl>       <dbl>
#  1 Zooplankton - Hesperodiaptomus 1400-1449             0     0.800       1424.
#  2 Zooplankton - Hesperodiaptomus 1450-1499             0     0.904       1474.
#  3 Zooplankton - Hesperodiaptomus 1500-1549             0     0.956       1524.
#  4 Zooplankton - Hesperodiaptomus 1550-1599             0     0.985       1574.
#  5 Zooplankton - Hesperodiaptomus 1600-1649             0     0.941       1624.
#  6 Zooplankton - Hesperodiaptomus 1650-1699             0     0.887       1674.
#  7 Zooplankton - Hesperodiaptomus 1700-1749             0     0.970       1724.
#  8 Zooplankton - Hesperodiaptomus 1750-1799             0     0.984       1774.
#  9 Zooplankton - Hesperodiaptomus 1800-1849             0     0.976       1824.
# 10 Zooplankton - Hesperodiaptomus 1850-1899             0     0.942       1874.
# 11 Zooplankton - Hesperodiaptomus 1900-1949             0     0.947       1924.
# 12 Zooplankton - Hesperodiaptomus 1950-1999             0     0.891       1974.
# 13 Zooplankton - Hesperodiaptomus 2000-2049             0     0.690       2024.

avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Hesperodiaptomus" & fish ==0) %>% filter(median_year<2000) %>% pull(avg_abund) %>% mean(.) %>% round(digits=3) %>%  `*`(100) 
#93.2


avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Hesperodiaptomus" & fish ==1)
#    trophic_level_tax_group        date_window_50yrs  fish avg_abund median_year
#    <fct>                          <fct>             <dbl>     <dbl>       <dbl>
#  1 Zooplankton - Hesperodiaptomus 1400-1449             1     0.982       1424.
#  2 Zooplankton - Hesperodiaptomus 1450-1499             1     0.934       1474.
#  3 Zooplankton - Hesperodiaptomus 1500-1549             1     0.983       1524.
#  4 Zooplankton - Hesperodiaptomus 1550-1599             1     0.972       1574.
#  5 Zooplankton - Hesperodiaptomus 1600-1649             1     0.577       1624.
#  6 Zooplankton - Hesperodiaptomus 1650-1699             1     0.670       1674.
#  7 Zooplankton - Hesperodiaptomus 1700-1749             1     0.827       1724.
#  8 Zooplankton - Hesperodiaptomus 1750-1799             1     0.687       1774.
#  9 Zooplankton - Hesperodiaptomus 1800-1849             1     0.806       1824.
# 10 Zooplankton - Hesperodiaptomus 1850-1899             1     0.586       1874.
# 11 Zooplankton - Hesperodiaptomus 1900-1949             1     0.421       1924.
# 12 Zooplankton - Hesperodiaptomus 1950-1999             1     0.225       1974.
# 13 Zooplankton - Hesperodiaptomus 2000-2049             1     0.205       2024.


avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Hesperodiaptomus" & fish ==1) %>% filter(median_year<1900) %>% pull(avg_abund) %>% mean(.) %>% round(digits=3) %>%  `*`(100) 
# [1] 80.2

### Daphina spp. ###
avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Daphnia spp." & fish ==0)
#    trophic_level_tax_group    date_window_50yrs  fish avg_abund median_year
#    <fct>                      <fct>             <dbl>     <dbl>       <dbl>
#  1 Zooplankton - Daphnia spp. 1400-1449             0  0.000143       1424.
#  2 Zooplankton - Daphnia spp. 1450-1499             0  0.000644       1474.
#  3 Zooplankton - Daphnia spp. 1500-1549             0  0.000827       1524.
#  4 Zooplankton - Daphnia spp. 1550-1599             0  0.00182        1574.
#  5 Zooplankton - Daphnia spp. 1600-1649             0  0.0461         1624.
#  6 Zooplankton - Daphnia spp. 1650-1699             0  0.0103         1674.
#  7 Zooplankton - Daphnia spp. 1700-1749             0  0.00420        1724.
#  8 Zooplankton - Daphnia spp. 1750-1799             0  0.00176        1774.
#  9 Zooplankton - Daphnia spp. 1800-1849             0  0.00606        1824.
# 10 Zooplankton - Daphnia spp. 1850-1899             0  0.00801        1874.
# 11 Zooplankton - Daphnia spp. 1900-1949             0  0.00410        1924.
# 12 Zooplankton - Daphnia spp. 1950-1999             0  0.00433        1974.
# 13 Zooplankton - Daphnia spp. 2000-2049             0  0.000455       2024.


avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Daphnia spp." & fish ==0)  %>% pull(avg_abund) %>% mean(.) %>% round(digits=4) %>%  `*`(100) 
#[1] 0.7 or 0.68


avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Daphnia spp." & fish ==1)
#    trophic_level_tax_group    date_window_50yrs  fish avg_abund median_year
#    <fct>                      <fct>             <dbl>     <dbl>       <dbl>
#  1 Zooplankton - Daphnia spp. 1400-1449             1 0               1424.
#  2 Zooplankton - Daphnia spp. 1450-1499             1 0.000208        1474.
#  3 Zooplankton - Daphnia spp. 1500-1549             1 0.0000350       1524.
#  4 Zooplankton - Daphnia spp. 1550-1599             1 0.000139        1574.
#  5 Zooplankton - Daphnia spp. 1600-1649             1 0.00263         1624.
#  6 Zooplankton - Daphnia spp. 1650-1699             1 0.0181          1674.
#  7 Zooplankton - Daphnia spp. 1700-1749             1 0.0139          1724.
#  8 Zooplankton - Daphnia spp. 1750-1799             1 0.0128          1774.
#  9 Zooplankton - Daphnia spp. 1800-1849             1 0.00886         1824.
# 10 Zooplankton - Daphnia spp. 1850-1899             1 0.00847         1874.
# 11 Zooplankton - Daphnia spp. 1900-1949             1 0.0740          1924.
# 12 Zooplankton - Daphnia spp. 1950-1999             1 0.256           1974.
# 13 Zooplankton - Daphnia spp. 2000-2049             1 0.257           2024.


avg_lake_50yrs %>% filter(trophic_level_tax_group=="Zooplankton - Daphnia spp." & fish ==1) %>% filter(median_year<1900) %>% pull(avg_abund) %>% mean(.) %>% round(digits=4) %>%  `*`(100) 
# 0.7 or 0.65

```


### 3. Averages by state
top taxa

Here I have changed it so that the bullfrog and middle gaylor lakes for leptodiaptomus plot separately 
```{r}
all_trophic_top$trophic_level_tax_group <- factor(
        all_trophic_top$trophic_level_tax_group,
        levels = c(
                "Phytoplankton - Chlorophyta",
                "Phytoplankton - Streptophyta",
                "Phytoplankton - Gyrista",
                "Phytoplankton - Dinoflagellata",
                "Heterotrophic protists - Ciliophora",
                "Zooplankton - Leptodiaptomus",
                "Zooplankton - Hesperodiaptomus",
                "Zooplankton - Daphnia spp."))

lake_colors_state <- c("Crescent" = "orange", 
                 "Canyon" = "#008080", 
                 "Eyrie" = "#008080",
                 "Lightning" = "#008080",
                 "Soldier" =  "#5D478B", 
                 "Skelton" =  "#5D478B", 
                  "Louise" = "orange",
                 "Monogram" = "orange",
                 "Scott" = "#008080",
                 "Black Rock" = "#008080",
                 "Footprint" = "#008080",
                 "Lost" = "#008080",
                 "Bullfrog" =  "#5D478B",
                 "Middle Gaylor"=  "#5D478B")

# make two line types depending on whether leptodiaptomus is bullfrog or middle gaylor

all_trophic_top <- all_trophic_top %>% mutate(state_split = case_when(lake_name%in%c("Bullfrog","Middle Gaylor")~ "California_lepto",
                                                           !lake_name%in%c("Bullfrog","Middle Gaylor")~state))

all_trophic_top$lake_name_state<-factor(all_trophic_top$lake_name, levels=names(lake_colors_state))

avg_lake_50yrs<-all_trophic_top %>% 
        mutate(date_window_50yrs=cut(date_mid_AD_combo,
                        breaks = seq(1400, 2050, by = 50),
                        right=F, # intervals are left closed [1400,1450)
                        labels = paste(seq(1400, 2000, by = 50), 
                                       seq(1449, 2049, by = 50), sep = "-")))%>%
       group_by(trophic_level_tax_group, date_window_50yrs, state_split) %>% 
        summarize(avg_abund=mean(abundance),
                  median_year = median(as.numeric(unlist(strsplit(unique(as.character(date_window_50yrs)), "-"))))) %>% 
        ungroup() %>% 
        # the relative abundance for prior to 1400 is listed as NA - so remove it here
        filter(complete.cases(.)) %>%
        # add back in state and state color
        left_join(., all_trophic_top %>% select(state, state_split) %>% distinct(.), join_by(state_split))



ggplot(data = all_trophic_top, aes(x = date_mid_AD_combo, y = abundance, color = lake_name_state)) +
  facet_wrap2(~ trophic_level_tax_group, nrow = 4, ncol = 2,
              strip = strip_themed(
                background_x = elem_list_rect(fill = c(rep("#33B58C", 4), rep("#85CFFF", 1), rep("#E07B33", 3))))) +
  geom_line(alpha = 0.6) +
    geom_line(data = avg_lake_50yrs, aes(x = median_year, y = avg_abund, color = state, linetype = state_split), linewidth = 2) +
  custom_theme() +
  labs(color = "Lake (transparent)
and state (solid)",
       y = "Relative abundance (proportion)",
       x = "Date (Common Era)") +
  scale_color_manual(values = c(lake_colors_state, 
                                "Washington" = "orange",
                                "Wyoming" = "#008080",
                                "California" = "#5D478B")) + 
  scale_linetype_manual(values = c("California_lepto" = "dashed", 
                                   "California" = "solid", 
                                   "Washington" = "solid", 
                                   "Wyoming" = "solid")) +
  guides(color = guide_legend(override.aes = list(linewidth = 2))) 


ggsave("3_Figures/FigX_clustered_rel_abund_lake_state_top_legend.png", height=6.5, width=9,  units="in")

ggplot(data = all_trophic_top, aes(x = date_mid_AD_combo, y = abundance, color = lake_name_state)) +
  facet_wrap2(~ trophic_level_tax_group, nrow = 4, ncol = 2,
              strip = strip_themed(
                background_x = elem_list_rect(fill = c(rep("#33B58C", 4), rep("#85CFFF", 1), rep("#E07B33", 3))))) +
  geom_line(alpha = 0.6) +
    geom_line(data = avg_lake_50yrs, aes(x = median_year, y = avg_abund, color = state, linetype = state_split), linewidth = 2) +
  custom_theme() +
  labs(color = "Lake (transparent)
and state (solid)",
       y = "Relative abundance (proportion)",
       x = "Date (Common Era)") +
  scale_color_manual(values = c(lake_colors_state, 
                                "Washington" = "orange",
                                "Wyoming" = "#008080",
                                "California" = "#5D478B")) + 
          scale_linetype_manual(values = c("California_lepto" = "dashed", 
                                   "California" = "solid", 
                                   "Washington" = "solid", 
                                   "Wyoming" = "solid")) +
        theme(legend.position = "none")


ggsave("3_Figures/FigX_clustered_rel_abund_lake_state_top_split_for_lepto.png", height=6.5, width=7,  units="in")

```


all taxa
```{r}
all_trophic$trophic_level_tax_group <- factor(
        all_trophic$trophic_level_tax_group,
        levels = c(
                "Phytoplankton - Chlorophyta"         ,
                "Phytoplankton - Dinoflagellata"      ,
                "Phytoplankton - Gyrista"             ,
                "Phytoplankton - Streptophyta"        ,
                "Heterotrophic protists - Cercozoa"   ,
                "Heterotrophic protists - Ciliophora" ,
                "Heterotrophic protists - Eumycetozoa",
                "Heterotrophic protists - Evosea"     ,
                "Heterotrophic protists - Perkinsea"  ,
                "Heterotrophic protists - Rotifera"   ,
                "Zooplankton - Bosmina"               ,
                "Zooplankton - Chydoridae"            ,
                "Zooplankton - Cyclopidae"            ,
                "Zooplankton - Daphnia pulex"         ,
                "Zooplankton - Daphnia spp."          ,
                "Zooplankton - Hesperodiaptomus"      ,
                "Zooplankton - Holopedium"            ,
                "Zooplankton - Leptodiaptomus"
        )
)


all_trophic$lake_name_state<-factor(all_trophic$lake_name, levels=names(lake_colors_state))

avg_lake_50yrs<-all_trophic %>% 
        mutate(date_window_50yrs=cut(date_mid_AD_combo,
                        breaks = seq(1400, 2050, by = 50),
                        right=F, # intervals are left closed [1400,1450)
                        labels = paste(seq(1400, 2000, by = 50), 
                                       seq(1449, 2049, by = 50), sep = "-")))%>%
       group_by(trophic_level_tax_group, date_window_50yrs, state) %>% 
        summarize(avg_abund=mean(abundance),
                  median_year = median(as.numeric(unlist(strsplit(unique(as.character(date_window_50yrs)), "-"))))) %>% 
        ungroup() %>% 
        # the relative abundance for prior to 1400 is listed as NA - so remove it here
        filter(complete.cases(.))



ggplot(data = all_trophic, aes(x = date_mid_AD_combo, y = abundance, color = lake_name)) +
  facet_wrap2(~ trophic_level_tax_group, nrow = 5, ncol = 4,
              strip = strip_themed(
                background_x = elem_list_rect(fill = c(rep("#33B58C", 4), rep("#85CFFF", 6), rep("#E07B33", 8))))) +
  geom_line(alpha = 0.6) +
    geom_line(data = avg_lake_50yrs, aes(x = median_year, y = avg_abund, color = state), linewidth = 2) +
  custom_theme() +
  labs(color = "Lake (transparent)
and state (solid)",
       y = "Relative abundance (proportion)",
       x = "Date (Common Era)") +
  scale_color_manual(values = c(lake_colors, 
                                "Washington" = "orange",
                                "Wyoming" = "#008080",
                                "California" = "#5D478B")) + 
  guides(color = guide_legend(override.aes = list(linewidth = 2))) 


ggsave("3_Figures/FigX_clustered_rel_abund_lake_state_all.png", height=10, width=20, units="in")

```



---
title: "Phytoplankton and zooplankton sedimentary DNA from Western United States"
author: "Jordan Von Eggers"
date: "`r Sys.Date()`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

# 0. Load packages, custom theme, color, and data
```{r}
require(ggh4x) # facet_wrap2
require(lubridate) # julian date in modelling 210Pb
require(phyloseq)
require(patchwork) # if end up patching figures
require(Biostrings) # for blasting Zooplankton
require(strucchange) # breakpoint analysis 
library(nlme) # linear mixed effects models
require(tidyverse)
```


```{r}
custom_theme <- function() {
  theme_bw() +
    theme(
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),  
      text = element_text(color = "black", size = 13),
      axis.text = element_text(color = "black",size = 13),
      axis.title = element_text(color = "black",size = 13),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 12),
      legend.text = element_text(size = 13),
      legend.title = element_text(size = 13,hjust = 0.5),
      strip.text = element_text(size = 13, color = "black"))}

# set colors for lakes
lake_colors <- c("Canyon" = "#b9ceac", "Eyrie" = "darkolivegreen3", "Lightning" = "darkolivegreen", 
                 "Black Rock" = "#FFBBFF", "Footprint" = "#CD96CD", "Lost" = "#9696CD", "Scott" = "#5D478B", 
                 "Bullfrog"= "#BFEFFF", "Middle Gaylor"= "#008080", "Soldier"="#0e4d92", "Skelton"="#63B8FF", 
                 "Crescent"= "#EE6363", "Louise"="#FFA07A","Monogram"="#EE30A7")

lake_colors_2 <- c(
        "Canyon" = "#b9ceac",
        "Bullfrog" = "#BFEFFF",
        "Eyrie" = "darkolivegreen3",
        "Middle Gaylor" = "#008080",
        "Lightning" = "darkolivegreen",
        "Soldier" = "#0e4d92",
        "Black Rock" = "#FFBBFF",
        "Skelton" = "#63B8FF",
        "Footprint" = "#CD96CD",
        "Crescent" = "#EE6363",
        "Lost" = "#9696CD",
        "Louise" = "#FFA07A",
        "Scott" = "#5D478B",
        "Monogram" = "#EE30A7"
)


source("1_LoadData/1_CreatePhyloseq_ZOTUexact_TAX80.R")
```


# 1. Compile sample metadata
```{r}
# biogenic silica and C-H measurements

# here I am reading in the sample list to help create unique biogenic silica error and C-H error measurements per lake. 
sample_list <- read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/Core and sample information/Master/2024-10-10_MASTER_sample_id_list.csv") 
bisi<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/Biogenic silica/results/MASTER_BiogenicSilica_FTIR_measurements.csv", header = T) %>% left_join(.,sample_list, by=join_by(sample_id)) %>% select(sample_id, replicate, FTIR_measurement, FTIR_value, lake_name) 

bisi <- bisi %>%
        group_by(sample_id) %>%
        filter(all(c("R2", "R3") %in% replicate)) %>%
        ungroup() %>%
        group_by(sample_id, lake_name, FTIR_measurement) %>%
        summarize(
                range_FTIR_value = max(FTIR_value) - min(FTIR_value),
                .groups = 'drop' ) %>%
        group_by(lake_name, FTIR_measurement) %>%
        summarize(
                mean_range_FTIR_value = mean(range_FTIR_value),
                max_range_FTIR_value = max(range_FTIR_value),
                .groups = 'drop' ) %>%
        # merge summary back into data
        left_join(bisi,., by=join_by(lake_name, FTIR_measurement)) %>% 
        # get the average for each sample and measurement for the replicates
        group_by(sample_id,FTIR_measurement) %>% mutate(mean_FTIR_value=mean(FTIR_value)) %>% ungroup() %>% select(-c(FTIR_value, replicate)) %>% distinct(.) %>% left_join(.,sample_list, by=join_by(sample_id, lake_name)) %>% select(-c(lake_name,full_sample_code,lake_code,mountain_code,core,drive,top_cm,bottom_cm,mid_cm,rep_or_note)) %>%
  pivot_wider(
    names_from = FTIR_measurement, 
    values_from = c(mean_range_FTIR_value, max_range_FTIR_value, mean_FTIR_value),
    names_sep = "_"
  ) %>%  rename_with(~ gsub("FTIR_value_", "", .)) %>% rename_with(~ gsub("BSi", "BiSi", .))


table(bisi$sample_id%in%sample_list$sample_id) # all T
metadata<-left_join(sample_list,bisi, join_by(sample_id)); rm(sample_list); rm(bisi)

# 210Pb data
pb<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/210Pb dating/210lead results/MASTER_2024-09-24_210Pb_2020_2021_cores.csv", header=T)
table(pb$sample_id%in%metadata$sample_id) # all T
metadata<-left_join(metadata,pb, join_by(sample_id)); rm(pb)

# stable isotope data

iso<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/Stable isotopes/SIF_results/MASTER_stable_isotopes_2020_2021_cores.csv") 
table(iso$sample_id%in%metadata$sample_id) # all T
metadata<-left_join(metadata,iso, join_by(sample_id)); rm(iso)

        # calculate difference from starting value for d15N data
d15N_start_summary<-metadata %>% group_by(lake_name) %>%
        filter(is.na(d15N)==F) %>%
        summarize(d15N_start = d15N[which.max(bottom_cm)]) %>% ungroup()

        # add back in to metadata
metadata <- left_join(metadata,d15N_start_summary, join_by(lake_name)) %>%
        mutate(d15N_diff_from_start=d15N-d15N_start); rm(d15N_start_summary)

# LOI data
loi<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/Subsampling and LOI/MASTER_loss_on_ignition_2015_2019-2021_cores.csv") %>% filter(mountain_lake_code%in%c("SNOW20_LOST20_1A_1G", "SNOW20_SCOT20_1A_1G","WIND20_BLRO20_1A_1G", "WIND20_CANY20_1A_1G" ,"WIND20_EYRI20_1A_1G", "WIND20_FOOT20_1A_1G","WIND20_LIGH20_1A_1G", "MORA21_CRES21_1A_1G", "MORA21_LOUI21_1A_1G",
"NOCA21_MONO21_1A_1G", "SEKI21_BULL21_2A_1G", "YOSE21_MIGA21_1A_1G", "YOSE21_SKEL21_1A_1G", "YOSE21_SOLD21_1A_1G")) %>% select(-c(top_cm,bottom_cm,full_sample_code, year_cored))
table(loi$sample_id%in%metadata$sample_id) # all T
setdiff(loi$sample_id, metadata$sample_id) # these two samples were combined into SOLD21_0to1 so OK!
metadata<-left_join(metadata,loi, join_by(sample_id)); rm(loi)

# lake data
lake<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/Core and sample information/Master/2024-10-10_MASTER_lake_data.csv")
table(lake$lake_name%in%metadata$lake_name) # all T
metadata<-left_join(metadata,lake, join_by(lake_name)); rm(lake)

# remove lakes not included in this study
metadata<-metadata %>% filter(!lake_name %in% c("Green Park Lake","Solitude", "Delta", "Lake of the Crags")) %>% filter(!sample_id%in% c("SOLD21_0to1","SOLD21_1.5"))
```
660 samples from 14 lakes (removed two samples from Soldier lake that were too watery to do any analyses on)

# 2. Model 210Pb dating and add more metadata

Here I am:
1. using Loess line to interpolate samples that did not have 210Pb measured but were within the range of 210Pb dating measurements
2. extrapolating past the range of 210Pb dating using the dry mass accumulation rate (DMAR)
3. creating three final columns that are a combination of the measured 210Pb dates, the interpolated dates, and extrapolated dates. 


```{r}
# indicate if 210Pb was measured for the sample
pb <- metadata %>% mutate(lead210_measured=ifelse(is.na(lead210_measured)==T,"n","y"))

# remove the bottom Soldier sample dating back around 1850 because the error is ~350 years and is messing up extrapolation. 
pb<-pb %>%  mutate(across(c(cum_dry_mass_g_cm2, unsup_210Pb_pCi_g, error_of_unsup_Pb_sd,age_base_of_interval_yr,error_of_age_sd,date_mid_AD,date_base_AD,DMAR_g_cm2_yr,error_DMAR_sd),
                ~ ifelse(sample_id == "SOLD21_17", NA, .)))

# calculate density and rho for using with dry mass accumulation rate (DMAR)
pb <- pb %>%
        mutate(dry_perc=100-water_perc,
               wet_density_g_cm3=wet_wt_g/volume_cm3,
               all_rho_g_cm3=round(dry_perc/(dry_perc/2.4+water_perc),digits=4))
# only wet density for Wind River and Snowy cores (maybe a few CA cores)

# indicate if the part of the core is exact measurement, interpolated, or extrapolated
# first calculate the deepest 210Pb measurement
max_bottom_cm <- pb %>%
  group_by(lake_name) %>%
  filter(is.na(date_mid_AD) == F) %>%
  summarize(max_bottom_cm_210Pb_dated = max(bottom_cm))%>% ungroup()

# then calculate the shallowest 210Pb measurement (specifically for Soldier)
min_bottom_cm <- pb %>%
  group_by(lake_name) %>%
  filter(is.na(date_mid_AD) == F) %>%
  summarize(min_bottom_cm_210Pb_dated = min(bottom_cm))%>% ungroup()


# merge with main data frame
pb<- left_join(pb,max_bottom_cm, by=join_by(lake_name)); rm(max_bottom_cm) # max
pb<- left_join(pb,min_bottom_cm, by=join_by(lake_name)); rm(min_bottom_cm) # min

pb <- pb %>% group_by(lake_name) %>%
        mutate(date_type=ifelse(bottom_cm>max_bottom_cm_210Pb_dated,"extrapolated",
                                ifelse(lead210_measured=="y","measured",
                                        ifelse(lead210_measured=="n","interpolated",NA )))) %>% ungroup()

# use Loess line to predict interpolated values (middle of sample)

interpolated_dates_mid <- pb %>%
        group_by(lake_name) %>%
        do({
        loess_fit_mean <- loess(date_mid_AD ~ mid_cm, data = .)
        loess_fit_sd <- loess(error_of_age_sd ~ mid_cm, data = .)
        new_data <- data.frame(mid_cm = seq(unique(.$min_bottom_cm_210Pb_dated)- 0.25, unique(.$max_bottom_cm_210Pb_dated) - 0.25, by = 0.5))
        new_data$interpolated_date_mid_AD <- round(predict(loess_fit_mean, newdata = new_data),digits=2)
        new_data$interpolated_error_of_age_sd <- round(predict(loess_fit_sd, newdata = new_data), digits=3)
        new_data$lake_name <- .$lake_name[1] 
        new_data
        }) %>%
        unnest(cols = c(interpolated_date_mid_AD, interpolated_error_of_age_sd, mid_cm, lake_name)) %>% ungroup()

# use Loess line to predict interpolated values (base/bottom of sample)
interpolated_dates_base <- pb  %>%
        group_by(lake_name) %>%
        do({
        loess_fit_mean <- loess(date_base_AD ~ mid_cm, data = .)
        new_data <- data.frame(mid_cm = seq(unique(.$min_bottom_cm_210Pb_dated)- 0.25, unique(.$max_bottom_cm_210Pb_dated) - 0.25, by = 0.5))
        new_data$interpolated_date_base_AD <- round(predict(loess_fit_mean, newdata = new_data),digits=2)
        new_data$lake_name <- .$lake_name[1] 
        new_data
        }) %>%
        unnest(cols = c(interpolated_date_base_AD, mid_cm, lake_name)) %>% ungroup()

# add in a column for the top sediment date (used to approximate the top of the interval for prism data)

# function to convert date to decimal year
decimal_year <- function(date) {
  year <- year(date)
  start_of_year <- ymd(paste0(year, "-01-01"))
  days_in_year <- ifelse(leap_year(date), 366, 365) # Account for leap years
  fractional_year <- as.numeric(difftime(date, start_of_year, units = "days")) / days_in_year
  year + fractional_year
} 

#make a dataframe that has the decimal year for each lake
date_cored <- pb %>%
  select(lake_name,date_cored) %>% distinct(.) %>%  mutate(decimal_year=decimal_year(dmy(date_cored))) %>% select(-date_cored)
        
# add it to the interpolated_dates_base dataframe
interpolated_dates_base <-left_join(interpolated_dates_base,date_cored, join_by(lake_name)); rm(date_cored)

interpolated_dates_base <- interpolated_dates_base %>% group_by(lake_name) %>% mutate(interpolated_date_top_AD = c(decimal_year[1],interpolated_date_base_AD[1:length(interpolated_date_base_AD)-1])) %>% select(-decimal_year)

rm(decimal_year) # remove this function

# join the two columns for the middle date and the base date
interpolated_dates<-inner_join(interpolated_dates_mid,interpolated_dates_base, by=join_by(lake_name,mid_cm)); rm(interpolated_dates_mid); rm(interpolated_dates_base)

# merge back the interpolated dates
pb <-left_join(pb,as.data.frame(interpolated_dates), by=join_by(lake_name, mid_cm)); rm(interpolated_dates)


# extrapolate using the DMAR
# calculate the average DMAR for the last three samples
average_DMAR <- pb %>%
  group_by(lake_name) %>%
  filter(is.na(DMAR_g_cm2_yr) == F) %>%
  reframe(mean_DMAR_g_cm2_yr_bottom3 = mean(tail(DMAR_g_cm2_yr, n = 3)),
        mean_error_DMAR_sd_bottom3 = mean(tail(error_DMAR_sd, n = 3)),
        mean_DMAR_g_cm2_yr_bottom3_max = mean_DMAR_g_cm2_yr_bottom3 + mean_error_DMAR_sd_bottom3,
        mean_DMAR_g_cm2_yr_bottom3_min = mean_DMAR_g_cm2_yr_bottom3 - mean_error_DMAR_sd_bottom3,
        bottom_interpolated_error= tail(interpolated_error_of_age_sd,n=1),
        bottom_measured_date_mid_AD = tail(date_mid_AD, n=1)) %>%
        mutate(mean_DMAR_g_cm2_yr_bottom3_min = ifelse(mean_DMAR_g_cm2_yr_bottom3_min<0,0.01,mean_DMAR_g_cm2_yr_bottom3_min)) 
# used error of DMAR 0.001 because range for this data is 0.00024 0.03320 and using 0 produced -Inf

# join back to the main dataframe
pb <- left_join(pb, average_DMAR, by=join_by(lake_name)); rm(average_DMAR)

# calculate the accumulation rate 
pb <- pb %>%
        mutate(thickness=bottom_cm-top_cm,
               # calculate the mean DMAR 
               accumulation_rate_cm_yr=ifelse(date_type=="extrapolated",mean_DMAR_g_cm2_yr_bottom3 /all_rho_g_cm3, NA),
               years_per_thickness=thickness/accumulation_rate_cm_yr,
               # calculate the mean error for DMAR 
               accumulation_rate_max_cm_yr=ifelse(date_type=="extrapolated",mean_DMAR_g_cm2_yr_bottom3_max /all_rho_g_cm3, NA),
               accumulation_rate_min_cm_yr=ifelse(date_type=="extrapolated",mean_DMAR_g_cm2_yr_bottom3_min /all_rho_g_cm3, NA),
               years_per_thickness_max=thickness/accumulation_rate_max_cm_yr,
               years_per_thickness_min=thickness/accumulation_rate_min_cm_yr)
        
extrapolated_dates <- pb %>% group_by(lake_name) %>% filter(date_type=="extrapolated") %>%
        mutate(cumulative_years = cumsum(years_per_thickness),
               extrapolated_date_mid_AD = round(bottom_measured_date_mid_AD - cumulative_years,digits=2),
               # using error of DMAR
               cumulative_years_max = cumsum(years_per_thickness_max),
               extrapolated_date_mid_AD_max = round(bottom_measured_date_mid_AD - cumulative_years_max,digits=2),
                cumulative_years_min = cumsum(years_per_thickness_min),
               extrapolated_date_mid_AD_min = round(bottom_measured_date_mid_AD - cumulative_years_min,digits=2))%>% 
        ungroup() %>%  select(sample_id,cumulative_years, extrapolated_date_mid_AD, cumulative_years_max, extrapolated_date_mid_AD_max,  cumulative_years_min, extrapolated_date_mid_AD_min)

# join back to the main dataframe
pb <- left_join(pb, extrapolated_dates, by=join_by(sample_id)); rm(extrapolated_dates)

# create one column for the measured, interpolated, and extrapolated dates
pb <- pb %>% 
        mutate(date_mid_AD_combo=case_when(date_type=="measured" ~ date_mid_AD,
                                           date_type=="extrapolated" ~ extrapolated_date_mid_AD,
                                           date_type=="interpolated" ~ interpolated_date_mid_AD),
               date_mid_AD_min_combo= case_when(date_type=="measured" ~ date_mid_AD - error_of_age_sd,
                                           date_type=="extrapolated" ~ extrapolated_date_mid_AD_min- bottom_interpolated_error,
                                           date_type=="interpolated" ~ interpolated_date_mid_AD - interpolated_error_of_age_sd),
               date_mid_AD_max_combo= case_when(date_type=="measured" ~ date_mid_AD + error_of_age_sd,
                                           date_type=="extrapolated" ~ extrapolated_date_mid_AD_max + bottom_interpolated_error,
                                           date_type=="interpolated" ~ interpolated_date_mid_AD + interpolated_error_of_age_sd))
pb <- as.data.frame(pb)

############################################################################## 
### Here adding extra variables after the chronology has been incorporated ###
############################################################################## 

# Add whether fish are present for each sample based on the 210Pb results
pb <- pb %>%
        arrange(lake_name,bottom_cm) %>%
        group_by(lake_name)%>%
        mutate(fish_present_sample = ifelse(first_stocked_yr>=date_mid_AD_combo | is.na(first_stocked_yr) ==T, "fishless","fish"))  %>%  
        mutate(fish_present_sample = if_else(!is.na(fish_disappear_or_eradicated) & fish_disappear_or_eradicated <= date_mid_AD_combo, "fishless", fish_present_sample)) %>% ungroup()

# convert this to a binary predictor (0/1)
pb <- pb %>% mutate(fish_present_binary=case_when(fish_present_sample =="fishless"~0, 
                                               fish_present_sample =="fish" ~ 1 ))

# add in climate data from PRISM
prism <- read.csv("2_DataAnalysis/PRISM/PRISM_ppt_tmean_stable_4km_1895_2021.csv", header = TRUE, skip = 10) %>%
mutate(Name=case_when(Name=="Middle Gaylo"~"Middle Gaylor", 
                      TRUE ~Name)) %>%
  filter(complete.cases(.)) %>%
  rename(lake_name = 1) %>%
  mutate(lake_name = factor(lake_name)) %>%
  rename(precip_ppt_mm=ppt..mm.,
         mean_air_temp_degC=tmean..degrees.C., 
         longitude_prism=Longitude,
         latitude_prism=Latitude,
         elevation_prism=Elevation..m.) 

# make a new column that uses the exact date_base_AD is present to create the top and base intervals, but if not available, use the interpolated base dates
temp <- pb %>% filter(interpolated_date_base_AD>1894) %>% 
        select(lake_name, bottom_cm,date_mid_AD, date_base_AD, interpolated_date_base_AD, interpolated_date_top_AD) %>% 
        distinct() %>% 
        mutate(prism_date_base_AD=case_when(is.na(date_base_AD)==T ~ interpolated_date_base_AD,
                                            is.na(date_base_AD)==F ~ date_base_AD)) %>% 
        group_by(lake_name) %>%
        mutate(prism_date_top_AD = c(interpolated_date_top_AD[1],prism_date_base_AD[1:length(prism_date_base_AD)-1])) %>% 
        ungroup()%>% 
        select(lake_name, bottom_cm, prism_date_base_AD,prism_date_top_AD)                                                                                                                           
# calculate the average temperature for each sediment interval
# here I am using the interpolated base date and a top interval calculated from the 210Pb (not incorporating the error because we need an estimate of the interval itself that doesn't overlap)
new_df<-data.frame()
i=1
for(i in 1:nrow(temp)){
        sub<-temp[i,]
        sub$mean_air_temp_degC_interval<-mean(prism[prism$lake_name==sub$lake_name[1] & prism$Date >= floor(sub$prism_date_base_AD) & prism$Date <= floor(sub$prism_date_top_AD), "mean_air_temp_degC"])
        new_df<-rbind(new_df,sub)
}

# join the prism data back in
pb<-left_join(pb, new_df, join_by(lake_name,bottom_cm)) %>% arrange(lake_name, bottom_cm)
rm(temp); rm(new_df); rm(prism); rm(sub); rm(i)

pb <- as.data.frame(pb)
write.csv(pb,paste0(Sys.Date(),"_sample_data_dates.csv"))
rm(pb);rm(metadata)
```



# 3. Plot 210Pb dates
```{r}
pb <- read.csv(list.files(pattern = "*_sample_data_dates.csv", full.names = TRUE), row.names = 1, header = TRUE)


lk <- pb %>%
  mutate(lake_name = factor(lake_name, levels = names(lake_colors))) %>%
  arrange(lake_name, mid_cm) 

# make dataframes of polygons
poly <- data.frame()
for (lake in unique(lk$lake_name)) {
  lk_sub <- lk %>% filter(lake_name == lake)
  poly <- rbind(poly, data.frame(
    x = c(rev(lk_sub$date_mid_AD_min_combo), lk_sub$date_mid_AD_max_combo),
    y = c(rev(lk_sub$mid_cm), lk_sub$mid_cm),
    lake_name = lake
  ))
}
poly <- poly %>% filter(!(lake_name == "Soldier" & y %in% c(1.25, 0.5))) # remove top Soldier samples without data


poly$lake_name <- factor(poly$lake_name, levels = names(lake_colors))

ggplot() +
 geom_polygon(data = poly, aes(x = x, y = y, fill = lake_name), alpha = 0.5)+
  geom_line(data = lk, aes(x = date_mid_AD_combo, y = mid_cm, color = lake_name), linewidth = 1.5) +
  geom_point(data = filter(lk, date_type == "measured"), aes(x = date_mid_AD_combo, y = mid_cm), 
             color = "black", size = 2) +
  facet_wrap2(
    ~ lake_name, ncol = 7, strip.position = "top",
    strip = strip_themed(
      background_x = elem_list_rect(fill = lake_colors),
      text_x = elem_list_text(color = ifelse(unique(lk$lake_name)%in% c("Lightning", "Scott", "Middle Gaylor", "Soldier"), "white", "black"))
    )
  )+
  labs(x = "Date (Common Era)", y = "Depth (cm)")+
 scale_y_reverse(limits = c(30, 0), breaks = seq(0, 30, 5)) +
 custom_theme()+
scale_color_manual(values = lake_colors) +
  scale_fill_manual(values = lake_colors) +
          theme(panel.grid.minor = element_blank(),
                panel.grid.major = element_blank(),
        strip.text.x = element_text(size = 12),
        axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1, color = "black", size = 12),
        axis.text.y = element_text(color = "black", size = 12),
        axis.title = element_text(size = 12),
        legend.position = "none") +
         coord_cartesian(xlim = c(1000, 2022)) +
        geom_vline(data=lk[,names(lk) %in%c("lake_name","first_stocked_yr")] %>% unique(.) %>%  filter(complete.cases(.)) %>% filter(!lake_name=="Soldier"), aes(xintercept=first_stocked_yr), color="black",linewidth=0.75) +
        geom_vline(data=lk[,names(lk) %in%c("lake_name","fish_disappear_or_eradicated")] %>% unique(.) %>%  filter(complete.cases(.)) %>% filter(lake_name=="Skelton"), aes(xintercept=fish_disappear_or_eradicated), color="gray",linewidth=0.75)+
        geom_vline(data=lk[,names(lk) %in%c("lake_name","first_stocked_yr")] %>% unique(.) %>%  filter(complete.cases(.)) %>% filter(lake_name=="Soldier"), aes(xintercept=first_stocked_yr), color="black", linetype = "dashed",linewidth=0.75)

ggsave("3_Figures/FigX_210Pb_dates.png",height=5, width=14, units="in")

```
Notes: min(poly$x)  -975.239, its monogram because it is so deep (38 cm), so cut off here at 30 cm while still reasonable


# 4. NMDS
## a. NMDS zooplankton
V7 fishless/fish sample
```{r}
nmds <- ps_V7_norm %>% subset_taxa(.,Family %in% c("Branchiopoda", "Maxillopoda")) %>% tax_glom(., taxrank = "Genus") %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_zooplankton_V7_genus.png", width = 7, height = 5, dpi = 400)

ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_zooplankton_V7_genus_fishless_sample.png", width = 7, height = 5, dpi = 400)


ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_zooplankton_V7_genus_fish_sample.png", width = 7, height = 5, dpi = 400)

```

V9 fish/fishless sample
```{r}
nmds <- ps_V9_norm %>% subset_taxa(.,Family %in% c("Branchiopoda", "Maxillopoda")) %>% tax_glom(., taxrank = "Genus") %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)


nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_zooplankton_V9_genus.png", width = 7, height = 5, dpi = 400)



ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_zooplankton_V9_genus_fishless_sample.png", width = 7, height = 5, dpi = 400)


ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_zooplankton_V9_genus_fish_sample.png", width = 7, height = 5, dpi = 400)
```



## b. NMDS phytoplankton
without fungi or metazoans
### V7
```{r}
# remove metazoans and fungi
nmds <- ps_V7_norm %>% subset_taxa(., !Phylum%in%c("Opisthokonta-Fungi","Opisthokonta-Metazoa")) %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)



ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_protist_V7_ESV.png", width = 7, height = 5, dpi = 400)


ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_protist_V7_ESV_fishless_sample.png", width = 7, height = 5, dpi = 400)


ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_protist_V7_ESV_fish_sample.png", width = 7, height = 5, dpi = 400)


```

### V9
```{r}
nmds <- ps_V9_norm %>% subset_taxa(., !Phylum%in%c("Opisthokonta-Fungi","Opisthokonta-Metazoa")) %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)



nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)



ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_protist_V9_ESV.png", width = 7, height = 5, dpi = 400)


ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_protist_V9_ESV_fishless_sample.png", width = 7, height = 5, dpi = 400)


ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_protist_V9_ESV_fish_sample.png", width = 7, height = 5, dpi = 400)
```



# 5. Isotope 
```{r}
# Arrange metadata by mountain_range, fish, lake_name, and bottom_cm
meta <- metadata %>% filter(isotope_run=="CN") %>%
  arrange(state, fish, lake_name, bottom_cm) %>%
  mutate(lake_name = factor(lake_name, levels = unique(lake_name)))  # Set lake_name as a factor based on the desired order

meta<-meta %>%
  mutate(lake_name = factor(lake_name, levels = names(lake_colors))) %>%
  arrange(lake_name, mid_cm) 



# raw d15N data
ggplot(data = meta, aes(x = date_mid_AD_combo, y = d15N, color=isotope_year_run)) +
  geom_line() + 
  geom_point() + 
  geom_errorbar(aes(ymin = d15N - 0.4, ymax = d15N + 0.4)) +
  facet_wrap2(~ lake_name, ncol=7, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Year (Common Era)",y="d15N raw values") + 
  scale_y_reverse()+
  custom_theme()  
ggsave("3_Figures/FigX_d15N.png",height=5, width=16, units="in")


# anomaly
ggplot(data = meta, aes(x = date_mid_AD_combo, y = d15N_diff_from_start,color=isotope_year_run)) +
  geom_line() + 
  geom_point() + 
  geom_errorbar(aes(ymin = d15N_diff_from_start - 0.4, ymax = d15N_diff_from_start + 0.4)) + 
  facet_wrap2(~ lake_name, ncol=7, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Year (Common Era)", y="d15N anomaly") + 
  scale_y_reverse()+
  custom_theme()  +
 scale_color_manual(values=c("#009E73","#E69F00", "#56B4E9", "#D55E00"))
ggsave("3_Figures/FigX_d15N_diff_from_start.png",height=5, width=18, units="in")

# d13C
ggplot(data = meta, aes(x = date_mid_AD_combo, y =d13C)) +
  geom_line() + 
  geom_point() + 
   facet_wrap2(~ lake_name, ncol=7, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Year (Common Era)") +  
  custom_theme()  #
ggsave("3_Figures/FigX_d13C.png",height=5, width=1, units="in")

#CN
ggplot(data = meta, aes(x = date_mid_AD_combo, y =CN_ratio)) +
  geom_line() + 
  geom_point() + 
  facet_wrap2(~ lake_name, ncol=7, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Year (Common Era)") +  
  custom_theme()  #
ggsave("3_Figures/FigX_CN.png",height=5, width=16, units="in")

# percent carbon
ggplot(data = meta, aes(x = date_mid_AD_combo, y =C_perc)) +
  geom_line() + 
  geom_point() + 
   facet_wrap2(~ lake_name, ncol=7, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Year (Common Era)") + 
  custom_theme()  
ggsave("3_Figures/FigX_C_perc.png",height=5, width=16, units="in")

# percent carbon and C-H
ggplot(data = meta, aes(x = mean_C.H, y =C_perc)) +
  geom_point() + 
   facet_wrap2(~ lake_name, ncol=7, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Year (Common Era)") +  
  custom_theme()  
ggsave("3_Figures/FigX_C_perc_vs_CH.png",height=5, width=16, units="in")


```


## a. against NMDS 

### i. V7 phytoplankton - anomaly d15N
```{r}
nmds <- ps_V7_norm %>% subset_taxa(., !Phylum%in%c("Opisthokonta-Fungi","Opisthokonta-Metazoa")) %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)  
nmds_points$sample_id <- rownames(nmds_points)  
nmds_meta <- merge(nmds_points, metadata, by = "sample_id")
                 
nmds_meta <- nmds_meta %>%
  mutate(lake_name = factor(lake_name, levels = names(lake_colors)))  



# WA / CA / WY
ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(x = MDS1, y = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 3, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(x = "NMDS1", y = "dN15 anomaly", fill = "Lake name") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        labs(color = "Lake name") +
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right")
ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V7_protist.png",height=5, width=12, units="in")


# WA / CA / WY with fish/fishless samples
ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(x = MDS1, y = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 3, pch = 16) +
        geom_point(data = nmds_meta %>% filter(is.na(d15N_diff_from_start) == F & fish_present_sample=="fish"), 
                   aes(x = MDS1, y = d15N_diff_from_start), 
             size = 3, pch = 21, fill = NA, color = "black") + 
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(x = "NMDS1", y = "dN15 anomaly", fill = "Lake name") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        labs(color = "Lake name") +
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right")
ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V7_protist_fishpresence.png",height=5, width=12, units="in")


# Break out Wyoming
nmds_meta<- nmds_meta %>% mutate(region = case_when(mountain_range == "Wind River" ~ "Wind River", 
                                                   mountain_range == "Snowy"~ "Snowy",
                                                   TRUE ~ region))


ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(x = MDS1, y = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 3, pch = 16) +
        facet_wrap( ~ region) +
        scale_color_manual(values = lake_colors) +
        labs(x = "NMDS1", y = "dN15 anomaly", fill = "Lake name") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        labs(color = "Lake name") +
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right")
ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V7_protist_region.png",height=7, width=10, units="in")
```


### ii. V9 phytoplankton - anomaly d15N
```{r}
nmds <- ps_V9_norm %>% subset_taxa(., !Phylum%in%c("Opisthokonta-Fungi","Opisthokonta-Metazoa")) %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)  
nmds_points$sample_id <- rownames(nmds_points)  
nmds_meta <- merge(nmds_points, metadata, by = "sample_id")
                 
nmds_meta <- nmds_meta %>%
  mutate(lake_name = factor(lake_name, levels = names(lake_colors)))  



# WA / CA / WY
ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(x = MDS2, y = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 3, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(x = "NMDS2", y = "dN15 anomaly", fill = "Lake name") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        labs(color = "Lake name") +
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right")
ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V9_protist.png",height=5, width=12, units="in")


# WA / CA / WY with fish/fishless samples
ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(x = MDS2, y = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 3, pch = 16) +
        geom_point(data = nmds_meta %>% filter(is.na(d15N_diff_from_start) == F & fish_present_sample=="fish"), 
             aes(x = MDS2, y = d15N_diff_from_start), 
             size = 3, pch = 21, fill = NA, color = "black") + 
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(x = "NMDS2", y = "dN15 anomaly", fill = "Lake name") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        labs(color = "Lake name") +
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right")
ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V9_protist_fishpresence.png",height=5, width=12, units="in")


# Break out Wyoming
nmds_meta<- nmds_meta %>% mutate(region = case_when(mountain_range == "Wind River" ~ "Wind River", 
                                                   mountain_range == "Snowy"~ "Snowy",
                                                   TRUE ~ region))


ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(x = MDS2, y = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 3, pch = 16) +
        facet_wrap( ~ region) +
        scale_color_manual(values = lake_colors) +
        labs(x = "NMDS2", y = "dN15 anomaly", fill = "Lake name") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        labs(color = "Lake name") +
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right")
ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V9_protist_region.png",height=7, width=10, units="in")
```


### ix. breakpoint analysis for d15N
```{r}
meta <- metadata %>% filter(isotope_run=="CN" &is.na(d15N_diff_from_start)==F) %>% arrange(lake_name, desc(bottom_cm))

breakpoint_summary<-data.frame(lake_name=NULL,breakpoint_1=NULL, breakpoint_2=NULL)
for(i in 1:14){
sub<-meta[meta$lake_name==unique(meta$lake_name)[i],names(meta)%in%c("sample_id","d15N_diff_from_start")]
sub<-ts(-(sub$d15N_diff_from_start), start=1,end=nrow(sub), frequency = 1)

## estimate breakpoints
bp.ri <- breakpoints(sub ~ 1, h = 5)
#plot(bp.ri)
sum<-summary(bp.ri)
one<-sum$breakpoints[1,]
two<-sum$breakpoints[2,]

## fit segmented model with two breaks from minimized BIC
fac.ri <- breakfactor(bp.ri, breaks = 2, label = "seg")
fm.ri <- lm(sub ~ 0 + fac.ri)
#summary(fm.ri)

## Visualization
plot(sub, main=unique(meta$lake_name)[i])
lines(as.vector(time(sub)), fitted(fm.ri), col = 4)

breakpoint_summary<-rbind(breakpoint_summary, data.frame(lake_name=unique(meta$lake_name)[i],breakpoint_1=one[is.na(one)==F], breakpoint_2_1=two[is.na(two)==F][1], breakpoint_2_2=two[is.na(two)==F][2]))
}


print(breakpoint_summary)

# visually pick breakpoints from plots and the breakpoint_summary
breakpoint_index <- c("Black Rock" = 7,"Bullfrog"= 33,"Canyon" = 17,"Crescent"= 28,"Eyrie" = 11, "Footprint" = 13, "Lightning" = 13, "Lost" = 15,"Louise"=38,"Middle Gaylor"= 34,"Monogram"=62,"Scott" = 11,"Skelton"=41,"Soldier"=34)

breakpoint_index<-as.data.frame(breakpoint_index)
breakpoint_index$lake_name<-rownames(breakpoint_index)
rownames(breakpoint_index)<-NULL

meta<-left_join(meta, breakpoint_index, join_by(lake_name))

meta <- meta %>%
  group_by(lake_name) %>%
  mutate(d15N_breakpoint_bottom_cm = bottom_cm[breakpoint_index],
         d15N_breakpoint_date = date_mid_AD_combo[breakpoint_index]) %>%
  ungroup()

meta <- meta %>%
  mutate(lake_name = factor(lake_name, levels = names(lake_colors)))  

#breakpoints bottom centimeter
ggplot(meta, aes(x=bottom_cm, y=d15N_diff_from_start)) +
        geom_point()+
        geom_line()+
  facet_wrap2(~ lake_name, ncol=7, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
        scale_y_reverse()+
        scale_x_reverse() +
        labs(y="d15N anomaly", x="Depth (cm)") +
        geom_vline(data=meta %>% select(lake_name, d15N_breakpoint_bottom_cm) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=d15N_breakpoint_bottom_cm), color="black",linewidth=0.75) +
        custom_theme()
ggsave("3_Figures/FigX_d15N_breakpoints_bottom_cm.png",height=4, width=15, units="in")

# breakpoint dates
ggplot(meta, aes(x=date_mid_AD_combo, y=d15N_diff_from_start)) +
        geom_point()+
        geom_line()+
  facet_wrap2(~ lake_name, ncol=7, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
        scale_y_reverse() +
        labs(y="d15N anomaly", x="Date (Common Era)") +
        geom_vline(data=meta %>% select(lake_name, d15N_breakpoint_date) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=d15N_breakpoint_date), color="black",linewidth=0.75) +
        geom_vline(data=meta[,names(meta) %in%c("lake_name","first_stocked_yr")] %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=first_stocked_yr), color="red",linewidth=0.75) +
        custom_theme()
ggsave("3_Figures/FigX_d15N_breakpoints_bottom_date.png",height=5, width=15, units="in")

lake_breakpoints<-meta %>% select(lake_name, d15N_breakpoint_bottom_cm, d15N_breakpoint_date) %>% unique(.) %>%  filter(complete.cases(.))

write.csv(lake_breakpoints, "2_DataAnalysis/d15N_breakpoints.csv")
```
Note: used first positive breakpoint



# 6. ANOVA with NMDS scores
```{r}
meta <- metadata %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
meta <- meta %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()



# V7 phytoplankton without metazoans and fungi
nmds <- ps_V7_norm %>% subset_taxa(., !Phylum%in%c("Opisthokonta-Fungi","Opisthokonta-Metazoa")) %>% ordinate(., method = "NMDS", distance="bray")
nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,meta,by="sample_id"); rm(nmds_points)

output <- aov(MDS1 ~ fish_present_sample + d15N_category, data = nmds_meta); summary(output)


```


# 7. Biogenic silica
```{r}
# Arrange metadata by mountain_range, fish, lake_name, and bottom_cm
meta <- metadata %>% filter(is.na(mean_BiSi)==F) %>%
  arrange(state, fish, lake_name, bottom_cm) %>%
  mutate(lake_name = factor(lake_name, levels = unique(lake_name)))  


ggplot(data = meta, aes(x = date_mid_AD_combo, y =mean_BiSi)) +
  facet_wrap(~lake_name, nrow=2, ncol=7) + 
        custom_theme() +
        geom_ribbon(aes(ymin = mean_BiSi - (mean_range_BiSi / 2), 
                        ymax = mean_BiSi + (mean_range_BiSi / 2)),
                    fill="orange") +
        geom_line() + 
        geom_point() +
        labs(x = "Year (Common Era)",
             y="BiSi")

ggsave("3_Figures/FigX_BiSi_mean_error.png",height=5, width=16, units="in")

ggplot(data = meta, aes(x = date_mid_AD_combo, y =mean_BiSi)) +
  facet_wrap(~lake_name, nrow=2, ncol=7) + 
        custom_theme() +
        geom_ribbon(aes(ymin = mean_BiSi - (max_range_BiSi / 2), 
                        ymax = mean_BiSi + (max_range_BiSi / 2)),
                    fill="orange") +
        geom_line() + 
        geom_point() +
        labs(x = "Year (Common Era)",
             y="BiSi")

ggsave("3_Figures/FigX_BiSi_max_error.png",height=5, width=16, units="in")



ggplot(data = meta, aes(x = date_mid_AD_combo, y =mean_C.H)) +
  facet_wrap(~lake_name, nrow=2, ncol=7) + 
        custom_theme() +
        geom_ribbon(aes(ymin = mean_C.H - (mean_range_C.H / 2), 
                        ymax = mean_C.H + (mean_range_C.H / 2)),
                    fill="orange") +
        geom_line() + 
        geom_point() +
        labs(x = "Year (Common Era)",
             y="C-H")

ggsave("3_Figures/FigX_C.H_mean_error.png",height=5, width=16, units="in")

ggplot(data = meta, aes(x = date_mid_AD_combo, y =mean_C.H)) +
  facet_wrap(~lake_name, nrow=2, ncol=7) + 
        custom_theme() +
        geom_ribbon(aes(ymin = mean_C.H - (max_range_C.H / 2), 
                        ymax = mean_C.H + (max_range_C.H / 2)),
                    fill="orange") +
        geom_line() + 
        geom_point() +
        labs(x = "Year (Common Era)",
             y="C-H")

ggsave("3_Figures/FigX_CH_max_error.png",height=5, width=16, units="in")

```
- normalize for dry mass
- normalize for clastics (1-organics)
- see if it relates to the percent of diatoms and crysophytes


## a. compared to diatom abundances

```{r}
sub<-ps_V7_norm %>% subset_taxa(.,Class=="Bacillariophyceae") %>% tax_glom(., taxrank = "Class") 
sub<-psmelt(sub)

# Arrange metadata by mountain_range, fish, lake_name, and bottom_cm
meta <- sub %>% filter(is.na(mean_BiSi)==F) %>%
  arrange(state, fish, lake_name, bottom_cm) %>%
  mutate(lake_name = factor(lake_name, levels = unique(lake_name)))  

ggplot(data = meta, aes(x = Abundance, y =mean_BiSi)) +
  facet_wrap(~lake_name,scales="free", nrow=2, ncol=7) + 
        custom_theme() +
        geom_point() +
         geom_smooth(method = "lm", se = T) + 
        labs(x = "Diatom reads",
             y="BiSi")

ggsave("3_Figures/FigX_BiSi_diatom_abundance.png",height=5, width=16, units="in")
```


# 8. Relative abundances
## a. Zooplankton

```{r}

V9 <- ps_V9_norm %>% subset_taxa(.,Family %in% c("Branchiopoda", "Maxillopoda")) %>% tax_glom(., taxrank = "Genus") 

# transform to relative abundances
ps_rel <- transform_sample_counts(V9, function(x) x / sum(x))

# calculate the total relative abundance of each OTU across all samples
otu_totals <- taxa_sums(ps_rel) / sum(taxa_sums(ps_rel))  # Summed relative abundance for each OTU

# filter OTUs that have a relative abundance >= 0.01
ps_filtered <- prune_taxa(otu_totals >= 0.005, ps_rel)

V9<-ps_filtered%>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.) %>% arrange(lake_name, bottom_cm) %>% mutate(taxa=paste(OTU,Family,Genus)) 

genus_colors <- c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3", "#FF7F00", 
                "#A65628", "#F781BF", "#999999", "#66C2A5", "black",
                  "#FC8D62", "#8DA0CB", "#E78AC3", "#A6D854", "#FFD92F")

V9$lake_name <- factor(V9$lake_name, levels = names(lake_colors))


ggplot(V9, aes(x = date_mid_AD_combo, y = Abundance, fill = taxa, color = taxa)) +
  facet_wrap(~lake_name, nrow = 14) + 
  geom_line(aes(group = taxa), size=1.1) +  
  theme_bw() +theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+
  geom_vline(data = V9 %>% 
               select(lake_name, first_stocked_yr) %>% 
               distinct() %>% 
               filter(complete.cases(.)), 
             aes(xintercept = first_stocked_yr), color = "black", size = 1)+ 
           scale_color_manual(values = genus_colors) +  # Apply distinct colors to Genus
  scale_fill_manual(values = genus_colors)  
ggsave("3_Figures/FigX_RelAbun_zooplankton_V9_genus_low_abund_rm.png",height=10, width=8, units="in")


# read in the combined file 
V9 <- ps_V9_norm %>% subset_taxa(.,Family %in% c("Branchiopoda", "Maxillopoda")) %>% tax_glom(., taxrank = "Genus") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.) %>% arrange(lake_name, bottom_cm) %>% mutate(taxa=paste(OTU,Family,Genus)) 



# make the legend order match the lake_colors list
V9$lake_name <- factor(V9$lake_name, levels = names(lake_colors))

ggplot(V9, aes(x = date_mid_AD_combo, y = Abundance, fill = taxa, color = taxa)) +
  facet_wrap(~lake_name, nrow = 14) + 
  geom_line(aes(group = taxa), size=1.1) +  
  theme_bw() +theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+
  geom_vline(data = V9 %>% 
               select(lake_name, first_stocked_yr) %>% 
               distinct() %>% 
               filter(complete.cases(.)), 
             aes(xintercept = first_stocked_yr), color = "black", size = 1)+ 
           scale_color_manual(values = genus_colors) +  # Apply distinct colors to Genus
  scale_fill_manual(values = genus_colors)  
ggsave("3_Figures/FigX_RelAbun_zooplankton_V9_genus_all.png",height=10, width=8, units="in")


```


## b. phytoplankton
try to do trophic mode assignment
```{r}
taxa<-as.data.frame(tax_table(ps_V7_norm))
taxa$asv_code<-row.names(taxa)
taxa <- taxa %>% rename(domain = Kingdom, supergroup=Groups,class=Class,order=Order,family=Family,genus=Genus,species=Species ) %>%  separate(Phylum, into = c("division", "subdivision"), sep = "-") %>% select(asv_code, domain, supergroup, division, subdivision, class, order, family, genus, species)



write.table(taxa, file = "V7_taxonomy_for_trophic_mode_assignment.tsv", sep = "\t", row.names = F, quote = FALSE)

```


Explore phytoplankton taxa
```{r}
taxa<- as.data.frame(tax_table(ps_V7_norm %>% subset_taxa(.,!Family %in% c("Branchiopoda", "Maxillopoda"))))
table(taxa$Kingdom)
table(taxa$Groups)
table(taxa$Phylum)
table(taxa$Class)
```

```{r}
# remove zooplankton
physeq <- ps_V7_norm %>% subset_taxa(.,!Family %in% c("Branchiopoda", "Maxillopoda", "Rotifera")) %>% tax_glom(., taxrank = "Class") 

df <- psmelt(ps_V7_norm %>% subset_taxa(.,!Family %in% c("Branchiopoda", "Maxillopoda")) %>% tax_glom(., taxrank = "Class")) 

df_abundance <- df %>%
  group_by(lake_name, Class) %>%
  summarize(TotalAbundance = sum(Abundance)) %>%
  ungroup()

# find top 10 classes in each lake
top_families <- df_abundance %>%
  group_by(lake_name) %>%
  top_n(10, TotalAbundance) %>%  
  arrange(lake_name, desc(TotalAbundance)) 

unique(top_families$Class)

```




# 9. Trophic mode relative abundances over time

Manually make it so the taxonomy table only has two columns
```{r}
# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi") %>% select(domain,trophic_mode)
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object


physeq <- ps_V7_norm %>% tax_glom(., taxrank = "trophic_mode")

# transform to relative abundances
physeq <- transform_sample_counts(physeq, function(x) x / sum(x))

ps_melt<-psmelt(physeq)

ps_melt <- ps_melt %>%
        mutate(lake_color = lake_colors[lake_name])

trophic_colors <- c("heterotrophs" = "#E41A1C",       # Red
                    "phototrophs" = "#4DAF4A",        # Green
                    "unknown" = "#999999",            # Gray
                    "parasites" = "#377EB8",          # Blue
                    "mixotrophs" = "#FF7F00",         # Orange
                    "saprotrophs" = "#A65628",        # Brown
                    "phototrophs/mixotrophs" = "#FFD92F") # Yellow


ggplot(data=ps_melt, aes(x=date_mid_AD_combo, y=Abundance, color=trophic_mode))+
        geom_line(linewidth=1.2)+
        facet_wrap2(~ lake_name, nrow=7, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
        geom_vline(data=ps_melt %>% select(lake_name,first_stocked_yr) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=first_stocked_yr), color="black",linewidth=0.75) +
        geom_vline(data=ps_melt %>% select(lake_name,fish_disappear_or_eradicated) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=fish_disappear_or_eradicated), color="gray",linewidth=0.75)+
        custom_theme() + 
        labs(color="Trophic mode", x="Date (Common Era)", y="Relative abundance") +
        scale_color_manual(values=trophic_colors)
ggsave("3_Figures/FigX_V7_trophic_mode.png",height=8, width=13, units="in")

```


## a. NMDS+ of phototrophs and mixotrophs
```{r}
# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object

# select only phototrophs and mixotrophs
nmds <- subset_taxa(ps_V7_norm, trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs")) %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_phytoplankton_V7_ESV.png", width = 7, height = 5, dpi = 400)


p1<-ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  



p2<-ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
scale_x_reverse()+
  theme(legend.position = "none",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

(p1 | p2) +   plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = 'A')

ggsave("3_Figures/FigX_NMDS_phytoplankton_V7_ESV_fish_fishless_sample.png", width = 12, height = 5, dpi = 400)


# add in d15N breakpoints 
nmds_meta <- nmds_meta %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
nmds_meta <- nmds_meta %>% group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm >= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm < d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# WA / CA / WY and highlight nmds d15N relationships 
p1<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_rect(fill = "black"),
    strip.text = element_text(color = "white"),
    axis.title.x = element_blank())+
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "none")



# low colored
p2<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start)==F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16, col="white") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1), size=2, pch = 16, col="gray") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name), size=2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_blank(),
                strip.text = element_blank(),
              axis.title.x = element_blank())+
        geom_smooth(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name),method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right") + 
        guides(color = guide_legend(override.aes = list(size = 4)))  




# show high colored
p3<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start)==F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16, col="white") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1), size=2, pch = 16, col="gray") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name), size=2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_blank(),
                strip.text = element_blank())+
        geom_smooth(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name),method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "none")


(p1 / p2 / p3) +   plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = 'A')




ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V7_phytoplankton_multipanel.png",height=7, width=8, units="in")


```

### relative abundances 
```{r}
# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object


# select only phototrophs and mixotrophs
sub <- subset_taxa(ps_V7_norm, trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs")) %>% tax_glom(.,taxrank="subdivision") %>% filter_taxa(., function(x) max(x) >= 50, TRUE) %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)


sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()


taxa_colors <- c("#E41A1C", "#F781BF", "#984EA3", "#FF7F00", "#377EB8",
                "#A65628", "#4DAF4A" , "#999999", "#66C2A5", "black",
                  "#FC8D62", "#8DA0CB", "#E78AC3", "#A6D854", "#FFD92F")

ggplot(data=sub, aes(x=date_mid_AD_combo, y=Abundance, color=subdivision)) +
        facet_wrap2(~ lake_name, ncol=4, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)") +
  geom_line(aes(group = subdivision), linewidth=1.1) +         
        custom_theme() + 
                geom_vline(data=sub %>% select(lake_name, d15N_breakpoint_date) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=d15N_breakpoint_date), color="green4",linewidth=0.75) +
        geom_vline(data=sub %>% select(lake_name, first_stocked_yr) %>% select(lake_name, first_stocked_yr) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=first_stocked_yr), color="black",linewidth=0.75) +
        scale_color_manual(values=taxa_colors)


ggsave("3_Figures/FigX_RelAbund_phototrophs_mixotrophs_overtime_subdivision.png",height=7, width=15, units="in")


```



## b. NMDS+ of all other excluding fungi

```{r}
# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object

# select only phototrophs and mixotrophs
nmds <- subset_taxa(ps_V7_norm, !trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs")) %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_other_V7_ESV.png", width = 7, height = 5, dpi = 400)


p1<-ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  



p2<-ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
scale_x_reverse()+
  theme(legend.position = "none",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

(p1 | p2) +   plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = 'A')

ggsave("3_Figures/FigX_NMDS_other_V7_ESV_fish_fishless_sample.png", width = 12, height = 5, dpi = 400)


# add in d15N breakpoints 
nmds_meta <- nmds_meta %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
nmds_meta <- nmds_meta %>% group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm >= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm < d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# WA / CA / WY and highlight nmds d15N relationships 
p1<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_rect(fill = "black"),
    strip.text = element_text(color = "white"),
    axis.title.x = element_blank())+
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "none")



# low colored
p2<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start)==F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16, col="white") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1), size=2, pch = 16, col="gray") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name), size=2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_blank(),
                strip.text = element_blank(),
              axis.title.x = element_blank())+
        geom_smooth(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name),method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right") + 
        guides(color = guide_legend(override.aes = list(size = 4)))  




# show high colored
p3<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start)==F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16, col="white") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1), size=2, pch = 16, col="gray") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name), size=2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_blank(),
                strip.text = element_blank())+
        geom_smooth(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name),method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "none")


(p1 / p2 / p3) +   plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = 'A')




ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V7_other_multipanel.png",height=7, width=8, units="in")
```



### relative abundances but without zooplankton
```{r}
# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object


# select only microbial eukaryotes that are not phototrophic and not zooplankton
sub <- subset_taxa(ps_V7_norm, !trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs")) %>% tax_glom(.,taxrank="subdivision") %>% filter_taxa(., function(x) max(x) >= 200, TRUE) %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)



sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()


taxa_colors <- c("#E41A1C", "#F781BF", "#984EA3", "#FF7F00", "#377EB8",
                "#A65628", "#4DAF4A" , "#999999", "#66C2A5", "black",
                  "#FC8D62", "#8DA0CB", "#E78AC3", "#A6D854", "#FFD92F","darkolivegreen1","lightsalmon")

ggplot(data=sub, aes(x=date_mid_AD_combo, y=Abundance, color=subdivision)) +
        facet_wrap2(~ lake_name, ncol=4, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)") +
  geom_line(aes(group = subdivision), linewidth=1.1) +         
        custom_theme() + 
                geom_vline(data=sub %>% select(lake_name, d15N_breakpoint_date) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=d15N_breakpoint_date), color="green4",linewidth=0.75) +
        geom_vline(data=sub %>% select(lake_name, first_stocked_yr) %>% select(lake_name, first_stocked_yr) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=first_stocked_yr), color="black",linewidth=0.75) +
        scale_color_manual(values=taxa_colors)


ggsave("3_Figures/FigX_RelAbund_protists_nophyto_nozooplankton_overtime_subdivision.png",height=7, width=15, units="in")


```

### metazoans
```{r}
# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object


# select metazoan
sub <- subset_taxa(ps_V7_norm, subdivision=="Metazoa") %>% tax_glom(.,taxrank="class") %>% filter_taxa(., function(x) max(x) >= 100, TRUE) %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)


# %>% subset_taxa(.,! class=="Rotifera" | family %in%c("Maxillopoda","Branchiopoda")) 

sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()


taxa_colors <- c("#E41A1C", "#F781BF", "#984EA3", "#FF7F00", "#377EB8",
                "#A65628", "#4DAF4A" , "#999999", "#66C2A5", "black",
                  "#FC8D62", "#8DA0CB", "#E78AC3", "#A6D854", "#FFD92F","darkolivegreen1","lightsalmon")

ggplot(data=sub, aes(x=date_mid_AD_combo, y=Abundance, color=class)) +
        facet_wrap2(~ lake_name, ncol=4, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)") +
  geom_line(aes(group = class), linewidth=1.1) +         
        custom_theme() + 
                geom_vline(data=sub %>% select(lake_name, d15N_breakpoint_date) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=d15N_breakpoint_date), color="green4",linewidth=0.75) +
        geom_vline(data=sub %>% select(lake_name, first_stocked_yr) %>% select(lake_name, first_stocked_yr) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=first_stocked_yr), color="black",linewidth=0.75) +
        scale_color_manual(values=taxa_colors)


ggsave("3_Figures/FigX_RelAbund_metazoan_overtime_subdivision.png",height=7, width=15, units="in")

```

### protists (no phytoplankton, no metazoan)
```{r}

# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object


# select metazoan
sub <- subset_taxa(ps_V7_norm, !subdivision=="Metazoa" & !trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs")) %>% tax_glom(.,taxrank="subdivision") %>% filter_taxa(., function(x) max(x) >= 200, TRUE) %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)



sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()


taxa_colors <- c("#E41A1C", "#F781BF", "#984EA3", "#FF7F00", "#377EB8",
                "#A65628", "#4DAF4A" , "#999999", "#66C2A5", "black",
                  "#FC8D62", "#8DA0CB", "#E78AC3", "#A6D854", "#FFD92F","darkolivegreen1","lightsalmon")

ggplot(data=sub, aes(x=date_mid_AD_combo, y=Abundance, color=subdivision)) +
        facet_wrap2(~ lake_name, ncol=4, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)") +
  geom_line(aes(group = subdivision), linewidth=1.1) +         
        custom_theme() + 
                geom_vline(data=sub %>% select(lake_name, d15N_breakpoint_date) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=d15N_breakpoint_date), color="green4",linewidth=0.75) +
        geom_vline(data=sub %>% select(lake_name, first_stocked_yr) %>% select(lake_name, first_stocked_yr) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=first_stocked_yr), color="black",linewidth=0.75) +
        scale_color_manual(values=taxa_colors)



ggsave("3_Figures/FigX_RelAbund_protists_nophyto_nometazoan_overtime_subdivision.png",height=7, width=15, units="in")

```




### arthropods
```{r}

# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object


# select metazoan
sub <- subset_taxa(ps_V7_norm,class=="Arthropoda") %>% tax_glom(.,taxrank="order") %>% filter_taxa(., function(x) max(x) >= 100, TRUE) %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)



sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()


taxa_colors <- c("#E41A1C", "#F781BF", "#984EA3", "#FF7F00", "#377EB8",
                "#A65628", "#4DAF4A" , "#999999", "#66C2A5", "black",
                  "#FC8D62", "#8DA0CB", "#E78AC3", "#A6D854", "#FFD92F","darkolivegreen1","lightsalmon")

ggplot(data=sub, aes(x=date_mid_AD_combo, y=Abundance, color=order)) +
        facet_wrap2(~ lake_name, ncol=4, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)") +
  geom_line(aes(group = order), linewidth=1.1) +         
        custom_theme() + 
                geom_vline(data=sub %>% select(lake_name, d15N_breakpoint_date) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=d15N_breakpoint_date), color="green4",linewidth=0.75) +
        geom_vline(data=sub %>% select(lake_name, first_stocked_yr) %>% select(lake_name, first_stocked_yr) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=first_stocked_yr), color="black",linewidth=0.75) +
        scale_color_manual(values=taxa_colors)



ggsave("3_Figures/FigX_RelAbund_arthropods_overtime_subdivision.png",height=7, width=15, units="in")

```






## c. NMDS+ protists (no phototrophs, no metazoan)

```{r}
# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object

# select only phototrophs and mixotrophs
nmds <- subset_taxa(ps_V7_norm, !trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs") & !subdivision=="Metazoa") %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_protists_nometazoan_V7_ESV.png", width = 7, height = 5, dpi = 400)


p1<-ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  



p2<-ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
scale_x_reverse()+
  theme(legend.position = "none",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

(p1 | p2) +   plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = 'A')

ggsave("3_Figures/FigX_NMDS_protists_nometazoan_V7_ESV_fish_fishless_sample.png", width = 12, height = 5, dpi = 400)


# add in d15N breakpoints 
nmds_meta <- nmds_meta %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
nmds_meta <- nmds_meta %>% group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm >= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm < d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# WA / CA / WY and highlight nmds d15N relationships 
p1<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_rect(fill = "black"),
    strip.text = element_text(color = "white"),
    axis.title.x = element_blank())+
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "none")



# low colored
p2<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start)==F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16, col="white") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1), size=2, pch = 16, col="gray") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name), size=2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_blank(),
                strip.text = element_blank(),
              axis.title.x = element_blank())+
        geom_smooth(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name),method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right") + 
        guides(color = guide_legend(override.aes = list(size = 4)))  




# show high colored
p3<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start)==F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16, col="white") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1), size=2, pch = 16, col="gray") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name), size=2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_blank(),
                strip.text = element_blank())+
        geom_smooth(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name),method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "none")


(p1 / p2 / p3) +   plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = 'A')




ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V7_protists_nometazoan_multipanel.png",height=7, width=8, units="in")
```





## d. NMDS+ protists (no phototrophs, no metazoan) grouped by Genus

```{r}
# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object

# select only phototrophs and mixotrophs
nmds <- subset_taxa(ps_V7_norm, !trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs") & !subdivision=="Metazoa") %>% tax_glom(.,taxrank="genus") %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_protists_nometazoan_V7_genus.png", width = 7, height = 5, dpi = 400)


p1<-ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  



p2<-ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
scale_x_reverse()+
  theme(legend.position = "none",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

(p1 | p2) +   plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = 'A')

ggsave("3_Figures/FigX_NMDS_protists_nometazoan_V7_genus_fish_fishless_sample.png", width = 12, height = 5, dpi = 400)


# add in d15N breakpoints 
nmds_meta <- nmds_meta %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
nmds_meta <- nmds_meta %>% group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm >= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm < d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# WA / CA / WY and highlight nmds d15N relationships 
p1<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_rect(fill = "black"),
    strip.text = element_text(color = "white"),
    axis.title.x = element_blank())+
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "none")



# low colored
p2<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start)==F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16, col="white") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1), size=2, pch = 16, col="gray") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name), size=2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_blank(),
                strip.text = element_blank(),
              axis.title.x = element_blank())+
        geom_smooth(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name),method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right") + 
        guides(color = guide_legend(override.aes = list(size = 4)))  




# show high colored
p3<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start)==F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16, col="white") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1), size=2, pch = 16, col="gray") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name), size=2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_blank(),
                strip.text = element_blank())+
        geom_smooth(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name),method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "none")


(p1 / p2 / p3) +   plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = 'A')




ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V7_protists_nometazoan_genus_multipanel.png",height=7, width=8, units="in")
```




## e. NMDS+ zooplankton
haven't finished this, not sure if it is the correct way to do this
```{r}
# remove ~4k taxa that assign to fungi
tax_fun<-read.csv("V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi" & class=="Rotifera" | family %in%c("Maxillopoda","Branchiopoda"))
tax_fun <- as.matrix(tax_fun) # convert to matrix
tax_table(ps_V7_norm) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object

<-as.matrix(otu_table(ps))


# convert to relative abundances and remove low abundance taxa
ps <-  ps_V7_norm %>% tax_glom(.,taxrank="genus")%>% filter_taxa(., function(x) max(x) >= 30, TRUE) %>%  transform_sample_counts(., function(x) x / sum(x)) 

Y<-as.data.frame(otu_table(ps))

pc <- princomp(Y, cor=T)


# select only zooplankton and rotifers 
nmds <- ps %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

ggsave("3_Figures/FigX_NMDS_other_V7_ESV.png", width = 7, height = 5, dpi = 400)


p1<-ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  



p2<-ggplot() +
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fishless"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth), color="gray88", 
            shape = 16) +  
  geom_point(data = nmds_meta %>% filter(fish_present_sample == "fish"), 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
scale_x_reverse()+
  theme(legend.position = "none",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  

(p1 | p2) +   plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = 'A')

ggsave("3_Figures/FigX_NMDS_other_V7_ESV_fish_fishless_sample.png", width = 12, height = 5, dpi = 400)


# add in d15N breakpoints 
nmds_meta <- nmds_meta %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
nmds_meta <- nmds_meta %>% group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm >= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm < d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# WA / CA / WY and highlight nmds d15N relationships 
p1<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start) == F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_rect(fill = "black"),
    strip.text = element_text(color = "white"),
    axis.title.x = element_blank())+
        geom_smooth(method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "none")



# low colored
p2<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start)==F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16, col="white") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1), size=2, pch = 16, col="gray") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name), size=2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_blank(),
                strip.text = element_blank(),
              axis.title.x = element_blank())+
        geom_smooth(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name),method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "right") + 
        guides(color = guide_legend(override.aes = list(size = 4)))  




# show high colored
p3<-ggplot(nmds_meta %>% filter(is.na(d15N_diff_from_start)==F), aes(y = MDS1, x = d15N_diff_from_start, color = lake_name)) +
        geom_point(size = 2, pch = 16, col="white") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="low"),
                   aes(x=d15N_diff_from_start, y=MDS1), size=2, pch = 16, col="gray") +
        geom_point(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name), size=2, pch = 16) +
        facet_wrap( ~ state) +
        scale_color_manual(values = lake_colors) +
        labs(y = "NMDS1", x = expression(Delta*delta^15 * "N"), color = "Lake") +
        custom_theme() +
        scale_y_reverse()+
        scale_x_reverse()+
        theme(strip.background = element_blank(),
                strip.text = element_blank())+
        geom_smooth(data=nmds_meta %>% filter(is.na(d15N_diff_from_start) == F& d15N_category=="high"),
                   aes(x=d15N_diff_from_start, y=MDS1, col=lake_name),method = "lm", se = F, linewidth = 2) +
        theme(legend.position = "none")


(p1 / p2 / p3) +   plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = 'A')




ggsave("3_Figures/FigX_D15N_anomaly_NMDS_V7_other_multipanel.png",height=7, width=8, units="in")
```



# NEW BELOW


# temperature histories
```{r}

# set colors for lakes
lake_colors <- c(
        "Canyon" = "#b9ceac",
        "Bullfrog" = "#BFEFFF",
        "Eyrie" = "darkolivegreen3",
        "Middle Gaylor" = "#008080",
        "Lightning" = "darkolivegreen",
        "Soldier" = "#0e4d92",
        "Black Rock" = "#FFBBFF",
        "Skelton" = "#63B8FF",
        "Footprint" = "#CD96CD",
        "Crescent" = "#EE6363",
        "Lost" = "#9696CD",
        "Louise" = "#FFA07A",
        "Scott" = "#5D478B",
        "Monogram" = "#EE30A7"
)

# order lake names for plot
metadata$lake_name <- factor(metadata$lake_name, levels = names(lake_colors))

ggplot(data=metadata, aes(x=date_mid_AD_combo,y=mean_air_temp_degC_interval))+
        facet_wrap2(
    ~ lake_name, ncol = 2, strip.position = "top",
    strip = strip_themed(
      background_x = elem_list_rect(fill = lake_colors),
      text_x = elem_list_text(
        color = ifelse(names(lake_colors) %in% c("Lightning", "Scott", "Middle Gaylor", "Soldier"), "white", "black"))))+
        geom_line() + custom_theme() + 
        labs(x = "Year", y = "Average annual air temperature (deg C) over sediment interval")+
        xlim(1895,2021)

ggsave("3_Figures/FigX_temperature_histories_averaged_interval.png", height=10,width=7)

# add in climate data from PRISM
prism <- read.csv("2_DataAnalysis/PRISM/PRISM_ppt_tmean_stable_4km_1895_2021.csv", header = TRUE, skip = 10) %>%
mutate(Name=case_when(Name=="Middle Gaylo"~"Middle Gaylor", 
                      TRUE ~Name)) %>%
  filter(complete.cases(.)) %>%
  rename(lake_name = 1) %>%
  mutate(lake_name = factor(lake_name)) %>%
  rename(precip_ppt_mm=ppt..mm.,
         mean_air_temp_degC=tmean..degrees.C., 
         longitude_prism=Longitude,
         latitude_prism=Latitude,
         elevation_prism=Elevation..m.) 

prism $lake_name <- factor(prism $lake_name, levels = names(lake_colors))


ggplot(data=prism, aes(x=Date,y=mean_air_temp_degC))+
        facet_wrap2(
    ~ lake_name, ncol = 2, strip.position = "top",
    strip = strip_themed(
      background_x = elem_list_rect(fill = lake_colors),
      text_x = elem_list_text(
        color = ifelse(names(lake_colors) %in% c("Lightning", "Scott", "Middle Gaylor", "Soldier"), "white", "black"))))+
        geom_line() + custom_theme() + 
        labs(x = "Year", y = "Average annual air temperature (deg C)")+
        xlim(1895,2021)

ggsave("3_Figures/FigX_temperature_histories.png", height=10,width=7)


```


```{r}

lake_colors <- c("Canyon" = "#b9ceac", "Eyrie" = "darkolivegreen3", "Lightning" = "darkolivegreen", 
                 "Black Rock" = "#FFBBFF", "Footprint" = "#CD96CD", "Lost" = "#9696CD", "Scott" = "#5D478B", 
                 "Bullfrog"= "#BFEFFF", "Middle Gaylor"= "#008080", "Soldier"="#0e4d92", "Skelton"="#63B8FF", 
                 "Crescent"= "#EE6363", "Louise"="#FFA07A","Monogram"="#EE30A7")

meta <- metadata %>% filter(is.na(mean_air_temp_degC_interval)==F) %>% arrange(lake_name, desc(bottom_cm))

breakpoint_summary<-data.frame(lake_name=NULL,breakpoint_1=NULL, breakpoint_2=NULL)
for(i in 1:14){
sub<-meta[meta$lake_name==unique(meta$lake_name)[i],names(meta)%in%c("sample_id","mean_air_temp_degC_interval")]
sub<-ts(sub$mean_air_temp_degC_interval, start=1,end=nrow(sub), frequency = 1)

## estimate breakpoints
bp.ri <- breakpoints(sub ~ 1, h = 3)
#plot(bp.ri)
sum<-summary(bp.ri)
one<-sum$breakpoints[1,]
#two<-sum$breakpoints[2,]

## fit segmented model with two breaks from minimized BIC
fac.ri <- breakfactor(bp.ri, breaks = 1, label = "seg")
fm.ri <- lm(sub ~ 0 + fac.ri)
#summary(fm.ri)

## Visualization
plot(sub, main=unique(meta$lake_name)[i])
lines(as.vector(time(sub)), fitted(fm.ri), col = 4)

breakpoint_summary<-rbind(breakpoint_summary, data.frame(lake_name=unique(meta$lake_name)[i],breakpoint_1=one[is.na(one)==F]))
}


print(breakpoint_summary)
breakpoint_index<-breakpoint_summary
names(breakpoint_index)[2]<-"breakpoint_index"


meta<-left_join(meta, breakpoint_index, join_by(lake_name))

meta <- meta %>%
  group_by(lake_name) %>%
  mutate(temperature_breakpoint_bottom_cm = bottom_cm[breakpoint_index],
         temperature_breakpoint_date = date_mid_AD_combo[breakpoint_index]) %>%
  ungroup()

meta <- meta %>%
  mutate(lake_name = factor(lake_name, levels = names(lake_colors)))  

#breakpoints bottom centimeter
ggplot(meta, aes(x=date_mid_AD_combo, y=mean_air_temp_degC_interval)) +
        geom_point()+
        geom_line()+
  facet_wrap2(~ lake_name, ncol=7, strip.position = "top", strip=strip_themed(background_x = elem_list_rect(fill = lake_colors))) +
        labs(y="Average annual air temperature (deg C) \n over sediment interval", x="Date (Common Era)") +
        geom_vline(data=meta %>% select(lake_name,temperature_breakpoint_date) %>% unique(.) %>%  filter(complete.cases(.)), aes(xintercept=temperature_breakpoint_date), color="black",linewidth=0.75) +
        custom_theme()
ggsave("3_Figures/FigX_temperature_breakpoints_date.png",height=4, width=15, units="in")

# write to CSV
lake_breakpoints<-meta %>% select(lake_name, temperature_breakpoint_bottom_cm,temperature_breakpoint_date) %>% unique(.) %>%  filter(complete.cases(.))

write.csv(lake_breakpoints, "2_DataAnalysis/temperature_breakpoints.csv")
```


## V7
### a. level 1 - phototrophic plankton

```{r}
# read in the functional assignment file remove ~4k taxa that assign to fungi
tax_fun<-read.csv("2_DataAnalysis/V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
ps_V7_norm_sub<-ps_V7_norm
tax_table(ps_V7_norm_sub) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object
rm(tax_fun)
ps_V7_norm_sub<-subset_taxa(ps_V7_norm_sub, trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs"))
```

#### i. NMDS
```{r}
# NMDS plot
set.seed(613)
nmds <- ps_V7_norm_sub %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  +
          annotate("text", x = min(nmds_meta$MDS1), y = max(nmds_meta$MDS2),
                   hjust=1,vjust=1,size = 5,
           label = paste("Stress =", round(nmds$stress, 3))) 

ggsave("3_Figures/FigX_V7_phytoplankton_NMDS_ESV.png", width = 7, height = 5, dpi = 400)
```


#### ii. relative abundance
```{r}

taxa_colors <- c("#009E73","#E69F00", "#56B4E9")
# set colors for lakes

# group by taxonomic rank and turn to relative abundance
sub <- ps_V7_norm_sub %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.35) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Chlorophyta_X" ~ "Chlorophyta",
                                             subdivision=="Streptophyta_X" ~ "Streptophyta",
                                             TRUE~subdivision
                                             ))

# add in d15N breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# add in temperature breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/temperature_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# # separate high and low d15N by the breakpoints
# sub <- sub %>%  group_by(lake_name)%>% 
#         mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
#                                         bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
#         ungroup()

# order lake names for plot
sub$lake_name <- factor(sub$lake_name, levels = names(lake_colors_2))

# label line type
sub <- sub %>%
  mutate(line_type = case_when(
    !is.na(d15N_breakpoint_date) ~ "N isotope breakpoint",
    !is.na(first_stocked_yr) ~ "Year fish first stocked",
    TRUE ~ NA_character_
  ))



ggplot(data = sub, aes(x = date_mid_AD_combo, y = Abundance, color = subdivision)) +
  facet_wrap2(
    ~ lake_name, ncol = 2, strip.position = "top",
    strip = strip_themed(
      background_x = elem_list_rect(fill = lake_colors_2),
      text_x = elem_list_text(
        color = ifelse(names(lake_colors_2) %in% c("Lightning", "Scott", "Middle Gaylor", "Soldier"), "white", "black")))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)", color = "Taxonomic group", linetype = "") +
  geom_line(aes(group = subdivision), linewidth = 1.1) +         
  custom_theme() + 
  geom_vline(
    data = sub %>% filter(!is.na(d15N_breakpoint_date)), 
    aes(xintercept = d15N_breakpoint_date, linetype = "N isotope breakpoint"), 
    color = "black", linewidth = 0.75
  ) +
  geom_vline(
    data = sub %>% filter(!is.na(first_stocked_yr)), 
    aes(xintercept = first_stocked_yr, linetype = "Year fish first stocked"), 
    color = "black", linewidth = 0.75
  ) +
  geom_vline(
    data = sub %>% filter(!is.na(temperature_breakpoint_date)), 
    aes(xintercept = temperature_breakpoint_date, linetype = "Temperature breakpoint"), 
    color = "black", linewidth = 0.75
  )+
  scale_color_manual(values = taxa_colors) +
 scale_linetype_manual(
    values = c("N isotope breakpoint" = "dotted", "Year fish first stocked" = "solid", "Temperature breakpoint" = "dashed"),
    breaks = c("N isotope breakpoint", "Year fish first stocked", "Temperature breakpoint") # Specify order here
  )+
          guides(
    linetype = guide_legend(
      keyheight = 2))
 

ggsave("3_Figures/FigX_V7_phytoplankton_top_relative_abundance.png",height=10, width=10, units="in")

```


#### iii. linear mixed effects models
```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,subdivision, mid_cm) %>%   
        arrange(lake_name,subdivision,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)


model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)


model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"),
        term = factor(term, levels = c("Intercept","Mean annual air\ntemperature (deg C)","d15N", "Fish presence"))) %>% filter(!term=="Intercept")


ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

ggsave("3_Figures/FigX_V7_phytoplankton_top_LME.png",height=4, width=7, units="in")


write.csv(as.data.frame(model_output), "2_DataAnalysis/V7_LME_phytoplankton_model_output.csv")
```
left off here, tried to do this by lake but when you loop through each lake then it isn't a mixed effect model anymore, tried just linear models but that takes away the ability to do autocorrelation. The output of this does not show a long of significant trends with any of the data which is suprising since it shows up in the lmes. Tried gls but got errors about "Error in glsEstimate(object, control = control) : computed "gls" fit is singular, rank 4" when I tried to keep autocorrelation. 





### b. level 2 - heterotrophic protists
#### i. NMDS
```{r}
# read in the functional assignment file remove ~4k taxa that assign to fungi
tax_fun<-read.csv("2_DataAnalysis/V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
ps_V7_norm_sub<-ps_V7_norm
tax_table(ps_V7_norm_sub) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object
rm(tax_fun)
ps_V7_norm_sub<-subset_taxa(ps_V7_norm_sub, !trophic_mode %in% c("phototrophs","phototrophs/mixotrophs","mixotrophs" )& !class %in% c("Arthropoda","Unassigned","Nematoda","Craniata","Tardigrada","Annelida","Gastrotricha","Platyhelminthes","Porifera","Mollusca","Metazoa_X","Cnidaria","Bryozoa")) 
# remove phototrophic/mixotrophic organisms and keep only Rotifers from the metazoan subdivision
```


```{r}
# NMDS plot
set.seed(613)
nmds <- ps_V7_norm_sub %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  +
          annotate("text", x = min(nmds_meta$MDS1), y = max(nmds_meta$MDS2),
                   hjust=1,vjust=1,size = 5,
           label = paste("Stress =", round(nmds$stress, 3))) 

ggsave("3_Figures/FigX_V7_heterotrophic_protists_NMDS_ESV.png", width = 7, height = 5, dpi = 400)
```


#### ii. relative abundance
```{r}

taxa_colors<-c( "#E69F00" ,"#56B4E9" ,"#009E73", "#F0E442" ,"#0072B2" ,"#D55E00" ,"#CC79A7" ,"#999999")

# group by taxonomic rank and turn to relative abundance
sub <- ps_V7_norm_sub %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.6) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$subdivision)

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Evosea_X" ~ "Evosea",
                                             subdivision=="Metazoa" ~ "Rotifera",
                                             TRUE~subdivision
                                             ))

# add in d15N breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# add in temperature breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/temperature_breakpoints.csv", header=T,row.names=1), join_by(lake_name))


# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# order lake names for plot
sub$lake_name <- factor(sub$lake_name, levels = names(lake_colors_2))

# label line type
sub <- sub %>%
  mutate(line_type = case_when(
    !is.na(d15N_breakpoint_date) ~ "N isotope breakpoint",
    !is.na(first_stocked_yr) ~ "Year fish first stocked",
    TRUE ~ NA_character_
  ))



ggplot(data = sub, aes(x = date_mid_AD_combo, y = Abundance, color = subdivision)) +
  facet_wrap2(
    ~ lake_name, ncol = 2, strip.position = "top",
    strip = strip_themed(
      background_x = elem_list_rect(fill = lake_colors_2),
      text_x = elem_list_text(
        color = ifelse(names(lake_colors_2) %in% c("Lightning", "Scott", "Middle Gaylor", "Soldier"), "white", "black")))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)", color = "Taxonomic group", linetype = "") +
  geom_line(aes(group = subdivision), linewidth = 1.1) +         
  custom_theme() + 
  geom_vline(
    data = sub %>% filter(!is.na(d15N_breakpoint_date)), 
    aes(xintercept = d15N_breakpoint_date, linetype = "N isotope breakpoint"), 
    color = "black", linewidth = 0.75
  ) +
  geom_vline(
    data = sub %>% filter(!is.na(first_stocked_yr)), 
    aes(xintercept = first_stocked_yr, linetype = "Year fish first stocked"), 
    color = "black", linewidth = 0.75
  ) +
        geom_vline(
    data = sub %>% filter(!is.na(temperature_breakpoint_date)), 
    aes(xintercept = temperature_breakpoint_date, linetype = "Temperature breakpoint"), 
    color = "black", linewidth = 0.75
  )+
  scale_color_manual(values = taxa_colors) +
 scale_linetype_manual(
    values = c("N isotope breakpoint" = "dotted", "Year fish first stocked" = "solid", "Temperature breakpoint" = "dashed"),
    breaks = c("N isotope breakpoint", "Year fish first stocked", "Temperature breakpoint") # Specify order here
  )+
          guides(
    linetype = guide_legend(
      keyheight = 2))
 

ggsave("3_Figures/FigX_V7_heterotrophic_protists_top_relative_abundance.png",height=10, width=10, units="in")

```


#### iii. linear mixed effects models
```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,subdivision, mid_cm) %>%   
        arrange(lake_name,subdivision,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)


model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"),
        term = factor(term, levels = c("Intercept","Mean annual air\ntemperature (deg C)","d15N", "Fish presence"))) %>% filter(!term=="Intercept")


ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

ggsave("3_Figures/FigX_V7_heterotrophic_protists_top_LME.png",height=4, width=7, units="in")


write.csv(as.data.frame(model_output), "2_DataAnalysis/V7_LME_heterotrophic_protists_model_output.csv")
```



### c. level 3 - zooplankton
#### NCBI BLAST

Using ps_V7_norm_sub so that I don't have to rerun (not changing ps_V7_norm from original). I did this for the ones above as well.
```{r}
# read in taxonomy assigned in Ch. 2
tax_blast<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/ZooplanktonSedDNA/5_DataAnalysis/BLAST_zooplankton/Max_Bra/5_BLAST_V7_original_single_multiple.csv", row.names=1,na.strings="") %>% column_to_rownames(., var="qseqid") %>% 
   mutate(Genus_plus = replace_na(Genus_plus, "Unassigned")) %>% select(Kingdom,Genus_plus) %>% filter(Genus_plus %in% c("Hesperodiaptomus", "Holopedium", "Ceriodaphnia", "Daphnia", "Chydoridae", "Leptodiaptomus", "Bosmina", "Cyclopidae")) # don't include "Harpacticoida" because generally sediment dwelling copepods and we have low abundances anyway!
tax_blast <- as.matrix(tax_blast) # convert to matrix
ps_V7_norm_sub<-ps_V7_norm
tax_table(ps_V7_norm_sub) <- tax_table(tax_blast) # replace taxonomy table in the phyloseq object
rm(tax_blast)

# congomerate right away to genus_plus
ps_V7_norm_sub <- ps_V7_norm_sub %>% tax_glom(., taxrank = "Genus_plus")
```

#### i. NMDS
```{r}
# NMDS plot
set.seed(613)
nmds <- ps_V7_norm_sub %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  +
          annotate("text", x = max(nmds_meta$MDS1), y = max(nmds_meta$MDS2),
                   hjust=0,vjust=1,size = 5,
           label = paste("Stress =", round(nmds$stress, 3))) 

ggsave("3_Figures/FigX_V7_zooplankton_NMDS_ESV.png", width = 7, height = 5, dpi = 400)
```


#### ii. relative abundance
```{r}


taxa_colors<-palette.colors(palette = "Okabe-Ito")
taxa_colors<-c("gray50", "#E69F00" ,"#56B4E9" ,"#009E73" ,"#D55E00" ,"#F0E442" ,"#0072B2")

# group by taxonomic rank and turn to relative abundance
sub <- ps_V7_norm_sub %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(Genus_plus%in%c(
        sub %>% filter(Abundance > 0.2) %>% select(Genus_plus) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$Genus_plus)


# add in d15N breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# add in temperature breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/temperature_breakpoints.csv", header=T,row.names=1), join_by(lake_name))


# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# order lake names for plot
sub$lake_name <- factor(sub$lake_name, levels = names(lake_colors_2))

# label line type
sub <- sub %>%
  mutate(line_type = case_when(
    !is.na(d15N_breakpoint_date) ~ "N isotope breakpoint",
    !is.na(first_stocked_yr) ~ "Year fish first stocked",
    TRUE ~ NA_character_
  ))



ggplot(data = sub, aes(x = date_mid_AD_combo, y = Abundance, color = Genus_plus)) +
  facet_wrap2(
    ~ lake_name, ncol = 2, strip.position = "top",
    strip = strip_themed(
      background_x = elem_list_rect(fill = lake_colors_2),
      text_x = elem_list_text(
        color = ifelse(names(lake_colors_2) %in% c("Lightning", "Scott", "Middle Gaylor", "Soldier"), "white", "black")))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)", color = "Taxonomic group", linetype = "") +
  geom_line(aes(group = Genus_plus), linewidth = 1.1) +         
  custom_theme() + 
  geom_vline(
    data = sub %>% filter(!is.na(d15N_breakpoint_date)), 
    aes(xintercept = d15N_breakpoint_date, linetype = "N isotope breakpoint"), 
    color = "black", linewidth = 0.75
  ) +
  geom_vline(
    data = sub %>% filter(!is.na(first_stocked_yr)), 
    aes(xintercept = first_stocked_yr, linetype = "Year fish first stocked"), 
    color = "black", linewidth = 0.75
  ) +
        geom_vline(
    data = sub %>% filter(!is.na(temperature_breakpoint_date)), 
    aes(xintercept = temperature_breakpoint_date, linetype = "Temperature breakpoint"), 
    color = "black", linewidth = 0.75
  )+
  scale_color_manual(values = taxa_colors) +
 scale_linetype_manual(
    values = c("N isotope breakpoint" = "dotted", "Year fish first stocked" = "solid", "Temperature breakpoint" = "dashed"),
    breaks = c("N isotope breakpoint", "Year fish first stocked", "Temperature breakpoint") # Specify order here
  )+
          guides(
    linetype = guide_legend(
      keyheight = 2))
 

ggsave("3_Figures/FigX_V7_zooplankton_top_relative_abundance.png",height=10, width=10, units="in")

```


#### iii. linear mixed effects models
```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,Genus_plus, mid_cm) %>%   
        arrange(lake_name,Genus_plus,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

model_output<-as_tibble(NULL)
for(i in unique(lme_data$Genus_plus)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(Genus_plus == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term")%>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)


model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"),
        term = factor(term, levels = c("Intercept","Mean annual air\ntemperature (deg C)","d15N", "Fish presence"))) %>% filter(!term=="Intercept")


ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

ggsave("3_Figures/FigX_V7_zooplankton_LME.png",height=4, width=7, units="in")


write.csv(as.data.frame(model_output), "2_DataAnalysis/V7_LME_zooplankton_model_output.csv")
```




## V9
### a. level 1 - phototrophic plankton

```{r}
# read in the functional assignment file remove ~4k taxa that assign to fungi
tax_fun<-read.csv("2_DataAnalysis/V9_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object
rm(tax_fun)
ps_V9_norm_sub<-subset_taxa(ps_V9_norm_sub, trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs"))
```

#### i. NMDS
```{r}
# NMDS plot
set.seed(613)
nmds <- ps_V9_norm_sub %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

NMDS<-ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS2, y = MDS1, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS2", y = "NMDS1") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  +
          annotate("text", x = min(nmds_meta$MDS2), y = max(nmds_meta$MDS1),
                   hjust=1,vjust=1,size = 5,
           label = paste("Stress =", round(nmds$stress, 3))) 

#ggsave("3_Figures/FigX_V9_phytoplankton_NMDS_ESV.png", width = 7, height = 5, dpi = 400)
```





#### ii. select taxa
```{r}
taxa_colors <- c("#009E73","#E69F00", "#56B4E9", "#D55E00")
# set colors for lakes

# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_sub %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.35) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Chlorophyta_X" ~ "Chlorophyta",
                                             subdivision=="Streptophyta_X" ~ "Streptophyta",
                                             TRUE~subdivision
                                             ))

# add in d15N breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# add in temperature breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/temperature_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# order lake names for plot
sub$lake_name <- factor(sub$lake_name, levels = names(lake_colors_2))

# label line type
sub <- sub %>%
  mutate(line_type = case_when(
    !is.na(d15N_breakpoint_date) ~ "N isotope breakpoint",
    !is.na(first_stocked_yr) ~ "Year fish first stocked",
    TRUE ~ NA_character_
  ))
```



#### iii. linear mixed effects models
```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,subdivision, mid_cm) %>%   
        arrange(lake_name,subdivision,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

# no interactions
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"),
        term = factor(term, levels = c("Intercept","Mean annual air\ntemperature (deg C)","d15N", "Fish presence"))) %>% filter(!term=="Intercept")


LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

#ggsave("3_Figures/FigX_V9_phytoplankton_top_LME.png",height=4, width=7, units="in")


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_phytoplankton_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)

```

With interactions
```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,subdivision, mid_cm) %>%   
        arrange(lake_name,subdivision,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)



# interaction fish and nitrogen
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary + d15N_diff_from_start*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No"))

# yes interactions fish and nitrogen


model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence",
                                term=="d15N_diff_from_start:fish_present_binary"~"d15N x fish presence")) %>% filter(!term=="Intercept")

LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

#ggsave("3_Figures/FigX_V9_phytoplankton_top_LME.png",height=4, width=7, units="in")


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_phytoplankton_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```




#### iv. plot for relative abundance
```{r}
# add line thickness for significant taxa
sub <- sub %>%
  mutate(line_thickness = factor(ifelse(subdivision %in% sig_taxa, "Significant", "Non-significant")))

RA <- ggplot(data = sub, aes(x = date_mid_AD_combo, y = Abundance, color = subdivision)) +
  facet_wrap2(
    ~ lake_name, ncol = 2, strip.position = "top",
    strip = strip_themed(
      background_x = elem_list_rect(fill = lake_colors_2),
      text_x = elem_list_text(
        color = ifelse(names(lake_colors_2) %in% c("Lightning", "Scott", "Middle Gaylor", "Soldier"), "white", "black")))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)", color = "Taxonomic group", linetype = "") +
  geom_line(aes(group = subdivision, linewidth = line_thickness)) +         
  custom_theme() + 
  geom_vline(
    data = sub %>% filter(!is.na(d15N_breakpoint_date)), 
    aes(xintercept = d15N_breakpoint_date, linetype = "N isotope breakpoint"), 
    color = "black", linewidth = 0.75
  ) +
  geom_vline(
    data = sub %>% filter(!is.na(first_stocked_yr)), 
    aes(xintercept = first_stocked_yr, linetype = "Year fish first stocked"), 
    color = "black", linewidth = 0.75
  ) +
  geom_vline(
    data = sub %>% filter(!is.na(temperature_breakpoint_date)), 
    aes(xintercept = temperature_breakpoint_date, linetype = "Temperature breakpoint"), 
    color = "black", linewidth = 0.75
  ) +
  scale_color_manual(values = taxa_colors) +
  scale_linetype_manual(
    values = c("N isotope breakpoint" = "dotted", "Year fish first stocked" = "solid", "Temperature breakpoint" = "dashed"),
    breaks = c("N isotope breakpoint", "Year fish first stocked", "Temperature breakpoint") # Specify order here
  ) +
  guides(
    linetype = guide_legend(
      keyheight = 2),
    linewidth = "none") +
  scale_linewidth_manual(
    values = c("Non-significant" = 0.5, "Significant" = 1.3))

 

#ggsave("3_Figures/FigX_V9_phytoplankton_top_relative_abundance.png",height=10, width=10, units="in")

```


#### v. plot all together
```{r}

(RA|(NMDS/LME)) + plot_layout(widths = c(1.5, 1))

ggsave("3_Figures/FigX_V9_phytoplankton_NMDS_RelAbun_LME.png",height=10, width=20, units="in")

```




### b. level 2 - heterotrophic protists
#### i. NMDS
```{r}
# read in the functional assignment file remove ~4k taxa that assign to fungi
tax_fun<-read.csv("2_DataAnalysis/V9_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object
rm(tax_fun)
ps_V9_norm_sub<-subset_taxa(ps_V9_norm_sub, !trophic_mode %in% c("phototrophs","phototrophs/mixotrophs","mixotrophs" )& !class %in% c("Arthropoda","Unassigned","Nematoda","Craniata","Tardigrada","Annelida","Gastrotricha","Platyhelminthes","Porifera","Mollusca","Metazoa_X","Cnidaria","Bryozoa")) 
# remove phototrophic/mixotrophic organisms and keep only Rotifers from the metazoan subdivision
```


```{r}
# NMDS plot
set.seed(613)
nmds <- ps_V9_norm_sub %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

NMDS<-ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS2, y = MDS1, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS2", y = "NMDS1") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  +
          annotate("text", x = min(nmds_meta$MDS2), y = max(nmds_meta$MDS1),
                   hjust=1,vjust=1,size = 5,
           label = paste("Stress =", round(nmds$stress, 3))) 

#ggsave("3_Figures/FigX_V9_heterotrophic_protists_NMDS_ESV.png", width = 7, height = 5, dpi = 400)
```




#### ii. select taxa
```{r}
taxa_colors<-c( "#E69F00" ,"#56B4E9" ,"#009E73", "#F0E442" ,"#0072B2" ,"#D55E00" ,"#CC79A7" ,"#999999")




# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_sub %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.6) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$subdivision)

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Evosea_X" ~ "Evosea",
                                             subdivision=="Metazoa" ~ "Rotifera",
                                             TRUE~subdivision
                                             ))
# add in d15N breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# add in temperature breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/temperature_breakpoints.csv", header=T,row.names=1), join_by(lake_name))


# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# order lake names for plot
sub$lake_name <- factor(sub$lake_name, levels = names(lake_colors_2))

# label line type
sub <- sub %>%
  mutate(line_type = case_when(
    !is.na(d15N_breakpoint_date) ~ "N isotope breakpoint",
    !is.na(first_stocked_yr) ~ "Year fish first stocked",
    TRUE ~ NA_character_
  ))
```



#### iii. linear mixed effects models
```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,subdivision, mid_cm) %>%   
        arrange(lake_name,subdivision,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)


model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"),
        term = factor(term, levels = c("Intercept","Mean annual air\ntemperature (deg C)","d15N", "Fish presence"))) %>% filter(!term=="Intercept")


p1<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

# ggsave("3_Figures/FigX_V9_heterotrophic_protists_top_LME.png",height=4, width=7, units="in")


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_heterotrophic_protists_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```


with interactions - used this one
```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,subdivision, mid_cm) %>%   
        arrange(lake_name,subdivision,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

# interactions
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary +  mean_air_temp_degC_interval*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)
# no interaction of fish and nitrogen
# no interaction of climate and nitrogen
# yes interaction of fish and climate



model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence",
                                term=="mean_air_temp_degC_interval:fish_present_binary"~"Mean annual air\ntemperature (deg C) x\nfish presence")) %>% filter(!term=="Intercept")


LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

# ggsave("3_Figures/FigX_V9_heterotrophic_protists_top_LME.png",height=4, width=7, units="in")


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_heterotrophic_protists_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```


#### iv. relative abundance plot
```{r}
# add line thickness for significant taxa
sub <- sub %>%
  mutate(line_thickness = factor(ifelse(subdivision %in% sig_taxa, "Significant", "Non-significant")))

RA<-ggplot(data = sub, aes(x = date_mid_AD_combo, y = Abundance, color = subdivision)) +
  facet_wrap2(
    ~ lake_name, ncol = 2, strip.position = "top",
    strip = strip_themed(
      background_x = elem_list_rect(fill = lake_colors_2),
      text_x = elem_list_text(
        color = ifelse(names(lake_colors_2) %in% c("Lightning", "Scott", "Middle Gaylor", "Soldier"), "white", "black")))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)", color = "Taxonomic group", linetype = "") +
  geom_line(aes(group = subdivision, linewidth = line_thickness)) +         
  custom_theme() + 
  geom_vline(
    data = sub %>% filter(!is.na(d15N_breakpoint_date)), 
    aes(xintercept = d15N_breakpoint_date, linetype = "N isotope breakpoint"), 
    color = "black", linewidth = 0.75
  ) +
  geom_vline(
    data = sub %>% filter(!is.na(first_stocked_yr)), 
    aes(xintercept = first_stocked_yr, linetype = "Year fish first stocked"), 
    color = "black", linewidth = 0.75
  ) +
        geom_vline(
    data = sub %>% filter(!is.na(temperature_breakpoint_date)), 
    aes(xintercept = temperature_breakpoint_date, linetype = "Temperature breakpoint"), 
    color = "black", linewidth = 0.75
  )+
  scale_color_manual(values = taxa_colors) +
 scale_linetype_manual(
    values = c("N isotope breakpoint" = "dotted", "Year fish first stocked" = "solid", "Temperature breakpoint" = "dashed"),
    breaks = c("N isotope breakpoint", "Year fish first stocked", "Temperature breakpoint") # Specify order here
  )+
          guides(
    linetype = guide_legend(
      keyheight = 2))+
  scale_linewidth_manual(
    values = c("Non-significant" = 0.5, "Significant" = 1.3))
 

#ggsave("3_Figures/FigX_V9_heterotrophic_protists_top_relative_abundance.png",height=10, width=10, units="in")

```


#### v. plot all together
```{r}

(RA|(NMDS/LME)) + plot_layout(widths = c(1.5, 1))

ggsave("3_Figures/FigX_V9_heterotrophic_protist_NMDS_RelAbun_LME.png",height=10, width=20, units="in")

```




### c. level 3 - zooplankton
#### NCBI BLAST

Using ps_V9_norm_sub so that I don't have to rerun (not changing ps_V9_norm from original). I did this for the ones above as well.
```{r}
# read in taxonomy assigned in Ch. 2
tax_blast<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/ZooplanktonSedDNA/5_DataAnalysis/BLAST_zooplankton/Max_Bra/5_BLAST_V9_original_single_multiple.csv", row.names=1,na.strings="") %>% column_to_rownames(., var="qseqid") %>% 
   mutate(Genus_plus = replace_na(Genus_plus, "Unassigned")) %>% select(Kingdom,Genus_plus) %>% filter(Genus_plus %in% c("Hesperodiaptomus", "Holopedium", "Ceriodaphnia", "Daphnia", "Chydoridae", "Leptodiaptomus", "Bosmina", "Cyclopidae")) # don't include "Harpacticoida" because generally sediment dwelling copepods and we have low abundances anyway!
tax_blast <- as.matrix(tax_blast) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_blast) # replace taxonomy table in the phyloseq object
rm(tax_blast)

# congomerate right away to genus_plus
ps_V9_norm_sub <- ps_V9_norm_sub %>% tax_glom(., taxrank = "Genus_plus")
```

#### i. NMDS
```{r}
# NMDS plot
set.seed(613)
nmds <- ps_V9_norm_sub %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

NMDS<-ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS1, y = MDS2, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS1", y = "NMDS2") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  +
          annotate("text", x = max(nmds_meta$MDS1), y = max(nmds_meta$MDS2),
                   hjust=0,vjust=1,size = 5,
           label = paste("Stress =", round(nmds$stress, 3))) 

#ggsave("3_Figures/FigX_V9_zooplankton_NMDS_ESV.png", width = 7, height = 5, dpi = 400)
```


#### ii. select taxa
```{r}
taxa_colors<-palette.colors(palette = "Okabe-Ito")
taxa_colors<-c("gray50", "#E69F00" ,"#56B4E9" ,"#009E73" ,"#D55E00" ,"#F0E442" ,"#0072B2","gray")

# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_sub %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(Genus_plus%in%c(
        sub %>% filter(Abundance > 0.4) %>% select(Genus_plus) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$Genus_plus)


# add in d15N breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# add in temperature breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/temperature_breakpoints.csv", header=T,row.names=1), join_by(lake_name))


# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# order lake names for plot
sub$lake_name <- factor(sub$lake_name, levels = names(lake_colors_2))

# label line type
sub <- sub %>%
  mutate(line_type = case_when(
    !is.na(d15N_breakpoint_date) ~ "N isotope breakpoint",
    !is.na(first_stocked_yr) ~ "Year fish first stocked",
    TRUE ~ NA_character_
  ))
```



#### iii. linear mixed effects models
```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,Genus_plus, mid_cm) %>%   
        arrange(lake_name,Genus_plus,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

model_output<-as_tibble(NULL)
for(i in unique(lme_data$Genus_plus)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(Genus_plus == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term")%>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)


model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"),
        term = factor(term, levels = c("Intercept","Mean annual air\ntemperature (deg C)","d15N", "Fish presence"))) %>% filter(!term=="Intercept")


ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

#ggsave("3_Figures/FigX_V9_zooplankton_LME.png",height=4, width=7, units="in")


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_zooplankton_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)


```



```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,Genus_plus, mid_cm) %>%   
        arrange(lake_name,Genus_plus,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

model_output<-as_tibble(NULL)
for(i in unique(lme_data$Genus_plus)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary +mean_air_temp_degC_interval*fish_present_binary + fish_present_binary*d15N_diff_from_start ,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(Genus_plus == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term")%>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)

# yes fish and nitrogen for leptodiaptomus
# yes fish and climate
# no climate and nitrogen

model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence",
                                term=="d15N_diff_from_start:fish_present_binary"~"d15N x fish presence",
                                term=="mean_air_temp_degC_interval:fish_present_binary"~"Mean annual air\ntemperature (deg C) x\nfish presence")) %>% filter(!term=="Intercept")


LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

#ggsave("3_Figures/FigX_V9_zooplankton_LME.png",height=4, width=7, units="in")


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_zooplankton_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```



#### iv. plot relative abundance
```{r}

# add line thickness for significant taxa
sub <- sub %>%
  mutate(line_thickness = factor(ifelse(Genus_plus %in% sig_taxa, "Significant", "Non-significant")))

RA<-ggplot(data = sub, aes(x = date_mid_AD_combo, y = Abundance, color = Genus_plus)) +
  facet_wrap2(
    ~ lake_name, ncol = 2, strip.position = "top",
    strip = strip_themed(
      background_x = elem_list_rect(fill = lake_colors_2),
      text_x = elem_list_text(
        color = ifelse(names(lake_colors_2) %in% c("Lightning", "Scott", "Middle Gaylor", "Soldier"), "white", "black")))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)", color = "Taxonomic group", linetype = "") +
  geom_line(aes(group = Genus_plus, linewidth = line_thickness)) +         
  custom_theme() + 
  geom_vline(
    data = sub %>% filter(!is.na(d15N_breakpoint_date)), 
    aes(xintercept = d15N_breakpoint_date, linetype = "N isotope breakpoint"), 
    color = "black", linewidth = 0.75
  ) +
  geom_vline(
    data = sub %>% filter(!is.na(first_stocked_yr)), 
    aes(xintercept = first_stocked_yr, linetype = "Year fish first stocked"), 
    color = "black", linewidth = 0.75
  ) +
        geom_vline(
    data = sub %>% filter(!is.na(temperature_breakpoint_date)), 
    aes(xintercept = temperature_breakpoint_date, linetype = "Temperature breakpoint"), 
    color = "black", linewidth = 0.75
  )+
  scale_color_manual(values = taxa_colors) +
 scale_linetype_manual(
    values = c("N isotope breakpoint" = "dotted", "Year fish first stocked" = "solid", "Temperature breakpoint" = "dashed"),
    breaks = c("N isotope breakpoint", "Year fish first stocked", "Temperature breakpoint") # Specify order here
  )+
          guides(
    linetype = guide_legend(
      keyheight = 2))+
  scale_linewidth_manual(
    values = c("Non-significant" = 0.5, "Significant" = 1.3))
 

#ggsave("3_Figures/FigX_V9_zooplankton_top_relative_abundance.png",height=10, width=10, units="in")

```


#### v. plot all together
```{r}

(RA|(NMDS/LME)) + plot_layout(widths = c(1.5, 1))

ggsave("3_Figures/FigX_V9_zooplankton_NMDS_RelAbun_LME.png",height=10, width=20, units="in")

```

Notes: one thing to change would be that we use subdivision for phytoplankton and heterotrophic protists and then Genus_plus for zooplankton


## GLS models

### V7

```{r}
## PHYTOPLANKTON AND HETEROTROPHIC PROTISTS
# read in the functional assignment file remove ~4k taxa that assign to fungi
tax_fun<-read.csv("2_DataAnalysis/V7_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
ps_V7_norm_sub<-ps_V7_norm
tax_table(ps_V7_norm_sub) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object
rm(tax_fun)


ps_V7_norm_phyto<-subset_taxa(ps_V7_norm_sub, trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs"))
# group by taxonomic rank and turn to relative abundance
sub <- ps_V7_norm_phyto %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.35) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Chlorophyta_X" ~ "Chlorophyta",
                                             subdivision=="Streptophyta_X" ~ "Streptophyta",
                                             TRUE~subdivision
                                             ))


all_trophic<-sub %>% rename(taxonomic_group=subdivision) %>% mutate(trophic_level="phytoplankton")

ps_V7_norm_hetero<-subset_taxa(ps_V7_norm_sub, !trophic_mode %in% c("phototrophs","phototrophs/mixotrophs","mixotrophs" )& !class %in% c("Arthropoda","Unassigned","Nematoda","Craniata","Tardigrada","Annelida","Gastrotricha","Platyhelminthes","Porifera","Mollusca","Metazoa_X","Cnidaria","Bryozoa")) 

# group by taxonomic rank and turn to relative abundance
sub <- ps_V7_norm_hetero %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.6) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$subdivision)

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Evosea_X" ~ "Evosea",
                                             subdivision=="Metazoa" ~ "Rotifera",
                                             TRUE~subdivision
                                             ))

all_trophic<-sub %>% rename(taxonomic_group=subdivision)%>% mutate(trophic_level="heterotrophic protists") %>% rbind(all_trophic,.)

# remove other taxonomic levels aside from taxonomic_group
all_trophic <- all_trophic %>% select(-c(domain,supergroup,division))

# ZOOPLANKTON
# read in taxonomy assigned in Ch. 2
tax_blast<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/ZooplanktonSedDNA/5_DataAnalysis/BLAST_zooplankton/Max_Bra/5_BLAST_V7_original_single_multiple.csv", row.names=1,na.strings="") %>% column_to_rownames(., var="qseqid") %>% 
   mutate(Genus_plus = replace_na(Genus_plus, "Unassigned")) %>% select(Kingdom,Genus_plus) %>% filter(Genus_plus %in% c("Hesperodiaptomus", "Holopedium", "Ceriodaphnia", "Daphnia", "Chydoridae", "Leptodiaptomus", "Bosmina", "Cyclopidae")) # don't include "Harpacticoida" because generally sediment dwelling copepods and we have low abundances anyway!
tax_blast <- as.matrix(tax_blast) # convert to matrix
ps_V7_norm_sub<-ps_V7_norm
tax_table(ps_V7_norm_sub) <- tax_table(tax_blast) # replace taxonomy table in the phyloseq object
rm(tax_blast)

# congomerate right away to genus_plus
ps_V7_norm_zoop <- ps_V7_norm_sub %>% tax_glom(., taxrank = "Genus_plus")


# group by taxonomic rank and turn to relative abundance
sub <- ps_V7_norm_zoop %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(Genus_plus%in%c(
        sub %>% filter(Abundance > 0.4) %>% select(Genus_plus) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$Genus_plus)

sub <- sub %>% select(-Kingdom)

all_trophic<-sub %>% rename(taxonomic_group=Genus_plus) %>% mutate(trophic_level="zooplankton") %>% rbind(all_trophic,.)


# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
gls_data <-all_trophic %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,taxonomic_group, mid_cm, fish, trophic_level) %>% arrange(trophic_level, taxonomic_group,lake_name,desc(mid_cm)) %>% group_by(lake_name, taxonomic_group) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start) %>% rename(abundance=Abundance)


model_output <- as_tibble(NULL)

for (l in unique(gls_data$lake_name)) {
  for (i in unique(gls_data$taxonomic_group)) {
    subset <- gls_data %>% filter(taxonomic_group == i & lake_name == l)
   if (subset$fish[1] == 0) {
      model <- try(gls(abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start,
                       data = subset, correlation = corAR1(form = ~ time_seq)), silent = TRUE)
    } else {
      model <- try(gls(abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary,
                       data = subset, correlation = corAR1(form = ~ time_seq)), silent = TRUE)
    }

    # if the model throws a singularity error (for series where the abundance is 0 the whole time), then put NAs
    if (inherits(model, "try-error")) {
      model_table <- tibble(
        term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary"),
        Value = NA_real_,
        Std.Error = NA_real_,
        t.value = NA_real_,
        taxonomic_group = i,
        lake_name = l,
        trophic_level = subset$trophic_level[1]
      )
    } else {
      model_summary <- summary(model)
      model_table <- as_tibble(coef(model_summary), rownames = "term")
      model_table <- model_table %>%
        mutate(taxonomic_group = i, lake_name = l, trophic_level = subset$trophic_level[1]) %>%
        setNames(make.names(names(.))) %>%
        filter(term != "(Intercept)")
    }
    model_output <- bind_rows(model_output, model_table)
  }}; rm(model, i, l, model_table, model_summary)
# relabel some names to lower case
model_output<-model_output %>% rename(estimate=Value, std.error=Std.Error)

# remove extra dataframes
rm(gls_data,subset,sub,ps_V7_norm_hetero,ps_V7_norm_phyto,ps_V7_norm_zoop,ps_V7_norm_sub,all_trophic)

```

#### by lake
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_lake <- model_output %>% filter(p.value<0.06) %>%
  group_by(trophic_level, lake_name, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop') %>% 
  arrange(trophic_level, lake_name, term) 
        
# make complete set of all combinations
complete_rows <- expand.grid(
  lake_name = names(lake_colors), # fishless lakes
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_lake<-left_join(complete_rows, effect_summary_lake, join_by(lake_name,trophic_level,term)) %>% 
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect))


effect_summary_lake$trophic_level<-factor(effect_summary_lake$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))
effect_summary_lake$lake_name<-factor(effect_summary_lake$lake_name, levels=names(lake_colors))

p1<-ggplot(effect_summary_lake, aes(x = lake_name, y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "Lake",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p2<-ggplot(effect_summary_lake, aes(x = lake_name, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "Lake",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

#### by state
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_state <- model_output %>% filter(p.value<0.06) %>%
        mutate(state=case_when(lake_name %in% names(lake_colors)[1:7]~"Wyoming",
                                          lake_name %in% names(lake_colors)[8:11]~"California",
                                          lake_name %in% names(lake_colors)[12:14]~"Washington")) %>%
  group_by(trophic_level, state, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop') %>% 
  arrange(trophic_level, state, term) 


# make complete set of all combinations
complete_rows <- expand.grid(
  state=c("California","Washington","Wyoming"), 
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_state<-left_join(complete_rows, effect_summary_state, join_by(state,trophic_level,term)) %>% 
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect))

        


effect_summary_state$trophic_level<-factor(effect_summary_state$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))
effect_summary_state$state<-factor(effect_summary_state$state, levels=c("California","Washington","Wyoming"))


p3<-ggplot(effect_summary_state, aes(x = state, y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "State",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p4<-ggplot(effect_summary_state, aes(x = state, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "State",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  
```


#### total
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_total<- model_output %>% filter(p.value<0.06) %>%
  group_by(trophic_level, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop'
  ) %>% 
  arrange(trophic_level, term) 
  
# make complete set of all combinations
complete_rows <- expand.grid(
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_total<-left_join(complete_rows, effect_summary_total, join_by(trophic_level,term)) %>%
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect)) %>% mutate(total="Total")

        
      

effect_summary_total$trophic_level<-factor(effect_summary_total$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))


p5<-ggplot(effect_summary_total, aes(x=total,y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x="Total",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p6<-ggplot(effect_summary_total, aes(x=total, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x="Total",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  


t1<-ggplot(effect_summary_total, aes(x = term, y = mean_abs_effect)) +
  geom_col(position = "dodge") +
        facet_wrap2(~trophic_level, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(trophic_level = c(
      "phytoplankton" = "Phytoplankton",
      "heterotrophic protists" = "Heterotrophic protists",
      "zooplankton" = "Zooplankton")))+
  labs(
    x = "",
    y = "Mean absolute effect")+
        scale_x_discrete(labels = c(
    "mean_air_temp_degC_interval" = "Temperature",
    "d15N_diff_from_start" = "Nitrogen deposition",
    "fish_present_binary" = "Fish presence"))+
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) 

t2<-ggplot(effect_summary_total, aes(x = term, y = max_abs_effect)) +
  geom_col(position = "dodge") +
        facet_wrap2(~trophic_level, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(trophic_level = c(
      "phytoplankton" = "Phytoplankton",
      "heterotrophic protists" = "Heterotrophic protists",
      "zooplankton" = "Zooplankton")))+
  labs(
    x = "",
    y = "Max absolute effect")+
        scale_x_discrete(labels = c(
    "mean_air_temp_degC_interval" = "Temperature",
    "d15N_diff_from_start" = "Nitrogen deposition",
    "fish_present_binary" = "Fish presence"))+
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) 


```

combined figure
```{r}
(p1 | p3 | p5) + 
  plot_layout(guides = "collect", widths = c(3, 2, 1.75)) + 
  plot_annotation(tag_levels = 'A')


ggsave("3_Figures/FigX_gls_V7_max_lake_state_total.png", width =15, height = 5, dpi = 400)

(p2 | p4 | p6) + 
  plot_layout(guides = "collect", widths = c(3, 2, 1.75)) + 
  plot_annotation(tag_levels = 'A')


ggsave("3_Figures/FigX_gls_V7_mean_lake_state_total.png", width =15, height = 5, dpi = 400)




t1

ggsave("3_Figures/FigX_gls_V7_mean_trophic_level_total.png", width =4, height = 7, dpi = 400)

t2


ggsave("3_Figures/FigX_gls_V7_max_trophic_level_total.png", width =4, height = 7, dpi = 400)
```

### V9

```{r}
## PHYTOPLANKTON AND HETEROTROPHIC PROTISTS
# read in the functional assignment file remove ~4k taxa that assign to fungi
tax_fun<-read.csv("2_DataAnalysis/V9_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object
rm(tax_fun)


ps_V9_norm_phyto<-subset_taxa(ps_V9_norm_sub, trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs"))
# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_phyto %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.35) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Chlorophyta_X" ~ "Chlorophyta",
                                             subdivision=="Streptophyta_X" ~ "Streptophyta",
                                             TRUE~subdivision
                                             ))


all_trophic<-sub %>% rename(taxonomic_group=subdivision) %>% mutate(trophic_level="phytoplankton")

ps_V9_norm_hetero<-subset_taxa(ps_V9_norm_sub, !trophic_mode %in% c("phototrophs","phototrophs/mixotrophs","mixotrophs" )& !class %in% c("Arthropoda","Unassigned","Nematoda","Craniata","Tardigrada","Annelida","Gastrotricha","Platyhelminthes","Porifera","Mollusca","Metazoa_X","Cnidaria","Bryozoa")) 

# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_hetero %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.6) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$subdivision)

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Evosea_X" ~ "Evosea",
                                             subdivision=="Metazoa" ~ "Rotifera",
                                             TRUE~subdivision
                                             ))

all_trophic<-sub %>% rename(taxonomic_group=subdivision)%>% mutate(trophic_level="heterotrophic protists") %>% rbind(all_trophic,.)

# remove other taxonomic levels aside from taxonomic_group
all_trophic <- all_trophic %>% select(-c(domain,supergroup,division))

# ZOOPLANKTON
# read in taxonomy assigned in Ch. 2
tax_blast<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/ZooplanktonSedDNA/5_DataAnalysis/BLAST_zooplankton/Max_Bra/5_BLAST_V9_original_single_multiple.csv", row.names=1,na.strings="") %>% column_to_rownames(., var="qseqid") %>% 
   mutate(Genus_plus = replace_na(Genus_plus, "Unassigned")) %>% select(Kingdom,Genus_plus) %>% filter(Genus_plus %in% c("Hesperodiaptomus", "Holopedium", "Ceriodaphnia", "Daphnia", "Chydoridae", "Leptodiaptomus", "Bosmina", "Cyclopidae")) # don't include "Harpacticoida" because generally sediment dwelling copepods and we have low abundances anyway!
tax_blast <- as.matrix(tax_blast) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_blast) # replace taxonomy table in the phyloseq object
rm(tax_blast)

# congomerate right away to genus_plus
ps_V9_norm_zoop <- ps_V9_norm_sub %>% tax_glom(., taxrank = "Genus_plus")


# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_zoop %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(Genus_plus%in%c(
        sub %>% filter(Abundance > 0.4) %>% select(Genus_plus) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$Genus_plus)

sub <- sub %>% select(-Kingdom)

all_trophic<-sub %>% rename(taxonomic_group=Genus_plus) %>% mutate(trophic_level="zooplankton") %>% rbind(all_trophic,.)


# run gls over prism time frame and switch the sign for nitrogen deposition
gls_data <-all_trophic %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,taxonomic_group, mid_cm, fish, trophic_level) %>% arrange(trophic_level, taxonomic_group,lake_name,desc(mid_cm)) %>% group_by(lake_name, taxonomic_group) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start) %>% rename(abundance=Abundance)


model_output <- as_tibble(NULL)

for (l in unique(gls_data$lake_name)) {
  for (i in unique(gls_data$taxonomic_group)) {
    subset <- gls_data %>% filter(taxonomic_group == i & lake_name == l)
    if (subset$fish[1] == 0) {
      model <- try(gls(abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start,
                       data = subset, correlation = corAR1(form = ~ time_seq)), silent = TRUE)
    } else {
      model <- try(gls(abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary,
                       data = subset, correlation = corAR1(form = ~ time_seq)), silent = TRUE)
    }

    # if the model throws a singularity error (for series where the abundance is 0 the whole time), then put NAs
    if (inherits(model, "try-error")) {
      model_table <- tibble(
        term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary"),
        Value = NA_real_,
        Std.Error = NA_real_,
        t.value = NA_real_,
        taxonomic_group = i,
        lake_name = l,
        trophic_level = subset$trophic_level[1]
      )
    } else {
      model_summary <- summary(model)
      model_table <- as_tibble(coef(model_summary), rownames = "term")
      model_table <- model_table %>%
        mutate(taxonomic_group = i, lake_name = l, trophic_level = subset$trophic_level[1]) %>%
        setNames(make.names(names(.))) %>%
        filter(term != "(Intercept)")
    }
    model_output <- bind_rows(model_output, model_table)
  }}; rm(model, i, l, model_table, model_summary)
# relabel some names to lower case
model_output<-model_output %>% rename(estimate=Value, std.error=Std.Error)

# remove extra dataframes
rm(gls_data,subset,sub,ps_V9_norm_hetero,ps_V9_norm_phyto,ps_V9_norm_zoop,ps_V9_norm_sub,all_trophic)

```

#### by lake
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_lake <- model_output %>% filter(p.value<0.06) %>%
  group_by(trophic_level, lake_name, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop') %>% 
  arrange(trophic_level, lake_name, term) 
        
# make complete set of all combinations
complete_rows <- expand.grid(
  lake_name = names(lake_colors), # fishless lakes
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_lake<-left_join(complete_rows, effect_summary_lake, join_by(lake_name,trophic_level,term)) %>% 
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect))


effect_summary_lake$trophic_level<-factor(effect_summary_lake$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))
effect_summary_lake$lake_name<-factor(effect_summary_lake$lake_name, levels=names(lake_colors))

p1<-ggplot(effect_summary_lake, aes(x = lake_name, y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "Lake",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p2<-ggplot(effect_summary_lake, aes(x = lake_name, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "Lake",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

#### by state
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_state <- model_output %>% filter(p.value<0.06) %>%
        mutate(state=case_when(lake_name %in% names(lake_colors)[1:7]~"Wyoming",
                                          lake_name %in% names(lake_colors)[8:11]~"California",
                                          lake_name %in% names(lake_colors)[12:14]~"Washington")) %>%
  group_by(trophic_level, state, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop') %>% 
  arrange(trophic_level, state, term) 


# make complete set of all combinations
complete_rows <- expand.grid(
  state=c("California","Washington","Wyoming"), 
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_state<-left_join(complete_rows, effect_summary_state, join_by(state,trophic_level,term)) %>% 
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect))

        


effect_summary_state$trophic_level<-factor(effect_summary_state$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))
effect_summary_state$state<-factor(effect_summary_state$state, levels=c("California","Washington","Wyoming"))


p3<-ggplot(effect_summary_state, aes(x = state, y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "State",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p4<-ggplot(effect_summary_state, aes(x = state, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "State",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  
```


#### total
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_total<- model_output %>% filter(p.value<0.05) %>%
  group_by(trophic_level, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop'
  ) %>% 
  arrange(trophic_level, term) 
  
# make complete set of all combinations
complete_rows <- expand.grid(
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_total<-left_join(complete_rows, effect_summary_total, join_by(trophic_level,term)) %>%
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect)) %>% mutate(total="Total")

        
      

effect_summary_total$trophic_level<-factor(effect_summary_total$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))


p5<-ggplot(effect_summary_total, aes(x=total,y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x="Total",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p6<-ggplot(effect_summary_total, aes(x=total, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x="Total",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  


t1<-ggplot(effect_summary_total, aes(x = term, y = mean_abs_effect)) +
  geom_col(position = "dodge") +
        facet_wrap2(~trophic_level, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(trophic_level = c(
      "phytoplankton" = "Phytoplankton",
      "heterotrophic protists" = "Heterotrophic protists",
      "zooplankton" = "Zooplankton")))+
  labs(
    x = "",
    y = "Mean absolute effect")+
        scale_x_discrete(labels = c(
    "mean_air_temp_degC_interval" = "Temperature",
    "d15N_diff_from_start" = "Nitrogen deposition",
    "fish_present_binary" = "Fish presence"))+
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) 

t2<-ggplot(effect_summary_total, aes(x = term, y = max_abs_effect)) +
  geom_col(position = "dodge") +
        facet_wrap2(~trophic_level, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(trophic_level = c(
      "phytoplankton" = "Phytoplankton",
      "heterotrophic protists" = "Heterotrophic protists",
      "zooplankton" = "Zooplankton")))+
  labs(
    x = "",
    y = "Max absolute effect")+
        scale_x_discrete(labels = c(
    "mean_air_temp_degC_interval" = "Temperature",
    "d15N_diff_from_start" = "Nitrogen deposition",
    "fish_present_binary" = "Fish presence"))+
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) 


```

combined figure
```{r}
(p1 | p3 | p5) + 
  plot_layout(guides = "collect", widths = c(3, 2, 1.75)) + 
  plot_annotation(tag_levels = 'A')


ggsave("3_Figures/FigX_gls_V9_max_lake_state_total.png", width =15, height = 5, dpi = 400)

(p2 | p4 | p6) + 
  plot_layout(guides = "collect", widths = c(3, 2, 1.75)) + 
  plot_annotation(tag_levels = 'A')


ggsave("3_Figures/FigX_gls_V9_mean_lake_state_total.png", width =15, height = 5, dpi = 400)



t1

ggsave("3_Figures/FigX_gls_V9_mean_trophic_level_total.png", width =4, height =7, dpi = 400)

t2


ggsave("3_Figures/FigX_gls_V9_max_trophic_level_total.png", width =4, height = 7, dpi = 400)
```








Time series test
```{r}
# test<- sub %>% filter(lake_name=="Canyon" & subdivision=="Chlorophyta") %>% arrange(time_seq)
# y<-ts(test$Abundance,start=1, end=nrow(test),frequency = 1)
# 
# tseries::adf.test(y, k=4)
# TSA::acf(y,type="correlation",drop.lag.0=T)  # ACF plot
# TSA::acf(y,type="partial")  # PACF plot
# eacf(y,ar.max=7, ma.max=7) # EACF plot
# 
# fit<-forecast::auto.arima(y, seasonal=F, stationary=F, trace=T)
# pred<-fitted(fit)
# 
# plot(y); lines(c(time(y)), pred,lty=2,col="purple")
```



try zooplankton with less abundant genuses
plot relative abundances of the phototrophs to see who is driving change
plot the non phototrophs (other)


run functional assignment for V9

For manuscript: 
- need to mention could be feedbacks between community and d15N values





#TAKING OUT ROTIFERS


### b. level 2 - heterotrophic protists
#### i. NMDS
```{r}
# read in the functional assignment file remove ~4k taxa that assign to fungi
tax_fun<-read.csv("2_DataAnalysis/V9_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object
rm(tax_fun)
ps_V9_norm_sub<-subset_taxa(ps_V9_norm_sub, !trophic_mode %in% c("phototrophs","phototrophs/mixotrophs","mixotrophs" )& !class %in% c("Arthropoda","Unassigned","Nematoda","Craniata","Tardigrada","Annelida","Gastrotricha","Platyhelminthes","Porifera","Mollusca","Metazoa_X","Cnidaria","Bryozoa", "Rotifera")) 
# remove phototrophic/mixotrophic organisms and keep only Rotifers from the metazoan subdivision
```


```{r}
# NMDS plot
set.seed(613)
nmds <- ps_V9_norm_sub %>% ordinate(., method = "NMDS", distance="bray")

nmds_points <- as.data.frame(nmds$points)
nmds_points$sample_id<-rownames(nmds_points)
nmds_meta<-merge(nmds_points,metadata,by="sample_id")
rm(nmds_points)

nmds_meta <- nmds_meta %>%
        mutate(lake_color = lake_colors[lake_name])

# make the legend order match the lake_colors list
nmds_meta$lake_name <- factor(nmds_meta$lake_name, levels = names(lake_colors))


# add depth
nmds_meta$scaled_depth<-scale(nmds_meta$bottom_cm)
nmds_meta$scaled_depth<-(nmds_meta$scaled_depth+2.519536)

NMDS<-ggplot() +
  geom_point(data = nmds_meta, 
             aes(x = MDS2, y = MDS1, size = scaled_depth, color = lake_name), 
             shape = 16) +  
  scale_color_manual(values = lake_colors, name = "Lake") +  
  scale_size_continuous(name = "Scaled Depth", range = c(1, 5), guide = "none") + 
  labs(x = "NMDS2", y = "NMDS1") +  
  custom_theme() + 
        scale_x_reverse()+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 6)))  +
          annotate("text", x = min(nmds_meta$MDS2), y = max(nmds_meta$MDS1),
                   hjust=1,vjust=1,size = 5,
           label = paste("Stress =", round(nmds$stress, 3))) 

#ggsave("3_Figures/FigX_V9_heterotrophic_protists_NMDS_ESV.png", width = 7, height = 5, dpi = 400)
```




#### ii. select taxa
```{r}
taxa_colors<-c( "#E69F00" ,"#56B4E9" ,"#009E73", "#F0E442" ,"#0072B2" ,"#D55E00" ,"#CC79A7" ,"#999999")




# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_sub %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.6) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$subdivision)

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Evosea_X" ~ "Evosea",
                                             TRUE~subdivision
                                             ))
# add in d15N breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/d15N_breakpoints.csv", header=T,row.names=1), join_by(lake_name))

# add in temperature breakpoints
sub <- sub %>% left_join(read.csv("2_DataAnalysis/temperature_breakpoints.csv", header=T,row.names=1), join_by(lake_name))


# separate high and low d15N by the breakpoints
sub <- sub %>%  group_by(lake_name)%>% 
        mutate(d15N_category = case_when(bottom_cm <= d15N_breakpoint_bottom_cm ~"low",
                                        bottom_cm > d15N_breakpoint_bottom_cm ~"high")) %>% 
        ungroup()

# order lake names for plot
sub$lake_name <- factor(sub$lake_name, levels = names(lake_colors_2))

# label line type
sub <- sub %>%
  mutate(line_type = case_when(
    !is.na(d15N_breakpoint_date) ~ "N isotope breakpoint",
    !is.na(first_stocked_yr) ~ "Year fish first stocked",
    TRUE ~ NA_character_
  ))
```



#### iii. linear mixed effects models
```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,subdivision, mid_cm) %>%   
        arrange(lake_name,subdivision,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)


model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence"),
        term = factor(term, levels = c("Intercept","Mean annual air\ntemperature (deg C)","d15N", "Fish presence"))) %>% filter(!term=="Intercept")


p1<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

# ggsave("3_Figures/FigX_V9_heterotrophic_protists_top_LME.png",height=4, width=7, units="in")


write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_heterotrophic_protists_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```


with interactions - used this one
```{r}
# run mixed effects models over prism time frame and switch the sign for nitrogen deposition
lme_data <-sub %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,subdivision, mid_cm) %>%   
        arrange(lake_name,subdivision,desc(mid_cm)) %>% group_by(lake_name) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start)

# interactions
model_output<-as_tibble(NULL)
for(i in unique(lme_data$subdivision)){
        model <- lme(
                Abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary +  mean_air_temp_degC_interval*fish_present_binary,
                random = ~ 1 | lake_name,
                correlation = corAR1(form = ~ time_seq),
                data = lme_data %>% filter(subdivision == i))
# extract model estimates and put into a table for each iteration
      model_summary <- summary(model)
      model_table <- as_tibble(model_summary$tTable, rownames = "term") %>% setNames(make.names(names(.)))
      model_table <- model_table %>% mutate(taxa = i)
      model_output <- bind_rows(model_output, model_table) 
      } ; rm(model); rm(i); rm(model_table)
# no interaction of fish and nitrogen (d15N_diff_from_start*fish_present_binary)
# no interaction of climate and nitrogen (d15N_diff_from_start*mean_air_temp_degC_interval) 
# yes interaction of fish and climate (mean_air_temp_degC_interval*fish_present_binary) 



model_output<-model_output %>%
        mutate(pval0.5=case_when(p.value <= 0.05 ~ "Yes",
                                 p.value > 0.05 ~ "No")) %>% 
        mutate(term = case_when(term=="(Intercept)"~"Intercept",
                                term=="mean_air_temp_degC_interval"~"Mean annual air\ntemperature (deg C)",
                                term=="d15N_diff_from_start"~"d15N",
                                term=="fish_present_binary"~"Fish presence",
                                term=="mean_air_temp_degC_interval:fish_present_binary"~"Mean annual air\ntemperature (deg C) x\nfish presence")) %>% filter(!term=="Intercept")


LME<-ggplot(data = model_output, aes(x = Value, y = term, fill = taxa, color = pval0.5)) +
  geom_point(size = 4, shape = 21, stroke = 1.5) + 
  custom_theme()+         
  scale_fill_manual(values = taxa_colors) + 
  scale_color_manual(values = c(No="#00000000",Yes = "black")) + 
  labs(x = "Estimate", 
       y = "",
       fill = "Taxonomic group",
       color = expression(italic("P") <= 0.05)) +
        theme(strip.background = element_blank())+
        guides(fill = guide_legend(override.aes = list(color = NA)))+ 
  scale_y_discrete(labels = function(term) {
    ifelse(term == "d15N", expression(Delta*delta^15 * "N"), term) }) +
        geom_vline(aes(xintercept=0),color="black", linetype = "dashed",linewidth=0.75)

# ggsave("3_Figures/FigX_V9_heterotrophic_protists_top_LME.png",height=4, width=7, units="in")


#write.csv(as.data.frame(model_output), "2_DataAnalysis/V9_LME_heterotrophic_protists_model_output.csv")

sig_taxa<-model_output %>% filter(pval0.5=="Yes") %>% pull(taxa) %>% unique(.)
```


#### iv. relative abundance plot
```{r}
# add line thickness for significant taxa
sub <- sub %>%
  mutate(line_thickness = factor(ifelse(subdivision %in% sig_taxa, "Significant", "Non-significant")))

RA<-ggplot(data = sub, aes(x = date_mid_AD_combo, y = Abundance, color = subdivision)) +
  facet_wrap2(
    ~ lake_name, ncol = 2, strip.position = "top",
    strip = strip_themed(
      background_x = elem_list_rect(fill = lake_colors_2),
      text_x = elem_list_text(
        color = ifelse(names(lake_colors_2) %in% c("Lightning", "Scott", "Middle Gaylor", "Soldier"), "white", "black")))) +
  labs(x = "Date (Common Era)", y = "Relative abundance (proportion)", color = "Taxonomic group", linetype = "") +
  geom_line(aes(group = subdivision, linewidth=line_thickness)) +         
  custom_theme() + 
  geom_vline(
    data = sub %>% filter(!is.na(d15N_breakpoint_date)), 
    aes(xintercept = d15N_breakpoint_date, linetype = "N isotope breakpoint"), 
    color = "black", linewidth = 0.75
  ) +
  geom_vline(
    data = sub %>% filter(!is.na(first_stocked_yr)), 
    aes(xintercept = first_stocked_yr, linetype = "Year fish first stocked"), 
    color = "black", linewidth = 0.75
  ) +
        geom_vline(
    data = sub %>% filter(!is.na(temperature_breakpoint_date)), 
    aes(xintercept = temperature_breakpoint_date, linetype = "Temperature breakpoint"), 
    color = "black", linewidth = 0.75
  )+
  scale_color_manual(values = taxa_colors) +
 scale_linetype_manual(
    values = c("N isotope breakpoint" = "dotted", "Year fish first stocked" = "solid", "Temperature breakpoint" = "dashed"),
    breaks = c("N isotope breakpoint", "Year fish first stocked", "Temperature breakpoint") # Specify order here
  )+
          guides(
    linetype = guide_legend(
      keyheight = 2))+
  scale_linewidth_manual(
    values = c("Non-significant" = 0.5, "Significant" = 1.3))
 

#ggsave("3_Figures/FigX_V9_heterotrophic_protists_top_relative_abundance.png",height=10, width=10, units="in")

```


#### v. plot all together
```{r}

(RA|(NMDS/LME)) + plot_layout(widths = c(1.5, 1))

ggsave("3_Figures/FigX_V9_heterotrophic_protist_no_rotifera_NMDS_RelAbun_LME.png",height=10, width=20, units="in")

```



# GLS for each lake and summarized

```{r}
## PHYTOPLANKTON AND HETEROTROPHIC PROTISTS
# read in the functional assignment file remove ~4k taxa that assign to fungi
tax_fun<-read.csv("2_DataAnalysis/V9_Taxonomy_Function.csv", header=T, row.names=1) %>% column_to_rownames(.,var="asv_code") %>%  mutate(trophic_mode = replace_na(trophic_mode, "unknown")) %>% filter(!subdivision=="Fungi")
tax_fun <- as.matrix(tax_fun) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_fun) # replace taxonomy table in the phyloseq object
rm(tax_fun)


ps_V9_norm_phyto<-subset_taxa(ps_V9_norm_sub, trophic_mode %in%c("phototrophs","phototrophs/mixotrophs","mixotrophs"))
# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_phyto %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.35) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Chlorophyta_X" ~ "Chlorophyta",
                                             subdivision=="Streptophyta_X" ~ "Streptophyta",
                                             TRUE~subdivision
                                             ))


all_trophic<-sub %>% rename(taxonomic_group=subdivision) %>% mutate(trophic_level="phytoplankton")

ps_V9_norm_hetero<-subset_taxa(ps_V9_norm_sub, !trophic_mode %in% c("phototrophs","phototrophs/mixotrophs","mixotrophs" )& !class %in% c("Arthropoda","Unassigned","Nematoda","Craniata","Tardigrada","Annelida","Gastrotricha","Platyhelminthes","Porifera","Mollusca","Metazoa_X","Cnidaria","Bryozoa","Rotifera")) 

# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_hetero %>% tax_glom(.,taxrank="subdivision") %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(subdivision%in%c(
        sub %>% filter(Abundance > 0.6) %>% select(subdivision) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$subdivision)

# rename the groups so there isn't an _X
sub <- sub %>% mutate(subdivision= case_when(subdivision=="Evosea_X" ~ "Evosea",
                                             TRUE~subdivision
                                             ))

all_trophic<-sub %>% rename(taxonomic_group=subdivision)%>% mutate(trophic_level="heterotrophic protists") %>% rbind(all_trophic,.)

# remove other taxonomic levels aside from taxonomic_group
all_trophic <- all_trophic %>% select(-c(domain,supergroup,division))

# ZOOPLANKTON
# read in taxonomy assigned in Ch. 2
tax_blast<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/LakeSedDNA/Data/ZooplanktonSedDNA/5_DataAnalysis/BLAST_zooplankton/Max_Bra/5_BLAST_V9_original_single_multiple.csv", row.names=1,na.strings="") %>% column_to_rownames(., var="qseqid") %>% 
   mutate(Genus_plus = replace_na(Genus_plus, "Unassigned")) %>% select(Kingdom,Genus_plus) %>% filter(Genus_plus %in% c("Hesperodiaptomus", "Holopedium", "Ceriodaphnia", "Daphnia", "Chydoridae", "Leptodiaptomus", "Bosmina", "Cyclopidae")) # don't include "Harpacticoida" because generally sediment dwelling copepods and we have low abundances anyway!
tax_blast <- as.matrix(tax_blast) # convert to matrix
ps_V9_norm_sub<-ps_V9_norm
tax_table(ps_V9_norm_sub) <- tax_table(tax_blast) # replace taxonomy table in the phyloseq object
rm(tax_blast)

# congomerate right away to genus_plus
ps_V9_norm_zoop <- ps_V9_norm_sub %>% tax_glom(., taxrank = "Genus_plus")


# group by taxonomic rank and turn to relative abundance
sub <- ps_V9_norm_zoop %>% transform_sample_counts(., function(x) x / sum(x)) %>% psmelt(.)

# subset dataset by taxa with the highest abundance in each group
sub <- sub %>% filter(Genus_plus%in%c(
        sub %>% filter(Abundance > 0.4) %>% select(Genus_plus) %>% unique(.) %>% pull() # this is where you select the abundance
        ))

unique(sub$Genus_plus)

sub <- sub %>% select(-Kingdom)

all_trophic<-sub %>% rename(taxonomic_group=Genus_plus) %>% mutate(trophic_level="zooplankton") %>% rbind(all_trophic,.)


# run gls over prism time frame and switch the sign for nitrogen deposition
gls_data <-all_trophic %>% filter(is.na(mean_air_temp_degC_interval)==F & is.na(d15N_diff_from_start)==F) %>% select(Abundance,mean_air_temp_degC_interval,d15N_diff_from_start,fish_present_binary,lake_name,taxonomic_group, mid_cm, fish, trophic_level) %>% arrange(trophic_level, taxonomic_group,lake_name,desc(mid_cm)) %>% group_by(lake_name, taxonomic_group) %>% mutate(time_seq=row_number()) %>% ungroup() %>% mutate(d15N_diff_from_start=-d15N_diff_from_start) %>% rename(abundance=Abundance)


model_output <- as_tibble(NULL)

for (l in unique(gls_data$lake_name)) {
  for (i in unique(gls_data$taxonomic_group)) {
    subset <- gls_data %>% filter(taxonomic_group == i & lake_name == l)
    if (subset$fish[1] == 0) {
      model <- try(gls(abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start,
                       data = subset, correlation = corAR1(form = ~ time_seq)), silent = TRUE)
    } else {
      model <- try(gls(abundance ~ mean_air_temp_degC_interval + d15N_diff_from_start + fish_present_binary,
                       data = subset, correlation = corAR1(form = ~ time_seq)), silent = TRUE)
    }

    # if the model throws a singularity error (for series where the abundance is 0 the whole time), then put NAs
    if (inherits(model, "try-error")) {
      model_table <- tibble(
        term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary"),
        Value = NA_real_,
        Std.Error = NA_real_,
        t.value = NA_real_,
        taxonomic_group = i,
        lake_name = l,
        trophic_level = subset$trophic_level[1]
      )
    } else {
      model_summary <- summary(model)
      model_table <- as_tibble(coef(model_summary), rownames = "term")
      model_table <- model_table %>%
        mutate(taxonomic_group = i, lake_name = l, trophic_level = subset$trophic_level[1]) %>%
        setNames(make.names(names(.))) %>%
        filter(term != "(Intercept)")
    }
    model_output <- bind_rows(model_output, model_table)
  }}; rm(model, i, l, model_table, model_summary)
# relabel some names to lower case
model_output<-model_output %>% rename(estimate=Value, std.error=Std.Error)

# remove extra dataframes
rm(gls_data,subset,sub,ps_V9_norm_hetero,ps_V9_norm_phyto,ps_V9_norm_zoop,ps_V9_norm_sub,all_trophic)

```

#### by lake
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_lake <- model_output %>% filter(p.value<0.05) %>%
  group_by(trophic_level, lake_name, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop') %>% 
  arrange(trophic_level, lake_name, term) 
        
# make complete set of all combinations
complete_rows <- expand.grid(
  lake_name = names(lake_colors), # fishless lakes
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_lake<-left_join(complete_rows, effect_summary_lake, join_by(lake_name,trophic_level,term)) %>% 
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect))


effect_summary_lake$trophic_level<-factor(effect_summary_lake$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))
effect_summary_lake$lake_name<-factor(effect_summary_lake$lake_name, levels=names(lake_colors))

p1<-ggplot(effect_summary_lake, aes(x = lake_name, y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "Lake",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p2<-ggplot(effect_summary_lake, aes(x = lake_name, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "Lake",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

#### by state
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_state <- model_output %>% filter(p.value<0.05) %>%
        mutate(state=case_when(lake_name %in% names(lake_colors)[1:7]~"Wyoming",
                                          lake_name %in% names(lake_colors)[8:11]~"California",
                                          lake_name %in% names(lake_colors)[12:14]~"Washington")) %>%
  group_by(trophic_level, state, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = mean(abs(estimate), na.rm=T),
    .groups = 'drop') %>% 
  arrange(trophic_level, state, term) 


# make complete set of all combinations
complete_rows <- expand.grid(
  state=c("California","Washington","Wyoming"), 
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_state<-left_join(complete_rows, effect_summary_state, join_by(state,trophic_level,term)) %>% 
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect))

        


effect_summary_state$trophic_level<-factor(effect_summary_state$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))
effect_summary_state$state<-factor(effect_summary_state$state, levels=c("California","Washington","Wyoming"))


p3<-ggplot(effect_summary_state, aes(x = state, y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "State",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p4<-ggplot(effect_summary_state, aes(x = state, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x = "State",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  
```


#### total
```{r}
# Summarize mean effect for each term by taxonomic group and lake
effect_summary_total<- model_output %>% filter(p.value<0.05) %>%
  group_by(trophic_level, term) %>%
  summarize(
    max_abs_effect = max(abs(estimate), na.rm=T),
    mean_abs_effect = median(abs(estimate), na.rm=T),
    .groups = 'drop'
  ) %>% 
  arrange(trophic_level, term) 
  
# make complete set of all combinations
complete_rows <- expand.grid(
  trophic_level =c("phytoplankton", "heterotrophic protists", "zooplankton"),
  term = c("mean_air_temp_degC_interval", "d15N_diff_from_start", "fish_present_binary")
)

# left join to have all combinations for plotting (set NAs to 0)
effect_summary_total<-left_join(complete_rows, effect_summary_total, join_by(trophic_level,term)) %>%
        mutate(mean_abs_effect = if_else(is.na(mean_abs_effect), 0, mean_abs_effect),
               max_abs_effect = if_else(is.na(max_abs_effect), 0, max_abs_effect)) %>% mutate(total="Total")

        
      

effect_summary_total$trophic_level<-factor(effect_summary_total$trophic_level, levels=c("phytoplankton","heterotrophic protists","zooplankton"))


p5<-ggplot(effect_summary_total, aes(x=total,y = max_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x="Total",
    y = "Max absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

p6<-ggplot(effect_summary_total, aes(x=total, y = mean_abs_effect, fill = trophic_level)) +
  geom_col(position = "dodge") +
        facet_wrap2(~term, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(term = c(
      "mean_air_temp_degC_interval" = "Mean air temperature (C)",
      "d15N_diff_from_start" = "Change in nitrogen isotopes",
      "fish_present_binary" = "Fish presence")))+
  labs(
    x="Total",
    y = "Mean absolute effect",
    fill = "Trophic level") +
  scale_fill_manual(values=c("#009E73" ,"#56B4E9" ,"#D55E00")) + 
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  


t1<-ggplot(effect_summary_total, aes(x = term, y = mean_abs_effect)) +
  geom_col(position = "dodge") +
        facet_wrap2(~trophic_level, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(trophic_level = c(
      "phytoplankton" = "Phytoplankton",
      "heterotrophic protists" = "Heterotrophic protists",
      "zooplankton" = "Zooplankton")))+
  labs(
    x = "",
    y = "Mean absolute effect")+
        scale_x_discrete(labels = c(
    "mean_air_temp_degC_interval" = "Temperature",
    "d15N_diff_from_start" = "Nitrogen deposition",
    "fish_present_binary" = "Fish presence"))+
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) 

t2<-ggplot(effect_summary_total, aes(x = term, y = max_abs_effect)) +
  geom_col(position = "dodge") +
        facet_wrap2(~trophic_level, ncol=1, strip = strip_themed(background_x = elem_list_rect(fill = "white", color = NA)), labeller = labeller(trophic_level = c(
      "phytoplankton" = "Phytoplankton",
      "heterotrophic protists" = "Heterotrophic protists",
      "zooplankton" = "Zooplankton")))+
  labs(
    x = "",
    y = "Max absolute effect")+
        scale_x_discrete(labels = c(
    "mean_air_temp_degC_interval" = "Temperature",
    "d15N_diff_from_start" = "Nitrogen deposition",
    "fish_present_binary" = "Fish presence"))+
 custom_theme() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) 


```

combined figure
```{r}
(p1 | p3 | p5) + 
  plot_layout(guides = "collect", widths = c(3, 2, 1.75)) + 
  plot_annotation(tag_levels = 'A')


ggsave("3_Figures/FigX_gls_V9_max_lake_state_total_no_rotifer.png", width =15, height = 5, dpi = 400)

(p2 | p4 | p6) + 
  plot_layout(guides = "collect", widths = c(3, 2, 1.75)) + 
  plot_annotation(tag_levels = 'A')


ggsave("3_Figures/FigX_gls_V9_mean_lake_state_total_no_rotifer.png", width =15, height = 5, dpi = 400)



t1

ggsave("3_Figures/FigX_gls_V9_mean_trophic_level_total_no_rotifer.png", width =4, height =7, dpi = 400)

t2


ggsave("3_Figures/FigX_gls_V9_max_trophic_level_total_no_rotifer.png", width =4, height = 7, dpi = 400)
```


